<!DOCTYPE html>
<html lang="en">

<head>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>chat.html</title>

    <style>
        html {
            --transparent: #ffffff00;
            /* Fonts */
                --fonts-sans-main: 'Roboto', 'Helvetica', sans-serif;
                --fonts-mono-main: 'Menlo', 'Monaco', 'Courier New', monospace;
                --fonts-sans-alt: 'Roboto', 'Helvetica', sans-serif;
                --fonts-mono-alt: 'Courier New', monospace;
                --font-size-main: 14px;
            /* Role Colors */
                /* User: blue */
                --color-roles-user-main: #00f;
                /* Assistant: purple */
                --color-roles-asst-main: #b0b;
                /* System: red */
                --color-roles-syst-main: #f00;
                /* Comment: gray */
                --color-roles-comm-main: #777;
                /* Tool: yellow */
                --color-roles-tool-main: #ff0;
                /* Parameter: green */
                --color-roles-para-main: #0f0;

                --shadow-alpha: 0.25;
                --accent-alpha: 0.0625;
                --foreground-axis: #000000;
                --background-axis: #ffffff;
                --heavy-blend-ratio: 30%;
                --light-blend-ratio: 95%;

            /* Interface Colors */
                --color-main-bg: #ffffff;
                --color-semantic-bad: #f00;
                --color-semantic-good: #0f0;
                --color-semantic-info: #00f;
                --color-semantic-highlight: #ff0;

            /* Derived Colors */
                --color-text-error-main: var(--color-semantic-bad);
                --color-text-success-main: var(--color-semantic-good);
                --color-saves-delete-main: color-mix(in srgb, var(--color-semantic-bad), var(--foreground-axis) 25% );
                --color-saves-save-main: color-mix(in srgb, var(--color-semantic-good), var(--foreground-axis) 25% );
                --color-saves-load-main: color-mix(in srgb, var(--color-semantic-info), var(--foreground-axis) 25% );
                --color-saves-title-main: color-mix(in srgb, var(--color-semantic-highlight), var(--foreground-axis) 25% );
                --color-vars-block-bg: color-mix(in srgb, var(--background-axis), var(--foreground-axis) 93.75% );
                --color-vars-local-main: var(--color-semantic-info);
                --color-vars-local-border: color-mix(in srgb, var(--color-semantic-info), var(--background-axis) 87.5% );
                --color-vars-global-main: var(--color-semantic-good);
                --color-vars-global-border: color-mix(in srgb, var(--color-semantic-good), var(--background-axis) 87.5% );
                --color-vars-delete-main: var(--color-semantic-bad);
                --color-vars-inline-main: color-mix(in srgb, var(--color-semantic-bad), var(--foreground-axis) 50% );
                --color-vars-inline-bg: color-mix(in srgb, var(--color-semantic-bad), var(--background-axis) 93.75% );
                --color-scroll-main: var(--foreground-axis);
                --color-main-border-heavy: var(--foreground-axis);
                --color-sidebar-border: var(--background-axis);
                --color-container-shadow: color-mix(in srgb, var(--foreground-axis), var(--background-axis) 87.5% );
                --color-section-inline: color-mix(in srgb, var(--foreground-axis), var(--background-axis) 87.5% );
                --color-text-hard: color-mix(in srgb, var(--foreground-axis), var(--background-axis) 6.25% );
                --color-text-soft: color-mix(in srgb, var(--foreground-axis), var(--background-axis) 18.75% );
                --color-text-medium: color-mix(in srgb, var(--foreground-axis), var(--background-axis) 31.25% );
                --color-text-light: color-mix(in srgb, var(--foreground-axis), var(--background-axis) 56.25% );
                --color-text-header: color-mix(in srgb, var(--foreground-axis), var(--background-axis) 18.75% );
                --color-text-error-heavy: color-mix(in srgb, var(--color-text-error-main), var(--background-axis) 50% );
                --color-text-error-light: color-mix(in srgb, var(--color-text-error-main), var(--background-axis) 6.25% );
                --color-text-success-light: color-mix(in srgb, var(--color-text-success-main), var(--background-axis) 6.25% );
                --color-text-success-heavy: color-mix(in srgb, var(--color-text-success-main), var(--background-axis) 50% );
                --color-scroll-bg: color-mix(in srgb, var(--color-scroll-main), var(--background-axis) 50% );
                --color-scroll-shadow: color-mix(in srgb, var(--color-scroll-main), var(--background-axis) 75% );
                --color-main-border-faint: color-mix(in srgb, var(--color-main-border-heavy), var(--background-axis) 12.5% );
                --color-main-border-light: color-mix(in srgb, var(--color-main-border-heavy), var(--background-axis) 87.5% );
                --color-main-bg-light: color-mix(in srgb, var(--color-main-bg), var(--background-axis) 25% );
                --color-main-shadow-light: color-mix(in srgb, var(--color-main-bg), var(--background-axis) 56.25% );
                --color-saves-delete-heavy: color-mix(in srgb, var(--color-saves-delete-main), var(--background-axis) 50% );
                --color-saves-save-heavy: color-mix(in srgb, var(--color-saves-save-main), var(--background-axis) 50% );
                --color-saves-load-heavy: color-mix(in srgb, var(--color-saves-load-main), var(--background-axis) 50% );
                --color-saves-title-heavy: color-mix(in srgb, var(--color-saves-title-main), var(--background-axis) 50% );
                --color-vars-local-heavy: color-mix(in srgb, var(--color-vars-local-main), var(--background-axis) 12.5% );
                --color-vars-global-heavy: color-mix(in srgb, var(--color-vars-global-main), var(--background-axis) 12.5% );
                --color-vars-delete-heavy: color-mix(in srgb, var(--color-vars-delete-main), var(--background-axis) 12.5% );
            /* Background */

                --background-filter: opacity(30%);
                --section-header-filter: saturate(800%) brightness(100%) contrast(98%) blur(0px);
                --section-header-filter-hover: saturate(500%) contrast(98%) blur(2px);
                --section-content-filter: saturate(200%) opacity(1);
                --variable-block-filter: saturate(250%) brightness(110%);
                --button-filter: saturate(250%) brightness(100%);
                --button-filter-hover: saturate(750%) brightness(100%);
                --compact-options-filter: saturate(750%) contrast(110%) brightness(110%);
        }
        html {
            --button-text-color-main: var(--color-text-hard);
            --button-text-bg-main: transparent;
        }
        html {
            font-family: var(--fonts-sans-main);
            font-size: var(--font-size-main);
        }
        input {
            font-size: 1em;
            background-color: var(--color-main-bg);
            color: var(--color-text-soft);
            overflow-x: clip;
            width: max-content;
            &.secret {
                width: 100%;
            }
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--color-main-border-light);
            background: var(--color-main-bg-light);
            border-radius: 4px;
            &[placeholder*="API"], &[placeholder*="http"] {
                display: inline-block;
            }
            &[type="checkbox"] {
                width: auto;
                margin-right: 5px;
            }
        }
        #middle-column :is(p, pre, ol, li, ul, h1, h2, h3, h4, h5, h6, dl, dt, dd) {
            margin: 0px;
            padding: 1px 0px 1px 0px;
            &:has(strong:first-child) {
                padding-top: 3px;
            }
        }
        #middle-column pre {
            margin: 2px 0px;
            padding: 2px 2px;
        }
        textarea {
            font-size: 1em;
            background-color: var(--color-main-bg);
            color: var(--color-text-soft);
            overflow-x: clip;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--color-main-border-light);
            background: var(--color-main-bg-light);
            border-radius: 4px;
        }
        select {
            font-size: 1em;
            background-color: var(--color-main-bg);
            color: var(--color-text-soft);
            overflow-x: clip;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--color-main-border-light);
            background: var(--color-main-bg-light);
            border-radius: 4px;
        }
        button {
            background-color: var(--button-bg-color-main);
            color: var(--button-text-color-main);
            border-color: var(--button-border-color-main, transparent);
            &:hover {
                border-color: var(--button-border-color-heavy, transparent);
                background-color: var(--button-bg-color-heavy);
                color: var(--button-text-color-heavy);
            }
        }
        button {
            font-size: 1em;
            overflow-x: clip;
            cursor: pointer;
            padding: 4px 8px;
            margin: 8px 4px 14px 4px;
            border: none;
            border-radius: 4px;
            transition: all 0.0s ease-in-out;
        }
        body {
            overflow-x: clip;
            background-color: var(--color-main-bg);
            font-size: var(--font-size-main);
            color: var(--color-text-hard);
            margin: 0;
            padding: 0px;
            padding-right: 10px;
            &.markdown-disabled {
                & .message-content, & .output {
                    white-space: pre-wrap;
                }
            }
        }
        #background-container, #background-container-2 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #background-container {
            background-color: var(--color-main-bg);
            background-image: var(--background-image);
            filter: var(--background-filter);
        }
        #background-container-2 {
            background-color: var(--background-color);
        }
        .container {
            background-color: var(--color-main-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--color-container-shadow);
            margin-bottom: 10px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            max-height: 20px;
            &.expanded {padding: 20px;}
        }
        #settings-toggle-L, #settings-toggle-R {
            cursor: pointer;
        }
        .column {
            flex: 1;
            margin-bottom: 10px;
        }
        h1, h2 {
            color: var(--color-text-header);
            font-weight: 400;
            font-size: 1.2em;
            margin-bottom: 10px;
            margin-top: 0;
        }
        h3 {
            margin: 0px;
        }
        .message-content {
            padding: 8px;
            margin-bottom: 10px;
            background: var(--role-color-light);
            border-radius: 4px;
            word-wrap: break-word;       /* Ensures long words don't overflow */
            word-break: break-word;      /* Allows breaking of long words */
            overflow-wrap: break-word;   /* Modern version of word-wrap */
            tab-size: 4;                 /* Standardizes tab width */
            -moz-tab-size: 4;            /* Firefox support */
        }
        #modelChatDescription, #modelTextDescription {
            font-size: 0.9em;
            font-family: var(--fonts-mono-main);
            width: fit-content;
        }
        .message-row {
            display: flex;
            flex-direction: row;
            margin-top: 4px;
            gap: 4px;
        }
        .message-row .message-block {
            --block-leftmost-side-width: 5px;
            --block-inner-side-width: 0px;
            max-height: 500px;
            overflow-y: scroll;
            &:has(.selected) {
                --block-inner-side-width: 2px;
            }
            &:first-child {
                border-left-width: var(--block-leftmost-side-width);
            }
            &:not(:last-child) {
                border-right-width: var(--block-inner-side-width);
            }
            &:not(:first-child) {
                border-left-width: var(--block-inner-side-width);
            }
        }
        .message-block, .output {
            --role-color-main: var(--role-color);
            --role-color-heavy: color-mix(in srgb, var(--role-color), var(--foreground-axis) var(--heavy-blend-ratio) );
            --role-color-light: color-mix(in srgb, var(--role-color), var(--background-axis) var(--light-blend-ratio) );
            --role-color-shadow: rgb(from var(--role-color) r g b / var(--shadow-alpha) );
            --role-color-accent: rgb(from var(--role-color) r g b / var(--accent-alpha) );
        }
        .message-block {
            margin-bottom: 0px;
            border-radius: 0px;
            border: 3px solid var(--color-main-border-heavy);
            border-top: 1px solid var(--color-main-border-heavy);
            border-color: var(--role-color-main);
            border-top-color: transparent;
            border-left-width: 2px;
            border-bottom-width: 0px;
            /* text-shadow: 0px 0px 2px var(--color-main-shadow-light), 0px 0px 1px var(--role-color-shadow); */
            display: flex;
            flex-direction: column;
            position: relative;
            flex: 1 1 auto;
            overflow-x: clip;
            padding: 0px 0px 0px 0px; /* ccw from top */
            transition: all 0.1s ease-in-out;
            z-index: 5;
            & div[contenteditable="true"] {
                outline: none;
            }
            &:has(.editing) {
                box-shadow: 0px 0px 0px var(--role-color-shadow);
                border-top-color: var(--role-color-main);
                color: var(--role-color-heavy);
            }
            &:has(.condensed) {
                max-height: 144px;
                font-size: 0.95em;
                line-height: 1em;
                overflow-y: scroll;
                scrollbar-gutter: stable;
                scrollbar-color: var(--color-scroll-main) var(--color-main-bg-light);
                & ::-webkit-scrollbar {
                    -webkit-appearance: none;
                    width: 7px;
                }
                & ::-webkit-scrollbar-thumb {
                    border-radius: 2px;
                    background-color: var(--color-scroll-main);
                    box-shadow: 0 0 1px var(--color-scroll-shadow);
                }
            }
            &:has(.condensed:not(.editing)) .message-content{
                background-image: linear-gradient(180deg, var(--transparent) 0%, var(--role-color-light) 60%, var(--role-color-accent) 100%)
            }
            &:has(:is(.selected, .collapsed):not(.editing)) {
                box-shadow: 0px 0px 0px var(--role-color-main);
                background-color: var(--role-color-light);
                border-top-color: var(--role-color-main);
                border-top-style: solid;
                border-top-width: 1px;
                & .message-control {
                    border-top: 1px solid var(--role-color-main);
                    border-bottom: 1px solid var(--role-color-shadow);
                    background-color: var(--role-color-accent);
                    z-index: 100;
                    padding: 1px 8px 0px 8px;
                    margin: -1px 0px 0px -3px;
                }
            }
            &:has(.collapsed:not(.editing)) {
                & .message-content {
                    display: none;
                }
                & .message-control {
                    margin-top: 0px;
                    margin-bottom: -1px;
                    border-top: none;
                    border-bottom: none;
                }
            }
            &:has(.disabled) {opacity: 0.6;}
            &:has(.collapsed.disabled) {opacity: 0.3;}
            &:focus {border-width: 3px;}
            &:hover {
                z-index: 10;
                transition: all 0.0s ease-in-out;
                border-top-color: var(--role-color-main);
                border-bottom-color: var(--role-color-main);
                &:not(:has(.selected)) {
                    border-bottom-width: 1px;
                }
                &[role="comment"] {
                    /* padding-left: calc(2em - 2px); */
                    opacity: 0.8;
                }
                & .message-control {
                    border-bottom-color: var(--role-color-main);
                }
            }
            &:has(.message-content[role="user"]) {
                --role-color: var(--color-roles-user-main);
            }
            &:has(.message-content[role="assistant"]) {
                --role-color: var(--color-roles-asst-main);
            }
            &:has(.message-content[role="system"]) {
                --role-color: var(--color-roles-syst-main);
            }
            &:has(.message-content[role="comment"]) {
                --role-color: var(--color-roles-comm-main);
                font-size: 0.95em;
                opacity: 0.6;
                background-color: var(--transparent);
                &.editing {
                    opacity: 1.0;
                    /* border-color: var(--role-color-heavy); */
                    /* box-shadow: 0px 0px 4px var(--role-color-main); */
                }
            }
        }
        .message-block .selected {
            z-index: 20;
            border-bottom: 1px solid var(--role-color-main);
            &:not(:is(.editing, .disabled)) {
                opacity: 1.0;
            }
        }
        .message-block.editing {
            &:has(.message-content[role="comment"]) {
                opacity: 1.0;
                /* border-color: var(--role-color-heavy); */
                box-shadow: 0px 0px 0px var(--role-color-main);
            }
        }
        .message-content {
            flex: 1;
            /* white-space: break-spaces; */
            overflow-x: clip;
            overflow-y: scroll;
            margin-bottom: 0px;
            padding: 4px 8px 4px 8px;
            border-radius: 0px;
            border-left: none;
            outline: none;
            &.disabled {opacity: 0.5;}
        }
        #middle-column .message-content, #outputs .output {
            & h1 {
                font-size: 1.5em;
                font-weight: 600;
                margin-top: 6px;
                margin-bottom: 6px;
                &:first-child {
                    margin-top: 3px;
                }
            }
            & h2 {
                font-size: 1.3em;
                margin-top: 4px;
                margin-bottom: 4px;
                &:first-child {
                    margin-top: 2px;
                }
            }
            & h3 {
                font-size: 1.2em;
                margin-top: 3px;
                margin-bottom: 3px;
                &:first-child {
                    margin-top: 2px;
                }
            }
            & .katex-display {
                margin-top: -4px;
                margin-bottom: -4px;
            }
            & li {
                margin-left: 1em;
            }
        }
        .message-control {
            width: auto;
            font-size: 0.9em;
            margin: -1px 0px -4px -3px;
            padding: 0px 8px 1px 8px;
            background-color: var(--role-color-accent);
        }
        .message-control button {
            background: none;
            border: none;
            color: var(--color-text-hard);
            align-self: center;
            padding: 0px;
            margin: 0px;
            position: relative;
            font-size: 1.0em;
            transition: all 0.0s ease-in-out;
            &.role-button {
                top: -2px;
            }
            &.role-button[data-role] {
                color: var(--role-color-main);
            }
        }
        .message-block:hover .message-control button {
            /* opacity: 1;
            text-shadow: 0px 0px 2px var(--role-color-light); */
        }
        .control-row {
            display: grid;
            grid-template-columns: min-content;
            height: 100%;
            width: 100%;
            justify-items: left;
        }
        .control-row-text-field {
            grid-row: 1;
            position: relative;
            align-self: center;
            color: var(--role-color-heavy);
            padding-left: 2em;
            padding-right: 2em;
            font-size: 1em;
            opacity: 0.5;
        }
        .author-info {
            grid-column-start: 2;
            grid-column-end: 2;
            &:empty::after {
                opacity: 0;
                content: "author";
            }
        }
        .label-info {
/*            display: contents;*/
            grid-column-start: 3;
            grid-column-end: 3;
            color: var(--role-color-heavy);
            opacity: 0.3;
            overflow-x: scroll;
            overflow-y: scroll;
            &:empty::after {
                opacity: 0;
                content: "label";
            }
        }
        .role-button {
            grid-row: 1;
            grid-column: 1;
        }
        .token-info {
            grid-row: 1;
            grid-column: 4;
            align-self: center;
            justify-self: end;
            color: var(--color-text-light);
            transition: opacity 0.2s ease;
            line-height: initial;
            margin-right: 12em;
        }
        .message-control button {
            &.move-up-button {
                margin-right: 10em;
            }
            &.move-down-button {
                margin-right: 8em;
            }
            &.collapse-button {
                margin-right: 6em;
            }
            &.condense-button {
                margin-right: 4em;
            }
            &.enable-button {
                margin-right: 2em;
            }
            &.delete-button {
                margin-right: 0em;
            }
            &.control-button {
                top: 0px;
                grid-row: 1;
                grid-column: 4;
                align-self: center;
                justify-self: end;
                color: var(--color-text-light);
            }
        }
        .message-block:has(.selected) {
            &:is(.token-info, .control-button) {
                color: var(--color-text-medium);
            }
            & .control-row-text-field {
                &:empty::after {
                    opacity: 0.5;
                    content: "...";
                }
            }
            & .author-info {
                &:empty::after {
                    content: "author";
                }
            }
            & .label-info {
                &:empty::after {
                    content: "label";
                }
            }
        }
        .control-row-text-field {
            scrollbar-width: none;
        }
        .tokens-disabled .token-info {
            opacity: 0; pointer-events: none;
        }
        .tokens-enabled .token-info {
            opacity: 1; pointer-events: auto;
        }

        .sidebar {
            background-color: transparent;
            padding: 0px;
            font-size: 1em;
            border-radius: 8px;
            & ul {
                list-style-type: none;
                margin-top: 0px;
                padding: 0;
            }
            & .collapsible-section {
                margin-bottom: 0px;
                li {
                    margin-bottom: 8px;
                    &:has(.secret, .key, .inline-input) {
                        &:not(:has(br)) {
                            display: flex;
                        }
                        & input {
                            font-family: var(--fonts-mono-main);
                        }
                        width: 100%;
                        align-items: baseline;
                        gap: 2px;
                    }
                }
                backdrop-filter: var(--section-content-filter);
                &.compact-lists {
                    li {
                        margin-bottom: 0px;
                    }
                }
                &.collapsed {
                    & .section-content {display: none;}
                    & .section-header {margin-bottom: 0px;}
                }
                &:not(.collapsed) {
                    border: 1px outset var(--color-sidebar-border);
                    & .section-header {
                        backdrop-filter: var(--section-header-filter);
                        border: 1px outset var(--color-sidebar-border);
                    }
                }
            }
            & h2 {
                font-size: 1.2em;
                cursor: pointer;
            }
            & input {
                background-color: var(--transparent);
                margin-bottom: 0px;
                font-size: 0.9em;
                padding: 2px;
                overflow-x: scroll;
            }
        }
        #left-sidebar {
            position: fixed;
            width: 20%;
            overflow-y: scroll;
            height: 100%;
            transition: width 0.3s ease-in-out;
        }

        #left-column.hidden {
            display: none;
        }

        #middle-column.full-width {
            width: 100%;
            margin-left: 0;
        }
        .section-header {
            &:hover {
                backdrop-filter: var(--section-header-filter-hover);
            }
            padding: 5px;
            border-radius: 0px;
            border: 1px outset var(--color-sidebar-border);
            transition: all 0.1s ease-in-out;
        }
        .section-content {
            padding: 10px;
            padding-top: 0px;
            border-radius: 0px;
        }
        .inline-input {
            width: auto;
/*            margin: auto;*/
            border: none;
            border-bottom: 1px solid var(--color-section-inline);
        }
        #otherParams {
            width: 100%;
            height: 1.5em;
        }
        #save-load-message {
            border: none;
            background-color: transparent;
            position: relative;
            font-family: var(--fonts-mono-main);
            opacity: 0.0;
            min-height: 1em;
            margin-left: auto;
            margin-right: auto;
            width: max-content;
            max-width: 100%;
            text-align: center;
            transition: all 1s ease-in;
            color: var(--color-text-success-main);
            pointer-events: none;
            &.save-message-error {
                color: var(--color-text-error-main);
                cursor: pointer;
            }
            &.active {
                transition: all 0.0s ease-out;
                opacity: 1.0;
                height: auto;
            }
        }
        .output {
            /* white-space: pre-wrap; */
            --role-color: var(--color-roles-asst-main);
            padding: 10px;
            border: 1px solid var(--role-color-main);
            position: relative;
            min-height: 1em;
            margin-top: 4px;
            margin-bottom: 40px;
            background-color: var(--role-color-light);
            overflow-y: scroll;
            border-left-width: 5px;
            border-right-width: 3px;
            /* border-radius: 8px; */
            transition: all 0.15s ease-in-out;
            &:not(.generating) {
                /* border: 2px solid var(--role-color-main);
                background-color: var(--role-color-light); */
            }
            &.generating {
                border-color: var(--role-color-shadow);
                background-color: var(--role-color-light);
                box-shadow: 0px 0px 10px var(--role-color-shadow), 0px 0px 2px var(--role-color-main);
            }
        }
        #button-container #stopCompletionBtn {
            color: var(--color-text-error-main);
            border-color: var(--color-text-error-main);
            background-color: rgb(from var(--color-text-error-light) r g b / 0.5 );
            &:hover {
                color: var(--color-text-hard);
                background-color: rgb(from var(--color-text-error-heavy) r g b / 0.5 );
            }
        }
        .provider-name {
            display: inline-block;
            white-space: nowrap;
        }
        .save-box {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            border-bottom: 1px solid var(--color-main-border-light);
            border-left: 1px solid var(--color-main-border-light);
            padding-left: 0.5em;
            border-radius: 0px;
            & button {
                flex: 1 1 auto;
                font-size: 1.0em;
                width: auto;
                padding: 2px 4px 2px 4px;
                margin: 0px 4px 0px 4px;
                display: grid;
                justify-items: right;
            }
            & .button-container {
                visibility: hidden;
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: flex-end;
                width: max-content;
            }
            &:hover .button-container, & .load-button {
                visibility: visible;
            }
            & input {
                padding: 2px;
                margin: 0px;
                font-size: 1em;
                width: 100%;
            }
            &:has(input) .button-container {display: none;}
            &:hover {
                border-bottom-color: var(--color-main-border-faint);
                transition: all 0.1s ease-in-out;
            }
            &:hover:not(:has(button:hover)) {
                background-color: var(--color-main-border-light);
            }
            &:has(button.title-button:hover) {
                background-color: rgb(from var(--color-saves-title-heavy) r g b/0.5);
            }
            &:has(button.save-button:hover) {
                background-color: rgb(from var(--color-saves-save-heavy) r g b/0.5);
            }
            &:has(button.load-button:hover) {
                background-color: rgb(from var(--color-saves-load-heavy) r g b/0.5);
            }
            &:has(button.delete-button:hover) {
                background-color: rgb(from var(--color-saves-delete-heavy) r g b/0.5);
            }
        }
        .save-box:has(button:hover) {

        }
        .save-box.immutable {
            color: var(--color-text-light);
            border-radius: 0px;
            font-variant: small-caps;
            margin-bottom: 5px;
            align-items: center;
            & button {
                position: absolute;
                margin-top: -0.8em;
            }
            & .save-name {flex-grow: 0;}
            & .button-container {
                display: flex;
                flex-direction: row;
                justify-content: flex-end;
                margin-top: 4px;
                width: auto;
            }
        }
        .save-name {
            font-size: 1em;
            transition: all 0.05s ease-in-out;
            align-self: center;
        }
        .save-box:not(.immutable) .save-name:hover {
            color: var(--color-text-light);
            padding: 2px;
            padding-bottom: 0px;
            outline: 1px solid var(--color-main-border-faint);
            border-radius: 5px;
            transition: all 0.1s ease-in-out;
        }
        #save-list {
            margin-top: 0em;
        }

        .variable-block {
            margin-bottom: 8px;
            padding: 0px;
            border-radius: 5px;
            border: 2px solid;
            backdrop-filter: var(--variable-block-filter);
            & input {
                width: 100%;
                margin: 0px 0;
                padding: 0px;
                border: none;
                font-family: var(--fonts-mono-main);
                margin-left: 4px;
                padding-left: 4px;
                background-color: transparent;
            }
            & button {
                flex: 1;
                padding: 0px 0;
                margin: 2px 0px 0px 0px;
                font-size: 0.9em;
                border: none;
                background-color: transparent;
                cursor: pointer;
                transition: background-color 0.15s;
            }
            & .button-container {
                display: flex;
                justify-content: space-between;
                margin-top: 5px;
            }
            &.global button {
                --button-bg-color-main: var(--color-vars-global-main);
                --button-bg-color-heavy: var(--color-vars-global-heavy);
                --button-border-color-main: var(--color-vars-global-border);
            }
            &.local button {
                --button-bg-color-main: var(--color-vars-local-main);
                --button-bg-color-heavy: var(--color-vars-local-heavy);
                --button-border-color-main: var(--color-vars-local-border);
            }
            &.inactive {
                opacity: 0.7;
            }
            & div span {
                padding-left: 4px; padding-right: 4px;
            }
        }
        button {
            &.load-button {
                --button-text-color-main: var(--color-saves-load-main);
                --button-text-color-heavy: var(--color-saves-load-heavy);
            }
            &.delete-button {
                --button-text-color-main: var(--color-vars-delete-main);
                --button-text-color-heavy: var(--color-vars-delete-heavy);
            }
            &.save-button {
                --button-text-color-main: var(--color-saves-save-main);
                --button-text-color-heavy: var(--color-saves-save-heavy);
            }
            &.title-button {
                --button-text-color-main: var(--color-saves-title-main);
                --button-text-color-heavy: var(--color-saves-title-heavy);
            }
            &.message-delete-button {
                --button-bg-color-main: var(--color-saves-delete-main);
                --button-bg-color-heavy: var(--color-saves-delete-heavy);
            }
            &.variable-delete-button {
                --button-bg-color-main: var(--color-vars-delete-main);
                --button-bg-color-heavy: var(--color-vars-delete-heavy);
            }
            &.variable-active-button {
                --button-bg-color-main: var(--color-vars-local-main);
                --button-bg-color-heavy: var(--color-vars-local-heavy);
            }
        }
        .inline-variable {
            color: var(--color-vars-inline-main);
            font-family: var(--fonts-mono-main);
            background-color: var(--color-vars-inline-bg);
            padding: 0 2px;
            font-size: 0.9em;
            border-radius: 2px;
        }
        #button-container {
            display: flex;
            position: relative;
            width: fit-content;
            flex-wrap: wrap;
            flex: 1 1 auto;
            margin-bottom: 0px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid gray;
            border-radius: 4px;
            /* margin-left: calc(40px + 2em); */
            gap: 8px;
            & button {
                font-size: 0.9em;
                transition: all 0.1s ease-in-out;
                backdrop-filter: var(--button-filter);
                border-radius: 4px;
                padding: 0px 8px;
                margin: 2px;
                font-family: var(--fonts-mono-main);
                &:hover {
                    font-weight: bold;
                    backdrop-filter: var(--button-filter-hover);
                }
            }
        }

        .compact-options {
            display: flex;
            flex-wrap: wrap;
            width: fit-content;
            justify-content: flex-start;
            gap: 1em;
            align-items: center;
            margin-top: 5px;
            margin-bottom: 5px;
            margin-left: auto;
            margin-right: auto;
            /* margin-left: calc(40px + 2em); */
            font-size: 1.0em;
            font-family: var(--fonts-mono-main);
            font-size: 0.95em;
            & select, input {
                padding: 2px;
                font-size: 1.0em;
                display: block;
                margin-bottom: inherit;
                backdrop-filter: var(--compact-options-filter);
                background-image: none;
                background-color: transparent;
                border: 2px solid var(--color-section-transparent);
                border-radius: 8px;
            }
            & select {width: fit-content;}
            & input {width: 6em;}
            &:has(.tokens-used) {
                justify-content: start;
            }
            & > span:is(.tokens-used, .chat-cost, text.-cost) {
                padding-left: 0px;
                padding-right: 24px;}
        }
        #main-container {
            display: flex;
            flex-direction: row;
            gap: 5px;
        }
        #left-column {
            flex: 2 0 15%;
            max-width: 20%;
            position: relative;
            height: 100%;
            overflow-y: scroll;
        }
        #middle-column {
            position: relative;
            width: 79%;
            margin-left: auto;
        }
        #right-column {
            flex: 1 1 15%;
            height: min-content;
            position: relative;
            background-color: var(--color-main-bg);
            border-radius: 8px;
            border: 1px solid var(--color-main-border-light);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            padding: 8px;
        }

        #versionHash, #shamelessSelfPromotion {
            color: var(--color-text-light);
            padding: 5px;
        }

        #hashOutput {
            font-weight: bold;
        }

        button[disabled] {
            opacity: 0.3;
            cursor: not-allowed;
        }

        option[disabled] {
            color: var(--color-text-light);
        }

        @media (max-width: 768px) {
            #main-container {
                flex-direction: column;
            }
            #left-column, #right-column {
                flex: 1 1 100%;
            }
            #left-column {
                font-size: 0.9em;
            }
        }
        pre {
            border: 2px inset var(--color-text-medium);
            border-radius: 4px;
            padding: 6px;
            background: #fffa;
            white-space: pre-wrap;
            color: #333;
            font-size: 0.9em;
        }
        p > code {
            border: 1px inset var(--color-text-light);
            background: var(--color-main-bg-light);
            border-radius: 4px;
            color: var(--color-text-soft);
            font-size: 0.95em;
            white-space: pre-wrap;
            position: relative;
            padding-top: 0px;
            padding-bottom: 0px;
            padding-left: 0.25em;
            padding-right: 0.25em;
            margin-top: -8px;
            margin-left: 0.1em;
            margin-right: 0.1em;
        }

        .format-controls {
            display: flex;
            gap: 5px;
            padding: 5px;
            background: var(--color-main-bg-light);
            border: 1px solid var(--color-main-border-light);
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;

            button {
                padding: 2px 6px;
                border: none;
                background: none;
                color: var(--color-text-medium);
                cursor: pointer;
                border-radius: 3px;

                &:hover {
                    background: var(--color-main-bg-heavy);
                    color: var(--color-text-heavy);
                }
            }
        }

        /* Keyboard shortcut hints */
        [data-shortcut]::after {
            content: attr(data-shortcut);
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: var(--color-text-light);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        [data-shortcut]:hover::after {
            opacity: 1;
        }

        /* Token count visualization */
        .token-info {
            position: relative;

            &::before {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                height: 2px;
                background: var(--role-color-main);
                width: calc(var(--token-percentage) * 100%);
                transition: width 0.3s ease;
            }
        }
        /*
            .hljs-params { color: green; }
            .hljs-built_in { color: darkorange; }
            .hljs_keyword { color: purple; }
            .hljs-type { color: purple; }
            .hljs-string { color: darkgreen; }
            .hljs-number { color: darkgreen; }
        */
        pre code.hljs {
            background: inherit !important;
            color: inherit !important;
        }
        .hljs {
            overflow-x: inherit !important;
            display: inherit !important;
            padding: inherit !important;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
            }
        }

        @media (prefers-color-scheme: dark) {
            mark {
                background-color: rgba(var(--color-highlight-rgb), 0.4);

                &:hover {
                    background-color: rgba(var(--color-highlight-rgb), 0.6);
                }
            }
        }
        body.theme-default, body.theme-1 {
            /* from https://doodad.dev/pattern-generator/ */
            --background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='100%25' width='100%25'%3E%3Cdefs%3E%3Cpattern id='doodad' width='80' height='80' viewBox='0 0 40 40' patternUnits='userSpaceOnUse' patternTransform='rotate(45)'%3E%3Crect width='100%25' height='100%25' fill='rgba(237, 240, 245,1)'/%3E%3Ccircle cx='35' cy='20' r='4' fill='rgba(226, 230, 240, 1)'/%3E%3Ccircle cx='5' cy='20' r='4' fill='rgba(226, 230, 240,1)'/%3E%3Ccircle cx='20' cy='35' r='4' fill='rgba(226, 232, 240,1)'/%3E%3Ccircle cx='20' cy='5' r='4' fill='rgba(226, 232, 240,1)'/%3E%3Ccircle cx='34' cy='6' r='4' fill='rgba(255, 255, 255,1)'/%3E%3Ccircle cx='6' cy='34' r='4' fill='rgba(255, 255, 255,1)'/%3E%3Ccircle cx='34' cy='34' r='4' fill='rgba(255, 255, 255,1)'/%3E%3Ccircle cx='6' cy='6' r='4' fill='rgba(255, 255, 255,1)'/%3E%3C/pattern%3E%3C/defs%3E%3Crect fill='url(%23doodad)' height='200%25' width='200%25'/%3E%3C/svg%3E ");
            --background-filter: opacity(30%);
            --background-color: var(--transparent);
            --color-roles-assistant-main: #b0b;
            --color-roles-user-main: #00f;
            --color-roles-syst-main: #f00;
        }
        body.theme-blossom, body.theme-2 {
            --background-image: url("https://img.freepik.com/premium-photo/watercolor-painting-pink-flowers-with-words-spring_1064589-26907.jpg");
            --background-filter: opacity(20%) blur(3px);
            --background-color: #d4e1ff00;
            --color-roles-asst-main: rgb(154, 0, 223);
            --color-roles-user-main: rgb(1, 94, 194);
            --color-roles-syst-main: rgb(202, 0, 0);

            & #background-container {
                background-position: bottom;
                background-size: 100%;
                background-repeat: space;
                opacity: 0.5;
            }
            & #background-container-2 {
                opacity: 0.05;
                background-image: linear-gradient(120deg, pink 0%, red 100%);
            }
        }
        body.theme-weeb, body.theme-3 {
            --background-image: url("https://w0.peakpx.com/wallpaper/165/954/HD-wallpaper-miku-n-kitty-hatsune-miku-animal-anime-anime-girl-vocaloids-long-hair-vocaloid-female-kitty-miku-twintails-cat-plain-cute-hatsune-kawaii-girl-simple-green-hair-kitten-white.jpg");
            --background-filter: opacity(40%) blur(1px);
            --background-color: #d4e1ff;
            --color-roles-asst-main: rgb(240, 71, 182);
            --color-roles-user-main: rgb(20, 189, 219);
            --color-roles-syst-main: rgb(218, 0, 0);
            & #background-container {
                background-position: bottom;
                background-size: 100%;
                background-repeat: space;
                opacity: 0.5;
            }
            & #background-container-2 {
                opacity: 0.1;
                background-image: linear-gradient(300deg, teal 0%, white 100%);
            }
        }
        body.theme-night, body.theme-4, html:has(body.theme-night), html:has(body.theme-4) {
            --background-image: url("https://e1.pxfuel.com/desktop-wallpaper/959/475/desktop-wallpaper-laptop-aesthetic-moon-laptop-aesthetic.jpg");
            --background-color: #d4e1ff00;
            --accent-alpha: 0.2;
            --foreground-axis: #fff;
            --background-axis: #222;
            --heavy-blend-ratio: 25%;
            --light-blend-ratio: 80%;
            --color-main-bg: #222;
            --color-roles-assistant-main: #b0b;
            --color-roles-user-main: #00f;
            --color-roles-syst-main: #f00;
            & #background-container {
                background-position: bottom;
                background-size: 100%;
                background-repeat: space;
                opacity: 0.5;
            }
            & #background-container-2 {
                opacity: 0.1;
            }
        }
    </style>
</head>

<body>
    <div id="background-container"></div>
    <div id="background-container-2"></div>
    <div id="main-container">
        <div id="left-column" class="sidebar">

            <div id="left-sidebar">

                <div class="collapsible-section">

                    <h2 class="section-header">Instructions</h2>
                    <div class="section-content">
                        <div><b>Navigating Cells</b></div>
                        <span>Uses a cell selection system akin to a Jupyter notebook.</span>
                        <ul>
                            <li>↑ / ↓, click: Change selected cell</li>
                            <li>Shift + ↑ / ↓: Move cell up/down</li>
                            <li>Alt + ↑ / ↓: Collapse/uncollapse cell</li>
                            <li>Enter, double-click: Edit cell</li>
                            <li>Escape, click outside: Stop editing cell</li>
                            <li>Space: Toggle cell as enabled/disabled (determines inclusion in chat completions)</li>
                            <li>Shift+space: Condense/uncondense large cell</li>
                            <li>Backspace: Delete cell</li>
                            <li>0-9: Quicksave to slot 0-9</li>
                            <li>Shift+0-9: Quickload from slot 0-9</li>
                            <li>Ctrl+0-9: Delete quicksave in slot 0-9</li>
                            <li>Ctrl-z: Undo last operation (usually doesn't work)</li>
                            <li>Tab: Show/hide this sidebar</li>
                        </ul>
                        <div><b>Adding and modifying roles</b></div>
                        <ul>
                            <li>a: Add assistant message</li>
                            <li>s: Add system message</li>
                            <li>d, u: Add user message</li>
                            <li>c: Add comment</li>
                            <li>f: Add last output as assistant message</li>
                            <li>Left, right, click on role: cycle message role</li>
                        </ul>
                        <div><b>Generating text</b></div>
                        <ul>
                            <li>\: Generate chat completion</li>
                            <li>|: Generate text completion</li>
                        </ul>
                        <div><b>Other functions</b></div>
                        <ul>
                            <li>
                                Certain text models (GPT-3.5-turbo, DeepSeek v3) offer <em>Fill-In-Middle</em> (FIM) support, which predicts the text that lies after a prompt and <em>before a suffix</em>. To use this, place the prompt and suffix in two consecutive cells, then select the first cell to enable the button.
                            </li>
                            <li>
                                Certain chat models (Claude 3.x, DeepSeek v3) allow you to <em>prefill</em> the assistant's response, or select a prefix that it must start with. To use this, put an <em>assistant block with the desired prefix</em> at the end of the chat before generating a chat completion.
                            </li>
                            <li>
                                Certain chat models, including many offered through OpenRouter, offer completions through their completions endpoint. The "Text w/ Chat Model" button allows you to <em>try</em> sending the <em>selected message</em> for a text completion with the given model. You can see a (likely-outdated) list of which models will respond appropriately <a href="https://gist.github.com/Mariven/b252720d77bb2d8cb99a1ce1fb2e2e91">here</a>.
                            </li>
                            <li>
                                If you don't want to see a certain provider's models in the model selector, set their API key to 'hide'. Doing this for Exa will hide the 'Similar Sites' and 'Exa Search' buttons.
                            </li>
                            <li>
                                Any instance of `{{url}}` in a message block, where `url` is a valid URL (e.g. `https://example.com`), will be silently replaced by the contents of that URL. Jina or Exa will be used to parse the contents if available and enabled in the settings, else its raw HTML will be fetched.
                            </li>
                            <li>
                                The max tokens boxes accept not just integers ('4096'), but also percentages ('20%') of the model's max output length; in addition, the arguments 'max', 'auto', and '' (the empty string) will be treated as '100%'.
                                <br>
                                Using something like 80% instead of 100% is a good idea, since <em>some</em> providers throw errors if your max_tokens + input length exceeds the model's context window.
                            </li>
                            <li>
                                Multiple message blocks can occupy the same row, and moved up or down together. They will be read in comic book order. Use shift+left and shift+right to move a block to the end of the previous row or start of the next row, or to move blocks within a row. If "generate completion in new block" is enabled, consecutive triggers will be placed in the same row.
                            </li>
                        </ul>
                        <div><b>Notes</b></div>
                        <ul>
                            <li>Don't use Ctrl-C + Ctrl-V to copy/paste, as this will pick up formatting. Use Ctrl-Shift-C and Ctrl-Shift-V instead. Or paste into your address bar to remove formatting and then copy from there.</li>
                        </ul>
                        <span style="opacity:0.5;">
                            feeling overwhelmed? click <span style="color: blue; text-decoration: underline; cursor: pointer;" onclick="this.parentElement.innerHTML = this.parentElement.innerHTML.replace(/click.*tutorial/, '<span style=\'color: red;\'>you should be <b>:)</b></span>')">here</span> for a visual tutorial
                        </span>
                    </div>
                </div>

                <div class="collapsible-section">

                    <h2 class="section-header">Keys</h2>
                    <div class="section-content">
                        <ul>
                            <li>
                                <span class="provider-name">OpenAI:</span>
                                <input type="text" class="secret key" id="openaiKey" placeholder="OpenAI API Key">
                            </li>
                            <li>
                                <span class="provider-name">OpenRouter:</span>
                                <input type="text" class="secret key" id="openrouterKey" placeholder="OpenRouter API Key">
                            </li>
                            <li>
                                <span class="provider-name">Fireworks:</span>
                                <input type="text" class="secret key" id="fireworksKey" placeholder="Fireworks API Key">
                            </li>
                            <li>
                                <span class="provider-name">Groq:</span>
                                <input type="text" class="secret key" id="groqKey" placeholder="Groq API Key">
                            </li>
                            <li>
                                <span class="provider-name">DeepSeek:</span>
                                <input type="text" class="secret key" id="deepseekKey" placeholder="DeepSeek API Key">
                            </li>
                            <li>
                                <span class="provider-name">Hyperbolic:</span>
                                <input type="text" class="secret key" id="hyperbolicKey" placeholder="Hyperbolic API Key">
                            </li>
                            <li>
                                <span class="provider-name">Mistral:</span>
                                <input type="text" class="secret key" id="mistralKey" placeholder="Mistral API Key">
                            </li>
                            <li>
                                <span class="provider-name">SambaNova:</span>
                                <input type="text" class="secret key" id="sambanovaKey" placeholder="SambaNova API Key">
                            </li>
                            <li>
                                <span class="provider-name">Jina.AI:</span>
                                <input type="text" class="secret key" id="jinaKey" placeholder="Jina AI API Key">
                            </li>
                            <li>
                                <span class="provider-name">Exa.AI:</span>
                                <input type="text" class="secret key" id="exaKey" placeholder="Exa API Key">
                            </li>
                            <li>
                                <span class="provider-name">TogetherAI:</span>
                                <input type="text" class="secret key" id="togetheraiKey" placeholder="TogetherAI API Key">
                            </li>
                            <li>
                                <span class="provider-name">Anthropic:</span>
                                <input type="text" class="secret key" id="anthropicKey" placeholder="Anthropic API Key">
                            </li>
                            <li>
                                <span class="provider-name">Gemini:</span>
                                <input type="text" class="secret key" id="geminiKey" placeholder="Gemini API Key">
                            </li>
                            <li>
                                <span class="provider-name">Cohere:</span>
                                <input type="text" class="secret key" id="cohereKey" placeholder="Cohere API Key">
                            </li>
                            <li>
                                <span class="provider-name">Cerebras:</span>
                                <input type="text" class="secret key" id="cerebrasKey" placeholder="Cerebras API Key">
                            </li>
                            <li style="display: none;">
                                <span class="provider-name">ModelBox:</span>
                                <input type="text" class="secret key" id="modelboxKey" placeholder="ModelBox API Key">
                            </li>
                            <li style="display: none;">
                                <span class="provider-name">Voyage:</span>
                                <input type="text" class="secret key" id="voyageKey" placeholder="Voyage API Key">
                            </li>
                            <li style="display: none;">
                                <span class="provider-name">Replicate:</span>
                                <input type="text" class="secret key" id="replicateKey" placeholder="Replicate API Key">
                            </li>
                            <li>
                                <span class="provider-name">xAI:</span>
                                <input type="text" class="secret key" id="xaiKey" placeholder="xAI API Key">
                            </li>
                            <li>
                                <span class="provider-name">Custom:</span>
                                <input type="text" class="secret key" id="customKey" placeholder="Custom API Key">
                            </li>
                            <li>
                                <span class="provider-name">Custom URL:</span>
                                <input type="text" class="secret" id="customUrl" placeholder="Custom API URL (https://provider.url/v1)">
                            </li>
                            <li>
                                <span class="provider-name">CORS Proxy:</span>
                                <input type="text" class="secret" id="corsProxy" placeholder="CORS Proxy URL (https://corsproxy.io/)">
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="collapsible-section compact-lists">

                    <h2 class="section-header">Main Settings</h2>
                    <div class="section-content">

                        <h3>LLM Settings</h3>
                        <ul>
                            <li>
                                <b>Stream</b>
                                <input class="option" type="checkbox" id="streaming" checked onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Temperature</b>
                                <input style="margin-left: 0.5em;" class="inline-input option" type="text" id="temperature" min="0.0" max="2.0" value="0.7" placeholder="0.0 to 2.0" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Top p</b>
                                <input style="margin-left: 0.5em;" class="inline-input option" type="text" id="top_p" min="0.0" max="1.0" value="1.0" placeholder="0.0 to 1.0" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Top k</b>
                                <input style="margin-left: 0.5em;" class="inline-input option" type="text" id="top_k" min="0" value="" placeholder = "10 to 40ish" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Frequency penalty</b>
                                <input style="margin-left: 0.5em;" class="inline-input option" type="text" id="frequency_penalty" value="" placeholder = "-2.0 to 2.0" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Presence penalty</b>
                                <input style="margin-left: 0.5em;" class="inline-input option" type="text" id="presence_penalty" value="" placeholder = "-2.0 to 2.0" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Repetition penalty</b>
                                <input style="margin-left: 0.5em;" class="inline-input option" type="text" id="repetition_penalty" placeholder = "-2.0 to 2.0" value="" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Seed</b>
                                <input style="margin-left: 0.5em;" class="inline-input option" type="text" id="seed" value="" placeholder = "any integer" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                (Parameters left blank will not be passed to the API)
                            </li>
                            <li>
                                <b>Other params</b> (enter as JSON)
                                <br>
                                <input class="option" type="text" id="otherParams" placeholder='{"stop": ["\n"]}' value="" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Custom Model Name</b>
                                <br>
                                <input class="option" type="text" id="customModel" placeholder="modelname" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                <b>Use Custom Model</b>
                                <input class="option" type="checkbox" id="useCustomModel" onchange="$inputs.saveAllOptions()">
                            </li>
                            <li>
                                Note: To use a custom model from a specific provider, select a model from the dropdown <em>belonging to that provider</em>. E.g. to use an OpenAI fine-tune, enter its name above (ft:whatever), check the box, and select an OpenAI model (say "GPT-4o (OAI)") from the dropdown.
                            </li>
                        </ul>
                        <h3>Tokenization</h3>
                            <ul>
                                <li>
                                    <input class="option" type="checkbox" id="jinaAllowTokenize" onchange="$inputs.saveAllOptions()">
                                    <label for="jinaAllowTokenize">
                                        <b>Get token counts via Jina</b>
                                    </label>
                                </li>
                                <li>Note: Enabling this option with a valid Jina API key will start sending your messages to Jina after you edit them.</li>
                                <li>Else, we approximate token count by dividing character count by 4 (accurate for typical English text, not so much for code or other languages)</li>
                            </ul>

                        <h3>Scraping</h3>
                            <ul>
                                <li>
                                    <input class="option" type="checkbox" id="scrapeAllowJina" onchange="$inputs.saveAllOptions()">
                                    <label for="scrapeAllowJina">
                                        <b>Get URL text via Jina</b>
                                    </label>
                                </li>
                                <li>
                                    <input class="option" type="checkbox" id="scrapeAllowExa" onchange="$inputs.saveAllOptions()">
                                    <label for="scrapeAllowExa">
                                        <b>Get URL text via Exa</b>
                                    </label>
                                </li>
                                <li>(if neither, gets raw HTML via fetch)</li>
                                <li>
                                    <input class="option" type="checkbox" id="scrapeIgnoreCache" onchange="$inputs.saveAllOptions()">
                                    <label for="scrapeIgnoreCache">
                                        <b>Don't cache URL contents</b>
                                    </label>
                                </li>
                                <li>
                                    <input class="option" type="checkbox" id="scrapeForceHTML" onchange="$inputs.saveAllOptions()">
                                    <label for="scrapeForceHTML">
                                        <b>Get URL as raw HTML, not text</b>
                                    </label>
                                </li>
                            </ul>

                        <h3>Auto-Summarization</h3>
                            <ul>
                                <li>
                                    <input class="option" type="checkbox" id="autoSummarizeNewSaves" onchange="$inputs.saveAllOptions()">
                                    <label for="autoSummarizeNewSaves">
                                        <b>Enable auto-summarization for new saves</b>
                                    </label>
                                </li>
                                <li>
                                    <input class="option" type="checkbox" id="autoSummarizeQuicksaves" onchange="$inputs.saveAllOptions()">
                                    <label for="autoSummarizeQuicksaves">
                                        <b>Enable auto-summarization for quicksaves</b>
                                    </label>
                                </li>
                                <li>
                                    <input class="option" type="checkbox" id="autoSummarizeLimit" onchange="$inputs.saveAllOptions()">
                                    <label for="autoSummarizeLimit">
                                        <b>Don't auto-summarize conversations over 100,000 characters</b>
                                    </label>
                                </li>
                                <li>
                                    <input class="option" type="radio" id="autoSummarizeGPT" name="autoSummarizeModel" onchange="$inputs.saveAllOptions()">
                                    <label for="autoSummarizeGPT">
                                        <b>Auto-summarize via GPT-4o Mini</b>
                                    </label>
                                </li>
                                <li>
                                    <input class="option" type="radio" id="autoSummarizeLlama3B" name="autoSummarizeModel" onchange="$inputs.saveAllOptions()">
                                    <label for="autoSummarizeLlama3B">
                                        <b>Auto-summarize via Llama 3.2 3B</b>
                                    </label>
                                </li>
                                <li>
                                    <input class="option" type="radio" id="autoSummarizeGemini" name="autoSummarizeModel" onchange="$inputs.saveAllOptions()">
                                    <label for="autoSummarizeGemini">
                                        <b>Auto-summarize via Gemini 1.5 Flash 8B</b>
                                    </label>
                                </li>
                            </ul>

                        <h3>Exa.AI Parameters</h3>
                            <div>
                                <label for="numSitesFind">
                                    <b>Find Similar Sites (Total Results):</b>
                                </label>
                                <input class="inline-input option" type="number" id="numSitesFind" value="3" style="width: 50px;" onchange="$inputs.saveAllOptions()">
                            </div>
                            <div>
                                <label for="numSitesSearch">
                                    <b>Exa Search (Total Results):</b>
                                </label>
                                <input class="inline-input option" type="number" id="numSitesSearch" value="5" style="width: 50px;" onchange="$inputs.saveAllOptions()">
                            </div>
                            <div>
                                <label for="numHighlightsSearch">
                                    <b>Highlights per result:</b>
                                </label>
                                <input class="inline-input option" type="number" id="numHighlightsSearch" value="3" style="width: 50px;" onchange="$inputs.saveAllOptions()">
                            </div>
                            <div>
                                <label for="numSentencesSearch">
                                    <b>Sentences per highlight:</b>
                                </label>
                                <input class="inline-input option" type="number" id="numSentencesSearch" value="2" style="width: 50px;" onchange="$inputs.saveAllOptions()">
                            </div>
                        <h3>Display Settings</h3>
                        <ul>
                            <li>
                                <input class="option" type="checkbox" id="generateInNewBlock" onchange="$inputs.saveAllOptions();">
                                <label for="generateInNewBlock">
                                    <b>Generate completion in new block</b>
                                </label>
                            </li>
                            <li style="display: none;">
                                <input class="option" type="checkbox" id="generateAtSelected" onchange="$inputs.saveAllOptions()">
                                <label for="generateAtSelected">
                                    <b>Generate at Selected</b>
                                </label>
                            </li>
                            <li>
                                <input class="option" type="checkbox" id="disableMarkdown" onchange="$inputs.saveAllOptions(); toggleMarkdown()">
                                <label for="disableMarkdown">
                                    <b>Disable Markdown rendering</b>
                                </label>
                            </li>
                            <li>
                                <input class="option" type="checkbox" id="hideSidebar" onchange="$inputs.saveAllOptions(); toggleSidebar()">
                                <label for="hideSidebar">
                                    <b>Hide sidebar by default</b>
                                </label>
                            </li>
                        </ul>
                        <h3>Appearance</h3>
                        <ul>
                            <li>
                                <label for="themeChoice">
                                    <b>Theme choice</b>
                                </label>
                                <select class="option" id="themeChoice" onchange="$inputs.saveAllOptions(); document.body.classList = [this.value];">
                                <optgroup label="Light">
                                    <option label="Theme 1 (Default)" value="theme-default" selected>
                                    <option label="Theme 2 (Blossom)" value="theme-blossom" selected>
                                    <option label="Theme 3 (Weeb)" value="theme-weeb" selected>
                                </optgroup>
                                <optgroup label="Dark">
                                    <option label="Theme 4 (Night)" value="theme-night" selected>
                                </optgroup>
                                </select>
                            </li>
                        </ul>
                    </div>
                </div>
<!--
                <div class="collapsible-section">
                    <h2 class="section-header">Sources</h2>
                    <div class="section-content">
                        <ul>
                            <li>
                                <textarea class="option" id="modelSources" onchange="$inputs.saveAllOptions()">
                                <label for="modelSources">
                                    Model and Provider Data (JSON)
                                </label>
                            </li>
                            <li>
                                A newline-separated list of URLs to JSON objects containing model and provider data.
                            </li>
                            <li>
                                Each JSON object should have the following pseudo-schema: <br>
                                <code>
                                    {
                                        "providerBaseURLs": {
                                            [provider]: [url],
                                            [provider]: [url],
                                            ...
                                        },
                                        "chat": {
                                            [model]: {
                                                "short": [model name],
                                                "provider": [provider],
                                                "cost": { "in": [input cost / 1M tokens], "out": [output cost / 1M tokens] },
                                                "max": { "in": [context window], "out": [max output tokens] }
                                            },
                                            ...
                                        },
                                        "text": {
                                            same as chat
                                        },
                                        ...
                                    }
                                </code>
                            </li>
                        </ul>
                    </div>
                </div> -->
                <div class="collapsible-section">

                    <h2 class="section-header">Variables</h2>
                    <div class="section-content" style="border-bottom:none;">
                        <b>How to use</b>
                        <ul>
                            <li>- (Substitution) If there is an active variable with key `key` and value `value`, any instance of the string `{{key}}` in a message will be silently replaced with the corresponding `value` prior to an API call.</li>
                            <li>- (Scoping) Local variables are stored per save (like messages), while global variables persist between saves (like API keys)</li>
                        </ul>
                    </div>
                    <div id="variables-menu" class="section-content">
                        <div id="variables-list"></div>
                        <button class="add-variable-button" onclick="addVariable()">
                            Add Variable
                        </button>
                    </div>
                </div>

                <div class="collapsible-section start-open">

                    <h2 class="section-header">Saved Data</h2>
                    <div id="save-menu" class="section-content">
                        <div id="save-list"></div>
                        <div style="display: flex; gap: 10px;">
                            <button class="save-new-button" onclick="createNewSave()">
                                Save New
                            </button>
                            <button onclick="exportAll()">
                                Export All
                            </button>
                            <input type="file" id="importFile" style="display: none;" onchange="importAll(this)">
                            <button onclick="document.getElementById('importFile').click()">
                                Import All
                            </button>
                        </div>
                        <div id="save-load-message">Local data loaded</div>
                    </div>
                </div>
                <div id="shamelessSelfPromotion">
                    <a href="https://n.cohomology.group/chat.html">chat.html</a> by <a href="https://n.cohomology.group">Mariven</a> (<a href="https://x.com/psychiel">@psychiel</a>)
                </div>
                <div id="versionHash">
                    Script hash:
                    <br>
                    <span id="hashOutput"></span>
                </div>
            </div>
        </div>

        <div id="middle-column">
            <div class="model-descriptions" style="display:flex;flex-direction:row;width:auto;font-size:1.0em;margin-bottom:1em;">
                <div id="modelChatBlock" style="width:50%;">
                    <div class="compact-options" style="margin-left:0px;">
                        <span>
                            Chat model:
                            <select class="option" id="modelChat" onchange="$inputs.saveAllOptions(); updateTokenCost()"></select>
                        </span>
                        <span>
                            Max tokens:
                            <input class="option" type="text" id="maxTokensChat" value="2048" size="4" onchange="$inputs.saveAllOptions(); updateTokenCost()">
                        </span>
                    </div>
                    <div id="modelChatDescription"></div>
                </div>
                <div id="modelTextBlock" style="width:50%;">
                    <div class="compact-options" style="margin-left:0px;">
                        <span>
                            Text model:
                            <select class="option" id="modelText" onchange="$inputs.saveAllOptions(); updateTokenCost()"></select>
                        </span>
                        <span>
                            Max tokens:
                            <input class="option" type="text" id="maxTokensText" value="128" size="4" onchange="$inputs.saveAllOptions(); updateTokenCost()">
                        </span>
                    </div>
                    <div id="modelTextDescription"></div>
                </div>
            </div>
            <div id="messages">
                <div class="message-block" style="display:none;">
                    <div class="message-control">
                        <!-- Control buttons will go here -->
                    </div>
                    <div class="message-content" role="user">
                        <!-- Message content goes here -->
                    </div>
                </div>
            </div>
            <div class="compact-options">
                <span class="tokens-used">
                    Tokens:
                    <span id="totalTokens"></span>
                </span>
                <span class="chat-cost">
                    Chat cost:
                    <span id="completionCost"></span>
                </span>
                <span class="text-cost">
                    Text cost:
                    <span id="textCompletionCost"></span>
                </span>
            </div>
            <div id="button-container">
                <button id="chatCompletionBtn" onclick="generate('chat')">
                    Chat Completion
                </button>
                <button id="textCompletionBtn" onclick="generate('text')">
                    Text Completion
                </button>
                <button id="chatCompletionsEndpointBtn" onclick="generate('textwchat')">
                    Text w/ Chat Model
                </button>
                <button id="findSimilarSitesBtn" onclick="findSimilarSites()">
                    Similar Sites
                </button>
                <button id="exaSearchBtn" onclick="exaSearch()">
                    Exa Search
                </button>
                <button onclick="clearOutput()">
                    Clear Output
                </button>
                <button onclick="addMessage('output')">
                    Append Output
                </button>
                <button onclick="deserializeState(immutableConversations['Ex: Basic assistant'].state)">
                    New Conversation
                </button>
                <button id="fimCompletionBtn" onclick="generate('fim')">
                    Fill In Middle
                </button>
                <button id="stopCompletionBtn" onclick="stopCompletion()" style="display: none;">
                    Stop
                </button>
                <button style="display:none;" onclick="resetToDefaults()">
                    Reset Parameters
                </button>
            </div>
            <div id="outputs">
                <div class="output"></div>
            </div>
        </div>
        <div id="right-column" style="display:none;">
        </div>
    </div>
<script>

/**                DATA OBJECTS                **/

    // see https://github.com/BerriAI/litellm/blob/main/model_prices_and_context_window.json for consistent updates
    const $models = {
            providerBaseURLs: {
                "Anthropic": "https://api.anthropic.com/v1",
                "Cerebras": "https://api.cerebras.ai/v1",
                "Custom": "",
                "DeepSeek": "https://api.deepseek.com/v1",
                "DeepSeek_Beta": "https://api.deepseek.com/beta",
                "Fireworks": "https://api.fireworks.ai/inference/v1",
                "Exa": "https://api.exa.ai/v1",
                "Gemini": "https://generativelanguage.googleapis.com/v1beta/openai",
                "Groq": "https://api.groq.com/openai/v1",
                "Hyperbolic": "https://api.hyperbolic.xyz/v1",
                "Mistral": "https://api.mistral.ai/v1",
                "Mistral_Text": "https://api.mistral.ai/v1",
                "ModelBox": "https://api.model.box/v1",
                "OpenAI": "https://api.openai.com/v1",
                "OpenRouter": "https://openrouter.ai/api/v1",
                "Replicate": "",
                "SambaNova": "https://api.sambanova.ai/v1",
                "TogetherAI": "https://api.together.xyz/v1",
                "Voyage": "",
                "xAI": "https://api.x.ai/v1",
                "none": ""
            },
            chat: {
                "openai/gpt-4o": {
                    short: "GPT-4o (OR)",
                    provider: "OpenRouter",
                    cost: { in: 5.0, out: 15.0 },
                    max: { in: 128000, out: 16384 }
                },
                "openai/o4-mini-high": {
                    short: "o4 Mini High (OR)",
                    provider: "OpenRouter",
                    cost: { in: 1.10, out: 4.40 },
                    max: { in: 200000, out: 100000 },
                    extra: ["developer"],
                },
                "openai/o3": {
                    short: "o3 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 10.0, out: 40.0 },
                    max: { in: 200000, out: 100000 },
                    extra: ["developer"],
                },
                "openai/o3-mini-high": {
                    short: "o3 Mini High (OR)",
                    provider: "OpenRouter",
                    cost: { in: 1.10, out: 4.40 },
                    max: { in: 200000, out: 100000 },
                    extra: ["developer"],
                },
                "openai/o1": {
                    short: "o1 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 15.00, out: 60.00 },
                    max: { in: 200000, out: 100000 },
                    extra: ["developer"],
                },
                "openai/gpt-4.5-preview": {
                    short: "GPT-4.5 Preview (OR)",
                    provider: "OpenRouter",
                    cost: { in: 75.00, out: 150.00 },
                    max: { in: 128000, out: 16384 },
                },
                "openai/gpt-4.1": {
                    short: "GPT-4.1 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 2.0, out: 8.0 },
                    max: { in: 1048576, out: 32768 }
                },
                "openai/gpt-4.1-mini": {
                    short: "GPT-4.1 Mini (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.40, out: 1.60 },
                    max: { in: 1048576, out: 32768 }
                },
                "openai/gpt-4.1-nano": {
                    short: "GPT-4.1 Nano (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.10, out: 0.40 },
                    max: { in: 1048576, out: 32768 }
                },
                "gpt-4.1": {
                    short: "GPT-4.1 (OAI)",
                    provider: "OpenAI",
                    cost: { in: 2.0, out: 8.0 },
                    max: { in: 1048576, out: 32768 }
                },
                "gpt-4.1-mini": {
                    short: "GPT-4.1 Mini (OAI)",
                    provider: "OpenAI",
                    cost: { in: 0.40, out: 1.60 },
                    max: { in: 1048576, out: 32768 }
                },
                "gpt-4.1-nano": {
                    short: "GPT-4.1 Nano (OAI)",
                    provider: "OpenAI",
                    cost: { in: 0.10, out: 0.40 },
                    max: { in: 1048576, out: 32768 }
                },
                "gpt-4o": {
                    short: "GPT-4o (OAI)",
                    provider: "OpenAI",
                    cost: { in: 5.0, out: 15.0 },
                    max: { in: 128000, out: 16384 }
                },
                "o4-mini": {
                    short: "o4 Mini (OAI)",
                    provider: "OpenAI",
                    cost: { in: 1.10, out: 4.40 },
                    max: { in: 200000, out: 100000 },
                    extra: ["developer"],
                },
                "o3": {
                    short: "o3 (OAI)",
                    provider: "OpenAI",
                    cost: { in: 10.0, out: 40.0 },
                    max: { in: 200000, out: 100000 },
                    extra: ["developer"],
                },
                "o3-mini": {
                    short: "o3-mini (OAI)",
                    provider: "OpenAI",
                    cost: { in: 1.10, out: 4.40 },
                    max: { in: 200000, out: 100000 },
                    params: ["reasoning_effort"],
                    extra: ["developer"],
                },
                "o1": {
                    short: "o1 (OAI)",
                    provider: "OpenAI",
                    cost: { in: 15.00, out: 60.00 },
                    max: { in: 200000, out: 100000 },
                    extra: ["developer"],
                },
                "claude-3-7-sonnet-latest": {
                    short: "Claude 3.7 Sonnet (Ant)",
                    provider: "Anthropic",
                    cost: { in: 3.0, out: 15.0 },
                    max: { in: 200000, out: 8192 },
                    extra: ["prefix", "thinking"], // enable thinking by putting `extra_body={"thinking":{"type":"enabled","budget_tokens":2000}}` in the payload
                },
                "claude-3-5-sonnet-latest": {
                    short: "Claude 3.5.1 Sonnet (Ant)",
                    provider: "Anthropic",
                    cost: { in: 3.0, out: 15.0 },
                    max: { in: 200000, out: 8192 },
                    extra: ["prefix"],
                },
                "claude-3-5-haiku-latest": {
                    short: "Claude 3.5 Haiku (Ant)",
                    provider: "Anthropic",
                    cost: { in: 0.80, out: 4.00 },
                    max: { in: 200000, out: 8192 },
                    extra: ["prefix"],
                },
                "anthropic/claude-3.7-sonnet": {
                    short: "Claude 3.7 Sonnet (OR)",
                    provider: "OpenRouter",
                    cost: { in: 3.0, out: 15.0 },
                    max: { in: 200000, out: 8192 },
                    extra: ["prefix", "thinking"],
                },
                "anthropic/claude-3.5-sonnet": {
                    short: "Claude 3.5.1 Sonnet (OR)",
                    provider: "OpenRouter",
                    cost: { in: 3.0, out: 15.0 },
                    max: { in: 200000, out: 8192 },
                    extra: ["prefix"],
                },
                "google/gemini-2.5-pro-preview-03-25": {
                    short: "Gemini 2.5 Pro 3-25 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 1.25, out: 10.00 },
                    max: { in: 1048576, out: 65536 }
                },
                "google/gemini-2.5-flash-preview": {
                    short: "Gemini 2.5 Flash Preview (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.15, out: 0.60 },
                    max: { in: 1048576, out: 65536 }
                },
                "google/gemini-2.5-flash-preview:thinking": {
                    short: "Gemini 2.5 Flash Preview (thinking) (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.15, out: 3.50 },
                    max: { in: 1048576, out: 65536 }
                },
                "gemini-2.5-pro-exp-03-25": {
                    short: "Gemini 2.5 Pro 3-25 (Gem)",
                    provider: "Gemini",
                    cost: { in: 0.0, out: 0.0 },
                    max: { in: 1048576, out: 8192 }
                },
                "gemini-2.5-flash-preview-04-17": {
                    short: "Gemini 2.5 Flash Preview (04-17) (Gem)",
                    provider: "Gemini",
                    cost: { in: 0.15, out: 0.60 },
                    max: { in: 1048576, out: 65536 }
                },
                "gemini-2.0-flash": {
                    short: "Gemini 2.0 Flash (Gem)",
                    provider: "Gemini",
                    cost: { in: 0.10, out: 0.40 },
                    max: { in: 1048576, out: 8192 }
                },
                "gemini-2.0-flash-lite-001": {
                    short: "Gemini 2.0 Flash Lite (Gem)",
                    provider: "Gemini",
                    cost: { in: 0.075, out: 0.30 },
                    max: { in: 1048576, out: 8192 }
                },
                "gemini-2.0-flash-thinking-exp": {
                    short: "Gemini 2.0 Flash Thinking Experimental (Gem)",
                    provider: "Gemini",
                    cost: { in: 0.0, out: 0.0 },
                    max: { in: 1048576, out: 8192 }
                },
                "gemini-2.0-pro-exp": {
                    short: "Gemini 2.0 Pro Experimental (Gem)",
                    provider: "Gemini",
                    cost: { in: 0.0, out: 0.0 },
                    max: { in: 2097152, out: 8192 }
                },
                "x-ai/grok-3-beta": {
                    short: "Grok 3 Beta (OR)",
                    provider: "OpenRouter",
                    cost: { in: 3.00, out: 15.00 },
                    max: { in: 131072, out: 131072 }
                },
                "x-ai/grok-3-mini-beta": {
                    short: "Grok 3 Mini Beta (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.30, out: 0.50 },
                    max: { in: 131072, out: 131072 }
                },
                "grok-2-1212": {
                    short: "Grok 2 12-12 (xAI)",
                    provider: "xAI",
                    cost: { in: 2.0, out: 10.0 },
                    max: { in: 131072, out: 8192 }
                },
                "cohere/command-r-plus-08-2024": {
                    short: "Cohere Command R+ 08-2024 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 2.5, out: 10.0 },
                    max: { in: 128000, out: 4000 }
                },
                "inception/mercury-coder-small-beta": {
                    short: "Mercury Coder Small Beta (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.25, out: 1.00 },
                    max: { in: 32000, out: 32000 }
                },
                "deepseek/deepseek-prover-v2": {
                    short: "DeepSeek Prover V2 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.70, out: 2.50 },
                    max: { in: 160000, out: 160000 }
                },
                "tngtech/deepseek-r1t-chimera:free": {
                    short: "DeepSeek R1T Chimera (Free) (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.00, out: 0.00 },
                    max: { in: 163480, out: 163480 }
                },
                "deepseek/deepseek-r1": {
                    short: "DeepSeek R1 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.55, out: 2.19 },
                    max: { in: 64000, out: 8000 },
                    extra: ["prefix"],
                },
                "deepseek-ai/DeepSeek-R1": {
                    short: "DeepSeek R1 (Hyp)",
                    provider: "Hyperbolic",
                    cost: { in: 2.00, out: 2.00 },
                    max: { in: 131072, out: 131072 },
                    extra: ["prefix"],
                },
                "deepseek-ai/DeepSeek-R1-Zero": {
                    short: "DeepSeek R1 Zero (Hyp)",
                    provider: "Hyperbolic",
                    cost: { in: 2.00, out: 2.00 },
                    max: { in: 131072, out: 131072 }
                },
                "deepseek/deepseek-chat": {
                    short: "DeepSeek V3 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.9, out: 0.9 },
                    max: { in: 128000, out: 128000 },
                    extra: ["prefix"],
                },
                "DeepSeek-V3-0324": {
                    short: "DeepSeek V3-0324 (SN)",
                    provider: "SambaNova",
                    cost: { in: 1.0, out: 1.5 },
                    max: { in: 8000, out: 4000 },
                    defaults: { temperature: 1.0, },
                },
                "deepseek-chat": {
                    short: "DeepSeek V3 (DS)",
                    provider: "DeepSeek_Beta",
                    cost: { in: 0.14, out: 0.28 },
                    max: { in: 64000, out: 8000 },
                    extra: ["prefix"],
                },
                "deepseek-reasoner": {
                    short: "DeepSeek R1 (DS)",
                    provider: "DeepSeek_Beta",
                    cost: { in: 0.55, out: 2.19 },
                    max: { in: 64000, out: 8000 },
                    extra: ["prefix", "reasoning_content"],
                },
                "DeepSeek-R1": {
                    short: "DeepSeek R1 (SN)",
                    provider: "SambaNova",
                    cost: { in: 5.0, out: 7.0 },
                    max: { in: 16000, out: 4000 },
                },
                "google/gemma-3-27b-it": {
                    short: "Gemma 3 27B Instruct (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.1, out: 0.2 },
                    max: { in: 131072, out: 8192 },
                },
                "mistralai/codestral-2501": {
                    short: "Codestral 2501 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.30, out: 0.90 },
                    max: { in: 256000, out: 256000 },
                },
                "microsoft/phi-4": {
                    short: "Phi 4 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.07, out: 0.14 },
                    max: { in: 16384, out: 16384 },
                },
                "accounts/fireworks/models/llama4-scout-instruct-basic": {
                    short: "Llama 4 Scout Instruct Basic (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.15, out: 0.6 },
                    max: { in: 128000, out: 16384 },
                },
                "accounts/fireworks/models/llama4-maverick-instruct-basic": {
                    short: "Llama 4 Maverick Instruct Basic (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.22, out: 0.88 },
                    max: { in: 1000000, out: 131072 },
                },
                "meta-llama/llama-3.1-405b-instruct": {
                    short: "Llama 3.1 405B Inst (OR)",
                    provider: "OpenRouter",
                    cost: { in: 1.79, out: 1.79 },
                    max: { in: 131072, out: 32000 },
                },
                "Meta-Llama-3.1-405B-Instruct": {
                    short: "Llama 3.1 405B Inst (SN)",
                    provider: "SambaNova",
                    cost: { in: 0.0, out: 0.0 },
                    max: { in: 8192, out: 8192 },
                },
                "meta-llama/Meta-Llama-3.1-405B-Instruct": {
                    short: "Llama 3.1 405B Inst (Hyp)",
                    provider: "Hyperbolic",
                    cost: { in: 4.0, out: 4.0 },
                    max: { in: 8192, out: 8192 },
                },
                "nousresearch/hermes-3-llama-3.1-405b": {
                    short: "Nous Hermes 3 Llama 3.1 405B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 4.5, out: 4.5 },
                    max: { in: 131072, out: 8192 },
                },
                "meta-llama/llama-3.2-90b-vision-instruct": {
                    short: "Llama 3.2V 90B Inst (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.9, out: 0.9 },
                    max: { in: 131072, out: 131072 },
                },
                "meta-llama/llama-3.3-70b-instruct": {
                    short: "Llama 3.3 70B Inst (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.4, out: 0.4 },
                    max: { in: 131072, out: 131072 },
                },
                "NousResearch/Hermes-3-Llama-3.1-70B": {
                    short: "Nous Hermes 3.1 70B (Hyp)",
                    provider: "Hyperbolic",
                    cost: { in: 0.4, out: 0.4 },
                    max: { in: 12288, out: 12288 },
                },
                "nvidia/llama-3.1-nemotron-70b-instruct": {
                    short: "Llama 3.1 70B Nemo Inst (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.35, out: 0.4 },
                    max: { in: 131072, out: 131072 },
                },
                "llama-3.1-70b-versatile": {
                    short: "Llama 3.1 70B (Groq)",
                    provider: "Groq",
                    cost: { in: 0.3, out: 0.3 },
                    max: { in: 131072, out: 4096 },
                },
                "sao10k/l3.1-euryale-70b": {
                    short: "Llama 3.1 Euryale 70B v2.2 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.35, out: 0.4 },
                    max: { in: 8192, out: 16000 },
                },
                "meta-llama/llama-3.2-11b-vision-instruct": {
                    short: "Llama 3.2V 11B Inst (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.2, out: 0.2 },
                    max: { in: 131072, out: 131072 },
                },
                "llama-3.1-8b-instant": {
                    short: "Llama 3.1 8B (Groq)",
                    provider: "Groq",
                    cost: { in: 0.055, out: 0.055 },
                    max: { in: 131072, out: 4096 },
                },
                "qwen/qwen3-235b-a22b": {
                    short: "Qwen3 235B A22B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.10, out: 2.00 },
                    max: { in: 32768, out: 32768 }
                },
                "qwen/qwen3-30b-a3b": {
                    short: "Qwen3 30B A3B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.10, out: 0.30 },
                    max: { in: 40960, out: 40960 }
                },
                "qwen/qwen3-32b": {
                    short: "Qwen3 32B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.10, out: 0.30 },
                    max: { in: 40960, out: 40960 }
                },
                "qwen/qwen3-14b": {
                    short: "Qwen3 14B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.07, out: 0.24 },
                    max: { in: 40960, out: 40960 }
                },
                "qwen/qwen3-8b": {
                    short: "Qwen3 8B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.035, out: 0.138 },
                    max: { in: 40960, out: 40960 }
                },
                "qwen/qvq-72b-preview": {
                    short: "Qwen QvQ 72B Preview (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.25, out: 0.5 },
                    max: { in: 128000, out: 4000 },
                },
                "qwen/qwq-32b": {
                    short: "Qwen QwQ 32B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.12, out: 0.18 },
                    max: { in: 131072, out: 131072 },
                },
                "qwen-qwq-32b": {
                    short: "Qwen QwQ 32B (Groq)",
                    provider: "Groq",
                    cost: { in: 0.29, out: 0.39 },
                    max: { in: 131072, out: 131072 },
                },
                "Qwen/QwQ-32B-Preview": {
                    short: "Qwen 2.5 QwQ 32B Preview (Hyp)",
                    provider: "Hyperbolic",
                    cost: { in: 0.2, out: 0.6 },
                    max: { in: 32768, out: 32768 },
                },
                "Qwen/Qwen2.5-Coder-32B-Instruct": {
                    short: "Qwen 2.5 Coder 32B (Hyp)",
                    provider: "Hyperbolic",
                    cost: { in: 0.6, out: 0.6 },
                    max: { in: 131072, out: 8192 },
                },
                "eva-unit-01/eva-qwen-2.5-72b": {
                    short: "Eva Qwen 2.5 72B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 4.0, out: 4.0 },
                    max: { in: 32000, out: 32000 },
                },
                "Qwen/Qwen2.5-72B-Instruct": {
                    short: "Qwen 2.5 72B Inst (Hyp)",
                    provider: "Hyperbolic",
                    cost: { in: 0.4, out: 0.4 },
                    max: { in: 32768, out: 32768 },
                },
                "qwen/qwen-2.5-7b-instruct": {
                    short: "Qwen 2.5 7B Inst (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.27, out: 0.27 },
                    max: { in: 131072, out: 32768 },
                },
                "gemini-1.5-pro-latest": {
                    short: "Gemini Pro 1.5",
                    provider: "Gemini",
                    cost: { in: 1.25, out: 5.0 },
                    max: { in: 2000000, out: 8192 },
                },
                "gemini-1.5-flash-latest": {
                    short: "Gemini Flash 1.5",
                    provider: "Gemini",
                    cost: { in: 0.0375, out: 0.075 },
                    max: { in: 1000000, out: 8192 },
                },
                "x-ai/grok-2": {
                    short: "Grok 2 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 5.0, out: 15.0 },
                    max: { in: 131072, out: 131072 },
                },
                "chatgpt-4o-latest": {
                    short: "ChatGPT-4o (OAI)",
                    provider: "OpenAI",
                    cost: { in: 5.0, out: 15.0 },
                    max: { in: 128000, out: 16384 },
                },
                "gpt-4o-mini": {
                    short: "GPT-4o Mini (OAI)",
                    provider: "OpenAI",
                    cost: { in: 0.15, out: 0.6 },
                    max: { in: 128000, out: 16384 },
                },
                "liquid/lfm-40b": {
                    short: "Liquid LFM 40B MoE (OR)",
                    provider: "OpenRouter",
                    cost: { in: 1.0, out: 2.0 },
                    max: { in: 32768, out: 32768 },
                },
                "mistralai/mistral-large": {
                    short: "Mistral Large 2 (OR)",
                    provider: "OpenRouter",
                    cost: { in: 2.0, out: 6.0 },
                    max: { in: 128000, out: 128000 },
                },
                "mistralai/codestral-mamba": {
                    short: "Codestral Mamba (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.25, out: 0.25 },
                    max: { in: 256000, out: 256000 },
                },
                "codestral-latest": {
                    short: "Codestral (Mistral)",
                    provider: "Mistral",
                    cost: { in: 1.0, out: 3.0 },
                    max: { in: 32000, out: 8191 },
                },
                "mistralai/mistral-nemo": {
                    short: "Mistral Nemo (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.13, out: 0.13 },
                    max: { in: 128000, out: 32768 },
                },
                "microsoft/wizardlm-2-8x22b": {
                    short: "WizardLM 2 8x22B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.5, out: 0.5 },
                    max: { in: 65536, out: 65536 },
                },
                "cognitivecomputations/dolphin-mixtral-8x22b": {
                    short: "Dolphin 2.9.2 Mixtral 8x22B (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.9, out: 0.9 },
                    max: { in: 65536, out: 16000 },
                },
                "anthropic/claude-3-opus": {
                    short: "Claude 3 Opus (OR)",
                    provider: "OpenRouter",
                    cost: { in: 15.0, out: 75.0 },
                    max: { in: 200000, out: 4096 },
                },
                "anthropic/claude-3-haiku": {
                    short: "Claude 3 Haiku (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.25, out: 1.25 },
                    max: { in: 200000, out: 4096 },
                },
                "echo": {short: "Echo input", provider: "none", cost: {in: 0, out: 0}, max: {in: -1, out: -1},},
                "none": {short: "No model", provider: "none", cost: {in: 0, out: 0}, max: {in: -1, out: -1},}
            },
            text: {
                "gpt-3.5-turbo-instruct": {
                    short: "GPT-3.5 Turbo Inst (OAI)",
                    provider: "OpenAI",
                    cost: { in: 1.5, out: 2.0 },
                    max: { in: 4095, out: 4096 },
                    extra: ["suffix"],
                },
                "deepseek/deepseek-v3-base:free": {
                    short: "DeepSeek V3 Base (free) (OR)",
                    provider: "OpenRouter",
                    cost: { in: 0.0, out: 0.0 },
                    max: { in: 131072, out: 131072 },
                    defaults: { temperature: 1.5, repetition_penalty: 0.5, presence_penalty: 0.5, frequency_penalty: 0.5 },
                },
                "davinci-002": {
                    short: "davinci-002 (OAI)",
                    provider: "OpenAI",
                    cost: { in: 2.0, out: 2.0 },
                    max: { in: 16835, out: 4096 },
                    extra: ["suffix"],
                },
                "babbage-002": {
                    short: "babbage-002 (OAI)",
                    provider: "OpenAI",
                    cost: { in: 0.4, out: 0.4 },
                    max: { in: 4095, out: 4096 },
                    extra: ["suffix"],
                },
                "accounts/fireworks/models/llama4-maverick-instruct-basic": {
                    short: "Llama 4 Maverick Instruct Basic (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.22, out: 0.88 },
                    max: { in: 1000000, out: 131072 },
                },
                "accounts/fireworks/models/llama4-scout-instruct-basic": {
                    short: "Llama 4 Scout Instruct Basic (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.15, out: 0.6 },
                    max: { in: 128000, out: 16384 },
                },
                "accounts/fireworks/models/deepseek-v3-0324": {
                    short: "DeepSeek V3-0324 (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.9, out: 0.9 },
                    max: { in: 160000, out: 160000 },
                    defaults: { temperature: 1.5, },
                },
                "accounts/fireworks/models/deepseek-v3": {
                    short: "DeepSeek V3 (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.9, out: 0.9 },
                    max: { in: 128000, out: 128000 },
                    defaults: { temperature: 1.5,  },
                },
                "accounts/fireworks/models/deepseek-r1": {
                    short: "DeepSeek R1 (FW)",
                    provider: "Fireworks",
                    cost: { in: 8.00, out: 8.00 },
                    max: { in: 20480, out: 20480 },
                },
                "deepseek-chat": {
                    short: "DeepSeek V3 (DS)",
                    provider: "DeepSeek_Beta",
                    cost: { in: 0.14, out: 0.28 },
                    max: { in: 64000, out: 8000 },
                    extra: ["suffix"],
                    defaults: { temperature: 1.5, },
                },
                "codestral-latest": {
                    short: "Codestral (Mistral)",
                    provider: "Mistral_Text",
                    cost: { in: 1.0, out: 3.0 },
                    max: { in: 32000, out: 8191 },
                    extra: ["suffix"],
                },
                "accounts/fireworks/models/qwen-qwq-32b-preview": {
                    short: "Qwen 2.5 QwQ 32B Preview (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.2, out: 0.6 },
                    max: {in: 32768, out: 32768 },
                },
                "accounts/fireworks/models/qwen2p5-coder-32b-instruct": {
                    short: "Qwen 2.5 Coder 32B (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.9, out: 0.9 },
                    max: {in: 32768, out: 32768 },
                },
                "accounts/fireworks/models/qwen2p5-72b-instruct": {
                    short: "Qwen 2.5 72B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.9, out: 0.9 },
                    max: {in: 32768, out: 32768 },
                },
                "accounts/fireworks/models/llama-v3p2-90b-vision-instruct": {
                    short: "Llama 3.2 90B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.9, out: 0.9 },
                    max: { in: 131072, out: 131072 },
                },
                "accounts/fireworks/models/llama-v3p2-11b-vision-instruct": {
                    short: "Llama 3.2 11B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.2, out: 0.2 },
                    max: { in: 131072, out: 131072 },
                },
                "accounts/fireworks/models/llama-v3p2-3b-instruct": {
                    short: "Llama 3.2 3B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.1, out: 0.1 },
                    max: { in: 131072, out: 131072 },
                },
                "accounts/fireworks/models/llama-v3p2-1b-instruct": {
                    short: "Llama 3.2 1B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.1, out: 0.1 },
                    max: { in: 131072, out: 131072 },
                },
                "meta-llama/Meta-Llama-3.1-405B": {
                    short: "Llama 3.1 405B Base (Hyp)",
                    provider: "Hyperbolic",
                    cost: { in: 4.0, out: 4.0 },
                    max: { in: 32768, out: 32768 },
                },
                "accounts/fireworks/models/llama-v3p1-405b-instruct": {
                    short: "Llama 3.1 405B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 1.79, out: 1.79 },
                    max: { in: 131072, out: 4096 },
                },
                "accounts/fireworks/models/llama-v3p1-70b-instruct": {
                    short: "Llama 3.1 70B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.3, out: 0.3 },
                    max: { in: 131072, out: 4096 },
                },
                "accounts/fireworks/models/llama-v3p1-8b-instruct": {
                    short: "Llama 3.1 8B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.055, out: 0.055 },
                    max: { in: 131072, out: 4096 },
                },
                "accounts/fireworks/models/mixtral-8x22b-instruct": {
                    short: "Mixtral 8x22B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.65, out: 0.65 },
                    max: { in: 65536, out: 4096 },
                },
                "accounts/fireworks/models/mixtral-8x7b-instruct": {
                    short: "Mixtral 8x7B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.24, out: 0.24 },
                    max: { in: 32768, out: 4096 },
                },
                "accounts/fireworks/models/gemma2-9b-it": {
                    short: "Gemma 2 9B Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.2, out: 0.2 },
                    max: { in: 8192, out: 4096 },
                },
                "accounts/fireworks/models/phi-3-vision-128k-instruct": {
                    short: "Phi 3.5V Inst (FW)",
                    provider: "Fireworks",
                    cost: { in: 0.0, out: 0.0 },
                    max: { in: 32064, out: 4096 },
                },
                "accounts/yi-01-ai/models/yi-large": {
                    short: "Yi Large (FW)",
                    provider: "Fireworks",
                    cost: { in: 3.0, out: 3.0 },
                    max: { in: 32768, out: 4096 },
                },
                "echo": {short: "Echo input", provider: "none", cost: {in: 0, out: 0}, max: {in: -1, out: -1},},
                "none": {short: "No model", provider: "none", cost: {in: 0, out: 0}, max: {in: -1, out: -1},}
            }
        }

    const immutableConversations = {
        "Read Me": {
            immutable: true,
            order: 0,
            state: {
                settings: {},
                data: {
                    messages: [
                        { role: "comment", tokenCount: '3', content:
                            "On chat completions"
                        },
                        { role: "system", tokenCount: '66', content:
                            "Messages with the (S)ystem role are not part of the conversation per se, but are used to shape the assistant's identity, instructions, and manner of interaction. They can be used to dictate everything from persona to formatting to task-specific instructions. Best practice is to use only one system message at the beginning of a conversation."
                        },
                        { role: "user", tokenCount: '39', content:
                            "The (U)ser role is used to tag messages as the user's input, e.g. a question or directive. These messages represent what a human interacting with the AI would say or ask."
                        },
                        { role: "assistant", tokenCount: '39', content:
                            "The (A)ssistant role is used to tag the LLM's provided completions, e.g. answers or completed tasks. These messages represent the AI's responses to the user's inputs."
                        },
                        { role: "comment", tokenCount: '39', content:
                            "The (C)omment role isn't actually a real role. It's here as an easy way to annotate conversations and store text, and doesn't get used for API calls."
                        },
                        { role: "user", tokenCount: '58', content:
                            "Chat apps typically restrict you to the format S-U-A-U-A-U-A..., with each assistant message coming automatically and immutably. This tool directly interfaces with the LLM provider API to allow you to manually craft entire conversations, edit any message, and generate chat completions at will."
                        },
                        { role: "comment", tokenCount: '5', content:
                            "How to generate completions"
                        },
                        { role: "user", tokenCount: '48', content:
                            "Several provider APIs are accessible, so long as you have API keys. After entering your key for a provider on the left, you can choose a model belonging to that provider. Different models have different capabilities, token limits, and pricing structures."
                        },
                        { role: "assistant", tokenCount: '67', content:
                            "Any completion you call for will be streamed to the bottom panel. Once complete, you can either overwrite this output by calling for another completion, or press 'f' to append it to the conversation as an assistant message. This allows for fine-grained control over the conversation flow and the ability to experiment with different prompts and completions."
                        },
                        { role: "user", tokenCount: '51', content:
                            "You can also generate text completions, which directly continue the content of the selected cell. For instance, you can write the first half of a Python function, poem, or 100-word essay, then use a text completion to fill in the rest."
                        },
                        { role: "comment", tokenCount: '3', content:
                            "Additional utilities"
                        },
                        { role: "assistant", tokenCount: '83', content:
                            "Use the Jina.AI API (free, and very generously so) to enable the automatic tokenizer; use Exa.AI (paid, usage-dependent cost) for the Exa Search (shows websites related to the selected cell's content) and Find Similar Sites (shows websites related to the selected cell's URL). You may need a CORS proxy for Exa to work; one can be entered alongside the rest of these keys, in the dropdown section labeled 'Keys'."
                        },
                        { role: "comment", tokenCount: '3', content:
                            "Provider-specific details"
                        },
                        { role: "user", tokenCount: '127', content:
                            "Note: the automatic tokenization feature relies on tokenizer model o200k_base, which is ONLY accurate for 4o-series models; Llama, Claude, and other models have their own tokenizers, for which o200k_base can only provide an approximate count.\nAlso, be aware that different providers have different API structures and require different formats. For instance, Anthropic gets mad if you have two assistant messages in a row, and only lets one system message pass; accessing their models via OpenRouter means that your requests automatically get formatted in the right structure, but won't provide a completion free from these inherent restrictions."
                        },
                        { role: "user", tokenCount: '59', content:
                            "Yet other models will throw errors if you give them inputs they don't want, e.g. a \"suffix\" parameter to a chat completion model. In general, whenever a completion no longer triggers properly, or triggers for a brief moment before ending without output, you should check the browser console for an error, since there's often something you can do to fix it."
                        },
                        { role: "user", tokenCount: '89', content:
                            "Many models appear multiple times in the dropdowns; this is because different providers offer qualitatively different versions of the same model. Groq's thing is offering extremely fast completions, for instance, while Hyperbolic's thing is not quantizing its models, running them at full (FP16) resolution for slightly higher completion quality, and Fireworks' thing is making lots of models available for text completions as well as chat completions."
                        },
                        { role: "comment", tokenCount: '3', content:
                            "About this file"
                        },
                        { role: "assistant", tokenCount: '59', content:
                            "This is a standalone HTML file; you can download it and use it anywhere. However, it relies (exclusively) on your browser's localStorage to store API keys and saved chats. The most up-to-date version will remain at https://n.cohomology.group/chat.html."
                        }
                    ],
                    completion: { type: "chat", content: "" }
                }
            }
        },
        "Ex: Basic assistant": {
            immutable: true,
            order: 1,
            state: {
                settings: {},
                data: {
                    completion: { type: "chat", content: "" },
                    messages: [
                        { role: "system", tokenCount: '74', content:
                            "You are an intelligent, proactive, and insightful AI assistant. Your thought process quickly identifies the right information and ideas to be exchanged, allowing you to speak precisely without repetition, restatement, or overexplanation, and your casual yet precise register ensures that communication is open and easy."
                        },
                        { role: "user", tokenCount: '8', content:
                            "How do you milk an almond?"
                        }
                    ]
                }
            }
        },
        "Ex: Code reference": {
            immutable: true,
            order: 2,
            state: {
                settings: { "temperature": 0.2 },
                data: {
                    completion: { type: "chat", content: "" },
                    messages: [
                        { role: "system", tokenCount: '239', content:
                            `You are an AI designed to help people with tasks in all known programming languages. When given a language and an objective, reply with the idiomatic means of achieving the objective in the language. For instance, given "iterate over a list in C", reply with\n\`\`\`c\nfor (int i = 0; i < list_length; i++){\n    do_something(list[i]);\n}\n\`\`\`\nGiven "begin a latex document", reply with\n\`\`\`latex\n\\documentclass{article}\n\\begin{document}\n\n\\end{document}\n\`\`\`\nGiven "read a file in Javascript", reply with\n\`\`\`javascript\nvar fs = require('fs');\nfs.readFile('filename', 'utf8', function(err, data) {\n    do_something(data);\n});\n\`\`\`\nConcision is vital, so reply only with the code in a codebox of the appropriate language; do not explain what the code does or how to use it if the user does not ask. Assume they have a strong programming background and understand metasyntactic variables. When there is ambiguity concerning what the user wants to do, cover multiple cases if you can do so concisely, otherwise pointing out the ambiguity and asking the user to specify.`
                        },
                        { role: "user", tokenCount: '12', content:
                            "How do you initialize a const as an async lambda function?"
                        }
                    ]
                }
            }
        },
        "Ex: LLM Search": {
            immutable: true,
            order: 3,
            state: {
                settings: { "temperature": 0.2 },
                data: {
                    completion: { type: "chat", content: "" },
                    messages: [
                        { role: "system", tokenCount: '191', content:
                            `You are a digital assistant and helper process designed by Anthropic, operating as an intelligent search engine, with the goal of solving a problem for a user. If possible, infer what the user is trying to figure out from their search query and provide the direct solution they're looking for.\nFor instance, the search query "python datetime set timezone" may be met with "Import \`pytz\` and set the \`tzinfo\` field of a \`datetime.datetime\` object to say \`pytz.timezone('Europe/Berlin')\`.". Be concise, imperative, and to-the-point, do not repeat the user's query, and do not mention obvious things such as "Remember to replace 'Europe/Berlin' with your actual timezone". Should the user initiate further conversation and ask for more details, stay concise at first, listing solutions rather than background info until the user themselves broadens the conversation.\n\nYou are now connected with a user.\nSearch query:`
                        },
                        { role: "user", tokenCount: '7', content:
                            "unescape and parse json from stdin"
                        }
                    ]
                }
            }
        }
    };

/**                STATES AND CONSTANTS                **/

    Object.prototype.items = function() {
        return Object.entries(this);
    }

    Array.prototype.last = function() {
        return this[this.length - 1];
    }

    Array.prototype.mapping = function(fn) {
        return Object.fromEntries(this.map((key) => [key, fn(key)]));
    }

    const constant = (x) => (...args) => x;
    let selectedCell = null;
    let didLastSave = true;
    let editMode = false;

    let stateHistory = [];
    let maxHistoryLength = 5; // Maximum states to keep in history

    let savedStates = {};
    let quickSaveSlots = {};

    const cache = new Map();
    const textBuildCache = new Map();

    const fetch_builtin = fetch; // we will change fetch later

    const completionLockedButtons = [
        'chatCompletionBtn',
        'textCompletionBtn',
        'findSimilarSitesBtn',
        'exaSearchBtn'
    ];

    const completionShownButtons = [
        'stopCompletionBtn',
    ];

    const autosummarizers = [
        'autoSummarizeGPT',
        'autoSummarizeGemini',
        'autoSummarizeLlama3B',
    ];

    const mathDelimiters = [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true}
    ];

    const renderMath = (elem) => {
        renderMathInElement(elem, {delimiters: mathDelimiters});
    };

    const $inputs = {
        get: (id) => {
            let el = getId(id);
            if (el.type == 'checkbox' || el.type == 'radio')
                return el?.checked || false;
            return el?.value || '';
        },
        set: (id, value) => {
            if (value === undefined || value === null) return;
            let el = getId(id);
            if (el.type == 'checkbox' || el.type == 'radio')
                el.checked = (value == 'true' || value == true);
            else
                el.value = value;
        },
        saveAllOptions: () => {
            const options = queryAll(".option").map(x=>x.getAttribute("id"));
            options.forEach(id => {
                setLocal(id, $inputs.get(id));
            });
        },
        checkAvailability: () => {
            const keyList = queryAll(".secret.key").map(x=>x.getAttribute("id"));
            const available = keyList.mapping(id => $inputs.get(id).trim());
            available["customKey"] = true;
            const hidden = keyList.mapping(id => $inputs.get(id) == "hide");
            const selectedModels = ["chat", "text"].map(type => {
                const typeId = type == "chat" ? "modelChat" : "modelText";
                const modelSelect = getId(typeId);
                Array.from(modelSelect.children).forEach(option => {
                    const keyId = $inputs.providerKeyId(
                        $models[type][option.value].provider
                    );
                    option.disabled = !available[keyId];
                    option.hidden = hidden[keyId];
                });
                return modelSelect?.value;
            });

            ["exaSearchBtn", "findSimilarSitesBtn"].forEach(id => {
                getId(id).disabled = !available["exaKey"];
                getId(id).inert = !available["exaKey"];
                getId(id).hidden = hidden["exaKey"];
            });

            const fimAvailable = $models["text"][selectedModels[1]]?.extra?.includes("suffix");
            getId("fimCompletionBtn").disabled = !fimAvailable;
            getId("fimCompletionBtn").inert = !fimAvailable;

        },
        loadAllOptions: async () => {
            const options = queryAll(".option").map(x=>x.getAttribute("id"));
            options.forEach(id => {
                $inputs.set(id, getLocal(id));
            });
            // set default values for radio buttons
            if (!autosummarizers.some(id => getId(id)?.checked)) {
                getId('autoSummarizeGPT').checked = true;
            }
            $inputs.checkAvailability();
            toggleTokenVisibility();
        },
        saveAllApiKeys: () => {
            const secretList = queryAll(".secret").map(x=>x.getAttribute(("id")));
            setLocal('keys', secretList.mapping($inputs.get));
            $inputs.checkAvailability();
        },
        loadAllApiKeys: async () => {
            const secretList = queryAll(".secret").map(x=>x.getAttribute(("id")));
            if(!getLocal('keys')) {
                return setLocal('keys', secretList.mapping(constant('')));
            }
            secretList.forEach(id => {
                const value = getLocal(['keys', id]);
                if (value?.length > 0)
                    $inputs.set(id, value);
            });
            $inputs.checkAvailability();
        },
        attributes: {
            messages: [
                "role",
                "content",
                "author",
                "label",
                "tokenCount",
                "data",
                "id",
                "up",
                "down",
                "left",
                "right",
            ],
        },
        attrDefaults: {
            messages: {
                "role": "user",
                "content": "",
                "author": "",
                "label": "",
                "tokenCount": "",
                "data": "",
                "id": "",
                "up": "",
                "down": "",
                "left": "",
                "right": "",
            },
        },
        classes: {
            messages: [
                "disabled",
                "condensed",
                "expanded",
                "selected",
                "collapsed",
            ],
        },
        defaults: {
            temperature: 0.5,
            top_p: 1.0,
            maxTokensChat: 8000,
            maxTokensText: 250,
            numSitesFind: 3,
            numSitesSearch: 5,
            numSentencesSearch: 2,
            numHighlightsSearch: 3,
            otherParams: '',
            streaming: true,
        },
        objects: [
            "keys",
            "savedConversations",
            "quickSaveSlots",
            "snapshot",
        ],
        providerKeyId: (provider) => {
            if (["echo", "none"].includes(provider))
                return "customKey";
            return provider.toLowerCase().split("_")[0] + "Key";
        },
    };

/**                CONSTANT STRINGS                **/

    const makeSVG = (name, pathData, options = {}) => {
        return `<svg xmlns="http://www.w3.org/2000/svg" ` +
            `width="${options?.width ?? '1em'}" height="${options?.height ?? '1em'}" ` +
            `viewBox="0 0 24 24" fill="${options?.fill ?? 'none'}" ` +
            `stroke="currentColor" stroke-width="${options?.strokeWidth ?? '2'}" ` +
            `stroke-linecap="round" stroke-linejoin="round" ` +
            `class="lucide lucide-${name}">${pathData}</svg>`
    };

    const constants = {
        internal: {
            maxHtmlLength: 200000 * 4,
        },
        symbols: {  // mostly lucide-icons
            download: makeSVG(
                `download`,
                `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>`
            ),
            externalLink: makeSVG(
                `external-link`,
                `<path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 0 2-2h6"/>`
            ),
            save: makeSVG(
                `save`,
                `<path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/>`
            ),
            arrowDownToLine: makeSVG(
                `arrow-down-to-line`,
                `<path d="M12 17V3"/><path d="m6 11 6 6 6-6"/><path d="M19 21H5"/>`
            ),
            heart: makeSVG(
                `heart`,
                `<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>`
            ),
            heartOff: makeSVG(
                `heart-off`,
                `<line x1="2" y1="2" x2="22" y2="22"/><path d="M16.5 16.5 12 21l-7-7c-1.5-1.45-3-3.2-3-5.5a5.5 5.5 0 0 1 2.14-4.35"/><path d="M8.76 3.1c1.15.22 2.13.78 3.24 1.9 1.5-1.5 2.74-2 4.5-2A5.5 5.5 0 0 1 22 8.5c0 2.12-1.3 3.78-2.67 5.17"/>`
            ),
            pin: makeSVG(
                `pin`,
                `<path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z"/>`
            ),
            moveUp: makeSVG(
                `move-up`,
                `<path d="M8 6L12 2L16 6"/><path d="M12 2V22"/>`
            ),
            moveDown: makeSVG(
                `move-down`,
                `<path d="M8 18L12 22L16 18"/><path d="M12 2V22"/>`
            ),
            user: makeSVG(
                `user`,
                `<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>`
            ),
            bot: makeSVG(
                `bot`,
                `<path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/>`
            ),
            cog: makeSVG(
                `cog`,
                `<path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2v2"/><path d="M12 22v-2"/><path d="m17 20.66-1-1.73"/><path d="M11 10.27 7 3.34"/><path d="m20.66 17-1.73-1"/><path d="m3.34 7 1.73 1"/><path d="M14 12h8"/><path d="M2 12h2"/><path d="m20.66 7-1.73 1"/><path d="m3.34 17 1.73-1"/><path d="m17 3.34-1 1.73"/><path d="m11 13.73-4 6.93"/>`
            ),
            chevronsDownUp: makeSVG(
                `chevrons-down-up`,
                `<path d="m7 20 5-5 5 5"/><path d="m7 4 5 5 5-5"/>`
            ),
            chevronsUpDown: makeSVG(
                `chevrons-up-down`,
                `<path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/>`
            ),
            circleX: makeSVG(
                `circle-x`,
                `<circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>`
            ),
            eye: makeSVG(
                `eye`,
                `<path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/>`
            ),
            eyeOff: makeSVG(
                `eye-off`,
                `<path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"/><path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"/><path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"/><path d="m2 2 20 20"/>`
            ),
            chevronUp: makeSVG(
                `chevron-up`,
                `<path d="m18 15-6-6-6 6"/>`
            ),
            chevronDown: makeSVG(
                `chevron-down`,
                `<path d="m6 9 6 6 6-6"/>`
            ),
            textSelect: makeSVG(
                `text-select`,
                `<path d="M5 3a2 2 0 0 0-2 2"/><path d="M19 3a2 2 0 0 1 2 2"/><path d="M21 19a2 2 0 0 1-2 2"/><path d="M5 21a2 2 0 0 1-2-2"/><path d="M9 3h1"/><path d="M9 21h1"/><path d="M14 3h1"/><path d="M14 21h1"/><path d="M3 9v1"/><path d="M21 9v1"/><path d="M3 14v1"/><path d="M21 14v1"/><line x1="7" x2="15" y1="8" y2="8"/><line x1="7" x2="17" y1="12" y2="12"/><line x1="7" x2="13" y1="16" y2="16"/>`
            ),
        },
        text: {
            generationInProgress: 'A generation is already in progress',
            enterAPIKey: (provider) =>
                `Please enter your ${provider} API key`,
            generationStopped: '[Generation Stopped]',
            roleDefaults: {
                system: 'You are a helpful assistant.',
                user: 'Please do the thing.',
                assistant: 'Certainly!',
                comment: '(now we do the thing)',
                output: '(output)',
            },
            errors: {
                noURLFound: "No URL found in the input",
                contextExceeded: "(context exceeded)",
                generic: (message) =>
                    `Error: ${message}`,
                http: (status, text) =>
                    `HTTP error! status: ${status}, response: ${text}`,
                tokenization: (error) =>
                    `Error counting tokens: ${error}`,
                jinaServer: (error) =>
                    `Jina fetch failed: ${error}`,
                jinaClient: (error) =>
                    `Error fetching content with Jina: ${error}`,
                jinaApiKey: "Jina API key not set.",
                exaServer: (error) =>
                    `Exa fetch failed: ${error}`,
                exaClient: (error) =>
                    `Error fetching content with Exa: ${error}`,
                exaApiKey: "Exa API key not set.",
                getContents: (error) =>
                    `Error getting content: ${error}`,
                getContentsTrim: (originalLength, trimmedLength) =>
                    `Content trimmed from ${originalLength} to ${trimmedLength} characters.`,
                corsError: (url) =>
                    `Request for ${url} blocked by CORS: set a valid CORS proxy in the options dropdown to get around this.`,
                corsDoubleError: (url, status) =>
                    `Request to ${url} blocked by CORS, proxied request also failed due to: ${status}`,
                corsFetchFail: (url, proxyUrl, msg) =>
                    `Failed to fetch ${url} via CORS proxy ${proxyUrl}: ${msg}`,
                noBinary: 'Binary file formats (PDF, ZIP, DOC, etc.) cannot be loaded as raw HTML. Use Jina or Exa.',
                fileTooLarge: (size) =>
                    `File too large for this script to download manually (${Math.round(size/1024/1024)}MB); use Jina or Exa`,
                fetchFail: (status) =>
                    `Failed to fetch: ${status}`,
                conversationTooLong: (length) =>
                    `Conversation too long (${length}/100000 characters)`,
                needOpenRouterKey: (model) =>
                    `Need OpenRouter API Key to use ${model}`,
                noPrompt: `A prompt for the text completion was not provided`,
                noSelection: `Select an enabled block with content to use FIM`,
                fimNoSuffix: `Cannot form FIM suffix from content following the selection`,
                summarizationFailed: (model, err) =>
                    `${model} summarization failed: ${err}`,
                OAIorORNeedKey: (model) =>
                    `Need OpenAI or OpenRouter API Key to use ${model}`,
                OAIandORBothFailed: (model) =>
                    `Both OpenAI and OpenRouter ${model} summarization attempts failed`,
                removeDefaultMessages: `Last message to be sent is a default role message; change or remove it before re-sending.`,
            },
            variables: {
                inactive: "now inactive",
                active: "now active",
                local: "now local",
                global: "now global",
                delete: "delete",
                key: "Key: ",
                value: "Value: ",
            },
            localStorageCleaned: "Local storage cleaned successfully",
            states: {
                saved: (name) => `Saved state: ${name}`,
                loaded: (name) => `Loaded state: ${name}`,
                deleted: (name) => `Deleted state: ${name}`,
                slot: {
                    saved: (slot) => `Saved current state to slot ${slot}`,
                    loaded: (slot) => `Loaded state from slot ${slot}`,
                    empty: (slot) => `No saved state in slot ${slot}`,
                    deletedQuicksave: (slot) => `Deleted quicksave in slot ${slot}`,
                },
                import: {
                    success: "Data imported successfully",
                    failure: (msg) => `Import failed: ${msg}`,
                },
            },
            buttons: {
                moveUp: "move up",
                moveDown: "move down",
                favorite: "favorite",
                unfavorite: "unfavorite",
                duplicate: "duplicate",
                save: "save",
                load: "load",
                delete: "del",
                summarize: "title",
                titles: {
                    save: "overwrite save",
                    load: "load save",
                    delete: "delete save",
                    summarize: "auto-generate save title",
                },
            },
        },

        html: {
            saveBoxImmutable: (name, buttons) => {
                return `
                    <div class="save-name">
                        ${name}
                    </div>
                    <div class="button-container">
                        <button class="load-button" onclick="loadState('${name}')">
                            ${buttons.load}
                        </button>
                    </div>`
            },
            saveBoxMutable: (name, buttons) => {
                return `
                    <div class="save-name" onclick="editSaveName('${name}', this)">
                        ${name}
                    </div>
                    <div class="button-container">
                        <button class="title-button" onclick="titleState('${name}')" title="${constants.text.buttons.titles.summarize}">
                            ${buttons.summarize}
                        </button>
                        <button class="delete-button" onclick="deleteState('${name}')" title="${constants.text.buttons.titles.delete}">
                            ${buttons.delete}
                        </button>
                        <button class="save-button" onclick="saveState('${name}')" title="${constants.text.buttons.titles.save}">
                            ${buttons.save}
                        </button>
                        <button class="load-button" onclick="loadState('${name}')" title="${constants.text.buttons.titles.load}">
                            ${buttons.load}
                        </button>
                    </div>`
            },
            tokensValid: (totalTokens) => {
                return `<span style="color: green;font-size:1.0em;">${totalTokens}</span>`
            },
            tokensExceeded: (totalTokens, maxTokensIn) => {
                return `<span style="color: red;font-size:1.0em;">${totalTokens}</span> / ${maxTokensIn} <span style="color: red;">${constants.text.errors.contextExceeded}</span>`
            },
            variableBlock: (variable) => {
                return `
                    <div style="display: flex; flex-direction: row;">
                        <span>${constants.text.variables.key}</span>
                        <input type="text" class="variable-input" value="${variable.key}">
                    </div>
                    <div style="display: flex; flex-direction: row;">
                        <span>${constants.text.variables.value}</span>
                        <input type="text" class="variable-value" value="${variable.value}">
                    </div>
                    <div style="display: flex; flex-direction: row;">
                        <button class="variable-delete-button" onclick="deleteVariable(this)">
                            ${constants.text.variables.delete}
                        </button>
                        <button class="variable-active-button" onclick="toggleVariable(this)">
                            ${variable.enabled ? constants.text.variables.active : constants.text.variables.inactive}
                        </button>
                        <button class="variable-scope-button" onclick="toggleVariableScope(this)">
                            ${variable.local ? constants.text.variables.local : constants.text.variables.global}
                        </button>
                    </div>
                `
            },

            chatCost: (inCost, estCost, maxTokensOut, chatCost, sumCost) => {
                let chatCost1 = `<span style="font-size:1.0em;">${displayCurrency(inCost)}</span>`;
                let chatCost2 = estCost > 0 ? `, est. <span style="color:blue;font-size:1.0em;">${displayCurrency(estCost)}</span>` : '';
                let chatCost3 = (maxTokensOut >= 0 && chatCost.out >= 0) ? `, <span style="font-size:1.0em;">${displayCurrency(sumCost)}</span>` : '';
                return `[${chatCost1}${chatCost3}]${chatCost2}`;
            },

            textCost: (textInCost, textSumCost) => {
                let textCost1 = textInCost < 0 ? '' :
                    `<span style="font-size:1.0em;">${displayCurrency(textInCost)}</span>`;
                let textCost3 = textSumCost < 0 ? '' :
                    `<span style="font-size:1.0em;">${displayCurrency(textSumCost)}</span>`;
                let sep = (textInCost >= 0 || textSumCost >= 0) ? ', ' :
                    ((textInCost < 0 && textSumCost < 0) ? 'unavailable' : '');
                return `[${textCost1}${sep}${textCost3}]`;
            },

            messageBlock: (options) => {
                const role = options.role || 'user';
                const author = options.author || '';
                const label = options.label || '';
                const content = options.content || '';
                const tokenCount = options.tokenCount || '';
                const data = options.data || {};
                const id = options.id || '';
                const up = options.up || '';
                const down = options.down || '';
                const left = options.left || '';
                const right = options.right || '';
                const messageBlock = create('div', { class: 'message-block' });
                const controlDiv = create('div', { class: 'message-control' });
                const contentDiv = create('div', {
                    class: 'message-content',
                    role: role,
                    tokenCount: tokenCount,
                    content: content,
                    author: author,
                    label: label,
                    data: data,
                    id: id,
                    up: up,
                    down: down,
                    left: left,
                    right: right,
                });
                contentDiv.innerHTML = renderMarked(content);
                renderMath(contentDiv);
                const classesToAdd = ["disabled", "enabled", "condensed", "expanded", "collapsed", "uncollapsed", "selected"].filter(cls => options[cls]);
                if (classesToAdd.length)
                    contentDiv.classList.add(...classesToAdd);

                const roleButton = createButton(
                    contentDiv.getAttribute('role'),
                    () => cycleRole(contentDiv),
                    ['role-button']
                );
                roleButton.dataset.role = contentDiv.getAttribute('role');
                const deleteButton = createButton(
                    constants.symbols.circleX,
                    () => deleteCell(contentDiv),
                    ['control-button', 'delete-button']
                );
                const moveUpButton = createButton(
                    constants.symbols.chevronUp,
                    () => moveNode(messageBlock, 'up'),
                    ['control-button', 'move-up-button']
                );
                const moveDownButton = createButton(
                    constants.symbols.chevronDown,
                    () => moveNode(messageBlock, 'down'),
                    ['control-button', 'move-down-button']
                );
                const condenseButton = createButton(
                    constants.symbols.chevronsDownUp,
                    () => toggleCondense(contentDiv, condenseButton),
                    ['control-button', 'condense-button']
                );
                const enableButton = createButton(
                    constants.symbols.eyeOff,
                    () => toggleEnable(contentDiv, enableButton),
                    ['control-button', 'enable-button']
                );
                const collapseButton = createButton(
                    constants.symbols.chevronUp,
                    () => toggleCollapse(contentDiv, collapseButton),
                    ['control-button', 'collapse-button']
                );
                const authorDiv = create(
                    'div',
                    { class: 'control-row-text-field author-info' },
                );
                authorDiv.textContent = author || '';
                authorDiv.contentEditable = true;
                const labelDiv = create(
                    'div',
                    { class: 'control-row-text-field label-info' },
                );
                labelDiv.textContent = label || '';
                labelDiv.contentEditable = true;
                const tokenDiv = create(
                    'div',
                    { class: 'token-info' }
                );
                tokenDiv.textContent = contentDiv.tokenCount || '';
                const row1 = create(
                    'div',
                    { class: 'control-row' },
                    [
                        roleButton,
                        authorDiv, labelDiv, tokenDiv,
                        moveUpButton, moveDownButton,
                        collapseButton, condenseButton, enableButton,
                        deleteButton
                    ]
                );
                controlDiv.appendChild(row1);

                messageBlock.append(controlDiv, contentDiv);
                requestAnimationFrame(() => {
                    addEventListeners(messageBlock);
                    updateTokenCount(messageBlock);
                });
                return messageBlock;
            },
            messageRow: (label) => {
                if (!label)
                    label = 'R' + randStr(4);
                const row = create('div', { label: label, class: 'message-row' });
                return row;
            },
            validTags: ['div', 'span', 'button', 'input', 'textarea', 'select', 'option', 'label', 'form', 'fieldset', 'legend', 'table', 'tr', 'td', 'th', 'tbody', 'thead', 'tfoot', 'caption', 'colgroup', 'col', 'ul', 'ol', 'li', 'dl', 'dt', 'dd', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'pre', 'blockquote', 'hr', 'address', 'cite', 'q', 'code', 'kbd', 'samp', 'var', 'abbr', 'acronym', 'dfn', 's', 'strike', 'big', 'small', 'sub', 'sup', 'tt', 'i', 'b', 'u', 'em', 'strong', 'a', 'img', 'map', 'area', 'object', 'iframe', 'embed', 'param',],
        },
    };

    const displayCurrency = (val) => {
        // get the final number we'll show
        let num, symbol;
        if (val >= 1.00) {
            num = val.toFixed(3);
            symbol = '$';
        } else {
            num = (val * 100).toFixed(2);
            symbol = '<span style="font-size: 1.1em; position: relative; top: -1px; padding-left: 1px; padding-right: 1px;">¢</span>';
        }
        // split into whole number and decimal parts
        const [whole, dec] = num.split('.');
        return `${symbol}${whole}<span style="font-size: 0.8em;">.${dec}</span>`;
        //return val >= 0.10 ? `$${val.toFixed(3)}` : `¢${(val * 100).toFixed(2)}`;
    }
    const randStr = (n) => {
        // a string of n random lowercase letters of length n (max 12)
        return Array.from(Math.random().toString(26).slice(2))
            .map(x => x.charCodeAt(0))
            .map(x => String.fromCharCode(x + (x < 97 ? 65 : 0)))
            .join("").slice(-n);
    };

/**                UTILITIES                **/

    const collapse = (fn) => (a, b=null) => b===null ? fn(a) : fn(a)(b);
    const id = (x) => x;
    const log = (x) => { console.log(x); return x; }

    const isArray = Array.isArray;
    const isString = (x) => typeof x === 'string';
    const isFunc = (x) => typeof x === 'function';
    const isObject = (x) => typeof x === 'object' && !isArray(x) && !isFunc(x);

    const getId = (id) => document.getElementById(id) || null;
    const getValue = (inputId) => {
        // handle text inputs, textareas, selects, checkboxes, and radio buttons
        const input = getId(inputId);
        if (!input) return null;
        if (input.tagName === 'INPUT' && input.type === 'text') return input.value;
        if (input.tagName === 'TEXTAREA') return input.value;
        if (input.tagName === 'SELECT') return input.value;
        if (input.tagName === 'INPUT' && ['checkbox', 'radio'].includes(input.type)) return input.checked;
        return null;
    }

    const queryAll = (selector) => Array.from(document.querySelectorAll(selector));
    const query = (selector) => document.querySelector(selector);
    const forEach = (obj, fn, filter = null) => {
        if (filter === null) {
            filter = (...args) => true;
        }

        if (isObject(obj)) {
            Object.entries(obj)
                .filter(([k, v]) => filter(k, v))
                .forEach(([k, v]) => fn(k, v));
            return;
        }

        if (isArray(obj)) {
            obj
                .filter(x => filter(x))
                .forEach(x => fn(x));
            return;
        }
    }

    const applyPatches = (elem, patches) =>
        Object.entries(patches).forEach(([k,v]) =>
            Object.defineProperty(elem.prototype, k,
                typeof v === 'string' ?
                    {
                        get() { return this[v]; },
                        set(newVal) { this[v] = newVal; }
                    } :
                    {
                        value: function(...args) { return v(this, ...args); }
                    }
            )
        );
    const inheritStatic = (elem, fnAttr, as = null) =>
        applyPatches(elem, {[as || fnAttr]: elem[fnAttr]});

    // Make static methods available as instance methods
    inheritStatic(Object, 'entries');  // obj.entries()
    inheritStatic(Object, 'keys');     // obj.keys()
    inheritStatic(Object, 'values');   // obj.values()

    const localPatches = {
        Element: {
            prev: "previousElementSibling",
            next: "nextElementSibling",
            parent: "parentNode",
            first: "firstElementChild",
            last: "lastElementChild",
            query: "querySelector",
            queryAll: "querySelectorAll",
            getId: "getElementById",
            // Viewport coordinates (getBoundingClientRect)
            x0: el => el.getBoundingClientRect().left,
            y0: el => el.getBoundingClientRect().top,
            w0: el => el.getBoundingClientRect().width,
            h0: el => el.getBoundingClientRect().height,

            // Document coordinates (including scroll)
            x: el => el.getBoundingClientRect().left + window.scrollX,
            y: el => el.getBoundingClientRect().top + window.scrollY,

            // Relative to parent (offset)
            dx: "offsetLeft",
            dy: "offsetTop",
            dw: "offsetWidth",
            dh: "offsetHeight",

            // Client area
            cx: "clientLeft",
            cy: "clientTop",
            cw: "clientWidth",
            ch: "clientHeight"
        }
    };
    applyPatches(Element, localPatches.Element);

    const addClass = (selector, cls) => {
        if (isArray(cls)) {
            cls.forEach(c => addClass(selector, c));
            return;
        }
        if (selector instanceof HTMLElement) {
            selector.classList.add(cls);
            return;
        }
        queryAll(selector).forEach(el => el.classList.add(cls));
    }

    const removeClass = (selector, cls) => {
        if (isArray(cls)) {
            cls.forEach(c => removeClass(selector, c));
            return;
        }
        if (selector instanceof HTMLElement) {
            selector.classList.remove(cls);
            return;
        }
        queryAll(selector).forEach(el => el.classList.remove(cls));
    }

    const toggleClass = (selector, cls) => {
        if (isArray(cls)) {
            cls.forEach(c => toggleClass(selector, c));
            return;
        }
        if (selector instanceof HTMLElement) {
            selector.classList.toggle(cls);
            return;
        }
        queryAll(selector).forEach(el => el.classList.toggle(cls));
    }

    function chain(x) {
        /* Determines the type of x and applies the appropriate chain function */
        const chainFn = fn => ((arg) => isArray(arg) ? arg.map(fn) : fn(arg));
        if(isObject(x)) return objMap(chainFn, x);
        if(isArray(x)) return x.map(chainFn);
        return chainFn(x);
    }

    const objectify = collapse(
        (defaultObj) => (objFn) => Object.assign(objFn, objFn(defaultObj))
    );

    const parameterize = (objFnFn) => Object.assign(
        (param) => chain( objMap(applyTo(param), objFnFn) ),
        objMap(collapse, objFnFn)
    );

    function getItem(arr, idx) {
        // Returns the item at index idx of arr. Handles negative indices, returns null if out of bounds.
        if (isArray(idx)) { // nested lookups
            if (idx.length === 0)
                return arr;
            return getItem(getItem(arr, idx[0]), idx.slice(1));
        }
        if (isObject(idx)) { // treat object as mapping from strings to keys of arr, and replace each key with its value
            return objMap((key) => getItem(arr, key), idx);
        }
        if (arr === null || arr === undefined) {
            return arr;
        }
        if (typeof arr === "string") {
            return getItem(arr.split(''), idx);
        }
        if (idx < 0) {
            idx = arr.length + idx;
        }
        if (arr.length === 0 || idx < 0 || idx >= arr.length) {
            return null;
        }
        return arr[idx];
    }

    function getLocal(key) {
        if (isString(key))
            return localStorage.getItem(key);
        if (isArray(key) && key.length > 0) {
            let obj = JSON.parse(localStorage.getItem(key[0]));
            for (let i = 1; i < key.length; i++) {
                if (obj === null || typeof obj !== 'object')
                    return null;
                obj = obj[key[i]];
            }
            return obj;
        }
    }

    function setLocal(key, value) {
        if (isString(key)) {
            if (isArray(value) || isObject(value))
                localStorage.setItem(key, JSON.stringify(value));
            else
                localStorage.setItem(key, value);
        }
        else if (isArray(key) && key.length > 0) {
            let obj = JSON.parse(localStorage.getItem(key[0])) || {};
            let current = obj;
            for (let i = 1; i < key.length - 1; i++) {
                if (!(key[i] in current))
                    current[key[i]] = {};
                current = current[key[i]];
            }
            current[key[key.length - 1]] = value;
            localStorage.setItem(key[0], JSON.stringify(obj));
        }
        return value;
    }

    const tree = {
        parent: ((node) => { return node.parentNode }),
        next: ((node) => { return node.nextElementSibling }),
        safeNext: ((node) => { return node?.nextElementSibling || node }),
        prev: ((node) => { return node.previousElementSibling }),
        safePrev: ((node) => { return node?.previousElementSibling || node }),
        children: ((node) => { return node.children }),
        first: ((node) => { return node.firstElementChild }),
        last: ((node) => { return node.lastElementChild }),
    };

    function create(tag, props = {}, children = []) {
        const element = document.createElement(tag);
        Object.entries(props).forEach(([key, value]) => {
            if (['innerText', 'textContent', 'innerHTML'].includes(key))
                element[key] = value;
            else
                element.setAttribute(key, value);
        });
        children.forEach((child) => {
            element.appendChild(
                isString(child) ? document.createTextNode(child)
                : (child.render ? child.render() : child)
            );
        });
        return element;
    }

    const batchUpdate = (() => {
        const updates = new Set();
        let scheduled = false;

        return (fn) => {
            updates.add(fn);
            if (!scheduled) {
                scheduled = true;
                requestAnimationFrame(() => {
                    updates.forEach(update => update());
                    updates.clear();
                    scheduled = false;
                });
            }
        };
    })();

    function renderMarked(text) {
        if (getId('disableMarkdown')?.checked) return text;
        return marked.parse(text);
    }

/**            DATA MODELS             **/

const MsgBlock = {
    // Selectors for different parts of the message block
    selectors: {
        block: '.message-block',
        content: '.message-content',
        control: '.message-control',
        tokenInfo: '.token-info',
        roleButton: '.role-button'
    },
    // Data accessors
    get: {
        ...Object.fromEntries(
                $inputs.attributes.messages.map((attr) => [
                    attr,
                    (element) => MsgBlock.get.contentDiv(element).getAttribute(attr)
                ])
            ),
        ...Object.fromEntries(
                $inputs.classes.messages.map((cls) => [
                    cls,
                    (element) => MsgBlock.get.contentDiv(element).classList.contains(cls)
                ])
            ),
        ...{
            // Get the content div from a block or content div
            contentDiv: (element) => {
                if (element.classList.contains('message-content'))
                    return element;
                return element.querySelector(MsgBlock.selectors.content);
            },

            // Get the block from a block, content div, or control div
            block: (element) => {
                if (element.classList.contains('message-block'))
                    return element;
                return element.closest(MsgBlock.selectors.block);
            },
            // Get content
            content: (element) => MsgBlock.get.contentDiv(element).getAttribute('content') || buildText(MsgBlock.get.contentDiv(element)),

            text: (element) => MsgBlock.get.contentDiv(element).textContent,
        }
    },

    // Data mutators
    set: {
        ...Object.fromEntries(
            $inputs.attributes.messages.map(
            (attr) => [
                attr,
                (element, value) => MsgBlock.get.contentDiv(element).setAttribute(attr, value)
            ])),
        ...Object.fromEntries(
            $inputs.classes.messages.map(
            (cls) => [
                cls,
                (element, value) => MsgBlock.get.contentDiv(element).classList.toggle(cls, value)
            ])),
        ...{
            role: (element, role) => {
                const contentDiv = MsgBlock.get.contentDiv(element);
                contentDiv.setAttribute('role', role);
                const roleButton = contentDiv.previousElementSibling.querySelector(MsgBlock.selectors.roleButton);
                roleButton.textContent = role.charAt(0).toUpperCase();
                roleButton.dataset.role = role;
            },
            tokenCount: async (element, count) => {
                const contentDiv = MsgBlock.get.contentDiv(element);
                contentDiv.setAttribute('tokenCount', count);
                const tokenInfo = contentDiv.previousElementSibling.querySelector(MsgBlock.selectors.tokenInfo);
                if (tokenInfo)
                    tokenInfo.textContent = count;
                await updateTokenCost();
            },
            text: (element, value) => {
                MsgBlock.get.contentDiv(element).textContent = value;
            },
            disabled: (element, value) => {
                MsgBlock.get.contentDiv(element).classList.toggle('disabled', value);
                updateTokenCost();
            },
            selected: (element, value) => {
                queryAll('.selected').forEach(el => el.classList.remove('selected'));
                MsgBlock.get.contentDiv(element).classList.toggle('selected', value);
            },
            editing: (element, value) => {
                MsgBlock.get.contentDiv(element).classList.toggle('editing', value);
                MsgBlock.get.contentDiv(element).contentEditable = value;
            },
        }
    },

    // Operations
    operations: {
        create: (options) => {
            return constants.html.messageBlock(options);
        },
        delete: async (element) => {
            const block = MsgBlock.get.block(element);
            if (block.previousElementSibling)
                await selectCell(block.previousElementSibling.querySelector(MsgBlock.selectors.content));
            else if (block.nextElementSibling)
                await selectCell(block.nextElementSibling.querySelector(MsgBlock.selectors.content));
            block.remove();
            updateTokenCost();
        },
        move: (element, direction) => {
            const block = MsgBlock.get.block(element);
            const sibling = direction === 'up' ? block.previousElementSibling : block.nextElementSibling;
            if (sibling) {
                if (direction === 'up') {
                    block.parentNode.insertBefore(block, sibling);
                } else {
                    block.parentNode.insertBefore(sibling, block);
                }
            }
        },
        serialize: (element) => {
            const contentDiv = MsgBlock.get.contentDiv(element);
            return {
                ...Object.fromEntries(
                    $inputs.attributes.messages.map(
                    (attr) => [attr, MsgBlock.get[attr](element)]
                )),
                ...Object.fromEntries(
                    $inputs.classes.messages.map(
                    (cls) => [cls, MsgBlock.get[cls](element)]
                )),
            };
        },
        group: (elements) => {
            const row = constants.html.messageRow();
            elements.forEach(el => {
                const block = MsgBlock.get.block(el);
                row.appendChild(block);
            });
            getId('messages')?.appendChild(row);
            return row;
        },
        ungroup: (row) => {
            const blocks = Array.from(row.children);
            const parent = row.parentNode;
            blocks.forEach(block => {
                const newRow = constants.html.messageRow();
                newRow.appendChild(block);
                parent.insertBefore(newRow, row);
            });
            row.remove();
        },
        format: (element, format) => {
            const contentDiv = MsgBlock.get.contentDiv(element);
            const range = window.getSelection().getRangeAt(0);
            if (range.commonAncestorContainer.parentNode !== contentDiv)
                return;
            const wrapper = document.createElement(format);
            range.surroundContents(wrapper);
            contentDiv.normalize();
            contentDiv.setAttribute('content', buildText(contentDiv));
        },
        indent: (element, direction = 'right') => {
            const contentDiv = MsgBlock.get.contentDiv(element);
            const lines = contentDiv.innerHTML.split('\n');
            const indentedLines = lines.map(line =>
                direction === 'right' ?
                    '    ' + line :
                    line.replace(/^    /, '')
            );
            contentDiv.innerHTML = indentedLines.join('\n');
            contentDiv.setAttribute('content', buildText(contentDiv));
        }
    },
    shortcuts: {
        'Alt+G': (element) => MsgBlock.operations.group([element]),
        'Alt+U': (element) => MsgBlock.operations.ungroup(element.closest('.message-row')),
        'Tab': (element) => MsgBlock.operations.indent(element, 'right'),
        'Shift+Tab': (element) => MsgBlock.operations.indent(element, 'left'),
        'Ctrl+B': (element) => MsgBlock.operations.format(element, 'strong'),
        'Ctrl+I': (element) => MsgBlock.operations.format(element, 'em'),
        'Ctrl+`': (element) => MsgBlock.operations.format(element, 'code')
    }
};

/**               SAVE MANAGEMENT               **/

    /**
    * Captures the current state of the application, including settings and messages,
    * and stores it in the local storage. It also maintains a history of recent states.
    */
    function snapshotState() {
        const state = serializeState();
        if(state.data.messages.length == 0)
            return;
        const updates = {};
        // only push to history if state is different from last
        if (
            stateHistory.length == 0 ||
            JSON.stringify(stateHistory[stateHistory.length - 1].data) !== JSON.stringify(state.data)
        ) {
            stateHistory.push(state);
            if (stateHistory.length > maxHistoryLength)
                stateHistory.shift();
            updates.stateHistory = stateHistory;
        }
        updates.snapshot = state;
        forEach(updates, setLocal);
    }

    /**
     * Serializes the current state of the chat interface, including settings, messages,
     * and completion data, into a JavaScript object.
     * @returns {object} An object containing the serialized state data.
     */
    function serializeState() {
        const settings = {};
        const options = queryAll(".option").map(x=>x.getAttribute("id"));
        options.forEach(id => {
            const el = getId(id);
            settings[id] = $inputs.get(id);
        });

        const messageArray = queryAll('#messages .message-content')
            .map(el => {
                if (!el.id)
                    el.id = 'M' + randStr(4);
                return ({
                    ...Object.fromEntries(
                        $inputs.attributes.messages.map(
                            attr => [attr, el.getAttribute(attr)?.trim()]
                    )),
                    ...{ // special attribute serialization methods
                        content: el.getAttribute('content') || buildText(el),
                    },
                    ...Object.fromEntries(
                        $inputs.classes.messages.map(
                            cls => [cls, el.classList.contains(cls)]
                    )),
                    ...{ // extra data
                        classes: Array.from(el.classList),
                        rowLabel: el.closest('.message-row').getAttribute('label'),
                    }
                });
            });

        const completion = {
            type: getId('modelChat')?.value ? 'chat' : 'text',
            content: queryAll('#outputs .output')[0].getAttribute('content') || buildText(queryAll('#outputs .output')[0])
        };

        const localVariables = queryAll('.variable-block.local')
            .map(block => ({
                key: block.querySelector('.variable-input').value,
                value: block.querySelector('.variable-value').value,
                enabled: !block.classList.contains('inactive'),
                local: true
            }));

        return {
            data: {
                messages: messageArray,
                completion,
                variables: localVariables
            }
        };
    }

    /**
     * Deserializes a given state object and updates the chat interface to reflect that state.
     * @param {object} state The state object to deserialize.
     */
    async function deserializeState(state) {
        const data = state.data;

        // Clear existing messages
        const messagesDiv = getId('messages');
        messagesDiv.innerText = '';

        // Add messages from state
        await data.messages.forEach(async (msg) => {
            let row;
            if (msg.rowLabel) {
                row = messagesDiv.querySelector(`.message-row[label="${msg.rowLabel}"]`);
                if (!row) {
                    row = constants.html.messageRow(msg.rowLabel);
                    messagesDiv.appendChild(row);
                }
            } else {
                row = constants.html.messageRow();
            }

            const messageBlock = constants.html.messageBlock(msg);
            const contentDiv = messageBlock.querySelector('.message-content');

            $inputs.attributes.messages.forEach(attr => {
                let value = msg[attr] || $inputs.attrDefaults.messages[attr];
                contentDiv.setAttribute(attr, value);
            })

            contentDiv.innerHTML = renderMarked(msg.content);
            renderMath(contentDiv);

            row.appendChild(messageBlock);
            messagesDiv.appendChild(row);
        });

        // Set completion content
        const outputBlock = getId('outputs')?.querySelector(".output");
        outputBlock.setAttribute('content', data.completion.content);
        outputBlock.innerHTML = renderMarked(data.completion.content);
        renderMath(outputBlock);
        hljs.highlightAll();

        // Clear existing variables
        const variablesList = getId('variables-list');
        variablesList.innerHTML = '';
        loadGlobalVariables();

        if (data.variables?.length) {
            const varFragment = document.createDocumentFragment();
            data.variables.forEach(variable => {
                const variableBlock = document.createElement('div');
                variableBlock.className = `variable-block ${variable.local ? 'local' : 'global'} ${variable.enabled ? '' : 'inactive'}`;
                variableBlock.style.flexDirection = 'column';
                variableBlock.innerHTML = constants.html.variableBlock(variable);
                varFragment.appendChild(variableBlock);
            });
            variablesList.appendChild(varFragment);
        }
        const selectedCell = query(".selected") || query(".message-content");
        if (selectedCell)
            await selectCell(selectedCell);
        // Defer snapshot to next frame
        requestAnimationFrame(() => snapshotState());
    }

    /**
     * Saves the current state of the chat to local storage under a given slot.
     * @param {string} slot The slot number to save the state to.
     */
    async function saveStateToLocalStorage(slot) {
        const state = serializeState();
        setLocal('conversationState' + slot, state);
        savedStates['Slot ' + slot] = state;
        if(slot) {
            showSaveLoadMessage(constants.text.states.slot.saved(slot));
            updateSaveMenu();
        }
        saveSavedStates();
        saveGlobalVariables();
    }

    /**
     * Loads a chat state from local storage based on the provided slot.
     * @param {string} slot The slot number to load the state from.
     */
    async function loadStateFromLocalStorage(slot) {
        snapshotState();
        const state = getLocal('conversationState' + slot);
        if (state) {
            await deserializeState(JSON.parse(state));
            showSaveLoadMessage(constants.text.states.slot.loaded(slot));
        } else
            showSaveLoadMessage(constants.text.states.slot.empty(slot));
        updateSaveMenu();
    }

    /**
     * Displays a message in the save/load message area.
     * @param {string} message The message to display.
     * @param {boolean} [error=false] Whether the message is an error message.
     * @param {number} [timeout=5000] The time (in ms) to display the message before fading out.
     */
    function showSaveLoadMessage(message, error = false, timeout = 5000) {
        const messageDiv = getId('save-load-message');
        messageDiv.classList.add('active');
        if (error) {
            messageDiv.classList.add('save-message-error');
            messageDiv.onclick = () => {messageDiv.classList.remove('active')};
        } else
            messageDiv.classList.remove('save-message-error');
        messageDiv.textContent = message;
        if (!error && timeout >= 0)
            setTimeout(() => {messageDiv.classList.remove('active')}, timeout);
    }

    /**
     * Loads saved states from local storage into the application.
     */
    function loadSavedStates() {
        quickSaveSlots = JSON.parse(getLocal('quickSaveSlots')) || {};
        savedStates = JSON.parse(getLocal('savedConversations')) || {};
        Object.assign(savedStates, immutableConversations);
        updateSaveMenu();
    }

    /**
     * Saves the current saved states to local storage.
     */
    function saveSavedStates() {
        setLocal('quickSaveSlots', quickSaveSlots);
        setLocal('savedConversations', savedStates);
    }

    /**
     * Updates the save menu in the UI with the current saved states.
     */
    function updateSaveMenu() {
        const saveList = getId('save-list');
        saveList.innerHTML = '';

        // Sort the keys to ensure immutable conversations appear first
        const sortedKeys = Object.keys(savedStates).sort((a, b) => {
            if (savedStates[a].immutable && !savedStates[b].immutable) return -1;
            if (!savedStates[a].immutable && savedStates[b].immutable) return 1;
            if (savedStates[a].immutable && savedStates[b].immutable)
                return (savedStates[a]?.order ?? 999) < (savedStates[b]?.order ?? 999) ? -1 : 1;
            return a.localeCompare(b);
        });

        const buttons = {
            symbol: {
                // moveUp: constants.symbols.arrowUp,
                // moveDown: constants.symbols.arrowDown,
                // duplicate: constants.symbols.copy,
                // favorite: constants.symbols.star,
                // unfavorite: constants.symbols.starOutline,
                delete: constants.symbols.circleX,
                save: constants.symbols.save,
                load: constants.symbols.download,
                summarize: constants.symbols.textSelect,
            },
            text: {
                // moveUp: constants.text.buttons.moveUp,
                // moveDown: constants.text.buttons.moveDown,
                // duplicate: constants.text.buttons.duplicate,
                // favorite: constants.text.buttons.favorite,
                // unfavorite: constants.text.buttons.unfavorite,
                delete: constants.text.buttons.delete,
                save: constants.text.buttons.save,
                load: constants.text.buttons.load,
                summarize: constants.text.buttons.summarize,
            }
        }

        sortedKeys.forEach(name => {
            const saveBox = document.createElement('div');
            saveBox.className = 'save-box';
            if (savedStates[name].immutable) {
                if (!immutableConversations[name]) {
                    delete savedStates[name];
                    return;
                }
                saveBox.classList.add('immutable');
                saveBox.innerHTML = constants.html.saveBoxImmutable(name, buttons.symbol);
            } else {
                saveBox.innerHTML = constants.html.saveBoxMutable(name, buttons.symbol);
            }
            saveList.appendChild(saveBox);
        });
    }

    /**
    * Allows editing of a save name directly in the UI.
    * @param {string} oldName The current name of the save.
    * @param {HTMLElement} element The HTML element representing the save name.
    */
    function editSaveName(oldName, element) {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = oldName;
        input.addEventListener('blur', () => {
            const newName = input.value.trim();
            if (newName && newName !== oldName && !savedStates[newName]) {
                savedStates[newName] = savedStates[oldName];
                delete savedStates[oldName];
            }
            saveSavedStates();
            updateSaveMenu();
        });
        element.replaceWith(input);
        input.focus();
    }

    /**
    * Creates a new save with a default title and optionally generates an auto-title.
    */
    async function createNewSave() {
        let defaultTitle, autoTitle;
        const date = new Date();
        let name = `${date.getDate()}-${date.toLocaleString('default', { month: 'short' })}-${date.getFullYear()}`;
        let counter = 1;
        while (savedStates.hasOwnProperty(name + `-${counter}`)) {
            counter++;
        }
        defaultTitle = name + `-${counter}`;
        savedStates[defaultTitle] = serializeState();
        if (getId('autoSummarizeNewSaves')?.checked) {
            showSaveLoadMessage(`Generating title for save ${defaultTitle}...`, false, -1);
            autoTitle = await autoSummarize(serializeState());
            if (autoTitle.success) {
                savedStates[autoTitle.content] = savedStates[defaultTitle];
                if (defaultTitle != autoTitle.content)
                    delete savedStates[defaultTitle];
                showSaveLoadMessage(constants.text.states.saved(autoTitle.content), false, 5000);
            } else
                showSaveLoadMessage(`Auto-title failed: ${autoTitle.content}`, true);
        }
        saveSavedStates();
        updateSaveMenu();
    }

    /**
    * Saves the current state under a specified name.
    * @param {string} name The name under which to save the current state.
    */
    function saveState(name) {
        savedStates[name] = serializeState();
        saveSavedStates();
        showSaveLoadMessage(constants.text.states.saved(name));
    }

    async function loadState(name) {
        snapshotState();
        if (savedStates[name]) {
            await deserializeState(savedStates[name].state || savedStates[name]);
            showSaveLoadMessage(constants.text.states.loaded(name));
        }
    }

    /**
    * Generates a title for a saved state using auto-summarization.
    * @param {string} name The name of the saved state to title.
    */
    async function titleState(name) {
        const state = savedStates[name];
        if (state) {
            showSaveLoadMessage(`Generating title for save ${name}...`, false, -1);
            const autoTitle = await autoSummarize(state);
            if (autoTitle.success) {
                savedStates[autoTitle.content] = savedStates[name];
                if (name != autoTitle.content)
                    delete savedStates[name];
                showSaveLoadMessage(constants.text.states.saved(autoTitle.content), false, 5000);
                saveSavedStates();
                updateSaveMenu();
            } else
                showSaveLoadMessage(`Auto-title failed: ${autoTitle.content}`, true);
        }
    }

    /**
    * Deletes a saved state by name.
    * @param {string} name The name of the saved state to delete.
    */
    function deleteState(name) {
        delete savedStates[name];
        saveSavedStates();
        updateSaveMenu();
        showSaveLoadMessage(constants.text.states.deleted(name));
    }

    /**
    * Saves the current state to a quicksave slot.
    * @param {string} slot The quicksave slot number.
    */
    async function saveStateToLocalStorage(slot) {
        quickSaveSlots[slot] = serializeState();
        saveSavedStates();
        if(slot)
            showSaveLoadMessage(constants.text.states.slot.saved(slot));
    }

    /**
    * Loads a state from a quicksave slot.
    * @param {string} slot The quicksave slot number.
    */
    async function loadStateFromLocalStorage(slot) {
        if (quickSaveSlots[slot]) {
            await deserializeState(quickSaveSlots[slot]);
            showSaveLoadMessage(constants.text.states.slot.loaded(slot));
        } else if(slot || slot === 0) {
            showSaveLoadMessage(constants.text.states.slot.empty(slot));
        }
    }

    /**
    * Deletes a quicksave from a specified slot.
    * @param {string} slot The quicksave slot number.
    */
    function deleteQuickSave(slot) {
        if (!quickSaveSlots[slot]) {
            showSaveLoadMessage(constants.text.states.slot.empty(slot));
            return;
        }
        delete quickSaveSlots[slot];
        saveSavedStates();
        updateSaveMenu();
        showSaveLoadMessage(constants.text.states.slot.deletedQuicksave(slot));
    }

/******************** IMPORT-EXPORT ********************/

    /**
    * Exports all current settings and saved states to a JSON file.
    */
    function exportAll() {
        const exportData = {};
        const options = queryAll(".option").map(x=>x.getAttribute("id"));
        options.forEach(key => {
            exportData[key] = getLocal(key);
        });
        $inputs.objects.forEach(key => {
            exportData[key] = getLocal(key);
        });

        // Create and download the file
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /**
    * Imports settings and saved states from a JSON file.
    * @param {HTMLInputElement} input The file input element containing the JSON file.
    */
    async function importAll(input) {
        try {
            if (!input.files[0]) return;
            const text = await input.files[0].text();
            const importData = JSON.parse(text);
            if (!importData || typeof importData !== 'object')
                throw new Error('Invalid import data format');

            Object.entries(importData).forEach(([key, value]) => {
                if (value !== null && value !== undefined)
                    setLocal(key, value);
            });

            await $inputs.loadAllApiKeys();
            await $inputs.loadAllOptions();
            loadSavedStates();
            loadGlobalVariables();

            if (importData.snapshot)
                await deserializeState(importData.snapshot);

            showSaveLoadMessage(constants.text.import.success);
        } catch (error) {
            showSaveLoadMessage(constants.text.import.failure(error.message), true);
        } finally {
            input.value = '';
        }
    }

/******************** AUTO-SUMMARIZATION ********************/

    /**
     * Automatically generates a short title for a given conversation state using a summarization model.
     * @param {object|string} state - The conversation state to summarize, either as an object or a JSON string.
     * @returns {Promise<object>} - A promise that resolves to an object containing the success status and the generated title or error message.
     */
    async function autoSummarize(state) {
        if (typeof state == 'string') {
            try {
                state = JSON.parse(state);
            } catch (error) {
                return {success: false, content: "Invalid state"};
            }
        }
        const messages = state.data.messages.map(msg => ({
            role: msg.role,
            content: msg.content
        })).filter(msg => ['system', 'assistant', 'user', 'tool', 'developer'].includes(msg.role));

        const conversationStr = JSON.stringify(messages);
        if (getId('autoSummarizeLimit')?.checked) {
            const convLength = conversationStr.length;
            if (convLength > 100000) {
                return {success: false, content: constants.text.errors.conversationTooLong(convLength)};
            }
        }

        const fixString = (str) => { return (str ? str.charAt(0).toUpperCase() + str.slice(1) : '').replaceAll(/[\'\"\`\.#\n]/g, ''); };

        const systemPrompt = `
            # Instruction
            Please provide a 2 to 5 word description of the topic of the following conversation. This should be enough to identify the subject of the conversation, should not be excessively detailed, and should not include punctuation or markup notation.

            # Examples
            Incorrectly formatted: the topic is about the implications of climate change
            Correctly formatted: Implications of climate change

            Incorrectly formatted: how do I bake a cake?
            Correctly formatted: How to bake a cake

            Incorrectly formatted: Discussion about the plot of the Star Wars movies.
            Correctly formatted: Star Wars plot discussion

            Incorrectly formatted: evaluate \$\\int x\\sin(x^2) dx\$
            Correctly formatted: Integrating x sin x^2

            Remember, the description of the following conversation should be snappy, as short as feasibly possible, no more than 5 words but preferably closer to 2 or 3. Only output the description.`.trim().replaceAll(/\s{4,}/g, "");
        const payload = {
            messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: conversationStr }
            ],
            max_tokens: 9,
            temperature: 0.7,
            stream: false
        };

        if (getId('autoSummarizeGemini')?.checked) {
            const openrouterKey = getId('openrouterKey')?.value;
            if (!openrouterKey) {
                return {success: false, content: constants.text.errors.needOpenRouterKey("Gemini 1.5 Flash 8B")};
            }

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openrouterKey}`
                    },
                    body: JSON.stringify({
                        ...payload,
                        model: "google/gemini-flash-1.5-8b"
                    })
                });

                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                return {
                    success: true,
                    content: fixString(data.choices[0].message.content.trim())
                };
            } catch (error) {
                console.error("Gemini 1.5 Flash summarization failed:", error);
                return {
                    success: false,
                    content: "Gemini 1.5 Flash summarization failed: " + error.message
                };
            }
        }

        // Try Llama 3.2 3B if selected
        if (getId('autoSummarizeLlama3B')?.checked) {
            const openrouterKey = getId('openrouterKey')?.value;
            if (!openrouterKey) {
                return {success: false, content: constants.text.errors.needOpenRouterKey("Llama 3.2 3B")};
            }

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openrouterKey}`
                    },
                    body: JSON.stringify({
                        ...payload,
                        provider: {
                            order: ["Fireworks"]
                        },
                        model: "meta-llama/llama-3.2-3b-instruct"
                    })
                });

                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                return {
                    success: true,
                    content: fixString(data.choices[0].message.content.trim())
                };
            } catch (error) {
                console.error(constants.text.errors.summarizationFailed("Llama 3.2 3B", ""), error);
                return {
                    success: false,
                    content: constants.text.errors.summarizationFailed("Llama 3.2 3B", error.message)
                };
            }
        }
        // so only mini is left
        const openaiKey = getId('openaiKey')?.value;
        if (openaiKey) {
            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiKey}`
                    },
                    body: JSON.stringify({
                        ...payload,
                        model: "gpt-4o-mini"
                    })
                });

                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                return {
                    success: true,
                    content: fixString(data.choices[0].message.content.trim())
                };
            } catch (error) {
                console.error(constants.text.errors.summarizationFailed("OpenAI GPT-4o-mini", ""), error);
                return {
                    success: false,
                    content: constants.text.errors.summarizationFailed("OpenAI GPT-4o-mini", error.message)
                };
            }
        }
        // Try OpenRouter as fallback for mini
        const openrouterKey = getId('openrouterKey')?.value;
        if (openrouterKey) {
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openrouterKey}`
                    },
                    body: JSON.stringify({
                        ...payload,
                        model: "openai/gpt-4o-mini"
                    })
                });

                if (!response.ok)
                    throw new Error(await response.text());
                const data = await response.json();
                return {
                    success: true,
                    content: fixString(data.choices[0].message.content.trim())
                };
            } catch (error) {
                console.error(constants.text.errors.summarizationFailed("OpenRouter GPT-4o-mini", ""), error);
                return {
                    success: false,
                    content: constants.text.errors.OAIandORBothFailed("gpt-4o-mini")
                };
            }
        }

        return {
            success: false,
            content: constants.text.errors.OAIorORNeedKey("gpt-4o-mini")
        };
    }

/**               UI MANAGEMENT               **/

    /**
     * Adds event listeners to a message block for handling user interactions.
     * @param {HTMLElement} messageBlock - The message block element to which event listeners are added.
     */
    function addEventListeners(messageBlock) {
        const contentDiv = messageBlock.querySelector('.message-content');
        const controlDiv = messageBlock.querySelector('.message-control');
        contentDiv.addEventListener('click', async function(e) {
            await selectCell(this);
        });
        controlDiv.addEventListener('click', async function(e) {
            await selectCell(this.parentNode.querySelector('.message-content'));
        });
        contentDiv.ondblclick = async function(e) {
            if (!editMode)
                await enterEditMode(this);
        };
        contentDiv.onlostpointercapture = async function() {
            await exitEditMode(this);
        };
    }

    /**
     * Disables buttons that should not be active during certain operations.
     */
    function disableButtons() {
        completionLockedButtons.forEach(button => {
                if ( !(
                    getId("generateInNewBlock") &&
                    ["chatCompletionBtn", "textCompletionBtn"].includes(button)
                )) {
                    getId(button).disabled = true;
                }
        });
        completionShownButtons.forEach(button => {getId(button).style.display = 'inline-block';});
    }

    /**
     * Enables buttons that were previously disabled.
     */
    function enableButtons() {
        completionLockedButtons.forEach(button => {getId(button).disabled = false;});
        completionShownButtons.forEach(button => {getId(button).style.display = 'none';});
    }

    /**
     * Stops the current completion process and resets the UI state.
     */
    async function stopCompletion(destination=null) {
        if (destination === null) {
            queryAll(".generating").forEach(dest => stopCompletion(dest));
            return;
        }
        if (destination.controller) {
            destination.controller.abort();
            destination.controller = null;
        }
        enableButtons();
        destination.classList.remove("generating");
    }

    /**
     * Toggles the visibility of the settings container.
     */
    function toggleSettings() {
        getId('settings-container')?.classList?.toggle('expanded');
    }

    /**
     * Adds a new message to the chat interface.
     * @param {string} role - The role of the message (e.g., "user", "assistant").
     * @param {string} content - The content of the message.
     * @param {object} options - Additional options for the message.
     * @param {boolean} doSnapshot - Whether to take a snapshot of the current state.
     * @returns {Promise<HTMLElement>} - A promise that resolves to the newly created message block element.
     */
    async function addMessage(role = "user", content = "new message", options = {}, doSnapshot = true, after = null) {
        if(doSnapshot)
            snapshotState();
        if (role == "output") {
            const outputBlock = getId("outputs")?.querySelector(".output");
            const messageBlock = await addMessage("assistant",
                outputBlock.getAttribute('content') || outputBlock.textContent,
                Object.fromEntries(
                    $inputs.attributes.messages.map((attr) => [
                        attr,
                        outputBlock.getAttribute(attr) || ''
                    ])
                ),
            false);
            outputBlock.innerHTML = "";
            $inputs.attributes.messages.forEach((attr) => {
                outputBlock.setAttribute(attr, '')
            });
            return messageBlock;
        }
        const messagesDiv = getId('messages');
        const messageBlock = constants.html.messageBlock(
            {
                ...Object.fromEntries(
                    $inputs.attributes.messages.map((attr) => [
                        attr,
                        options[attr] || '',
                    ])
                ),
                ...{
                    role,
                    content,
                }
            }
        );
        if (after && after?.classList.contains("message-row")) {
            const messageRow = constants.html.messageRow();
            messageRow.appendChild(messageBlock);
            after.after(messageRow);
            return messageBlock;
        }
        if (after && after?.classList.contains("message-block")) {
            after.after(messageBlock);
            return messageBlock;
        }
        if (after && after?.classList.contains("message-content")) {
            after.closest(".message-block").after(messageBlock);
            return messageBlock;
        }
        const messageRow = constants.html.messageRow();
        messageRow.appendChild(messageBlock);
        messagesDiv.appendChild(messageRow);
        return messageBlock;
    }

    /**
     * Creates a button element with specified content and click handler.
     * @param {string} content - The inner HTML content of the button.
     * @param {Function} onClick - The function to execute when the button is clicked.
     * @param {string[]} classes - An array of class names to apply to the button.
     * @returns {HTMLButtonElement} - The created button element.
     */
    function createButton(content, onClick, classes = ['control-button']) {
        const button = document.createElement('button');
        for (let className of classes) {
            button.classList.add(className);
        }
        button.innerHTML = content;
        button.onclick = onClick;
        return button;
    }

    /**
     * Clears the output area of the chat interface.
     */
    function clearOutput() {
        getId('outputs').querySelector(".output").textContent = '';
    }

    /**
     * Resets all input fields and settings to their default values.
     */
    function resetToDefaults() {
        // Reset all input fields
        const inputs = document.getElementsByTagName('input');
        for (let input of inputs) {
            if (input.type === 'text' || input.type === 'number')
                input.value = '';
            else if (input.type === 'checkbox')
                input.checked = false;
        }
        getId('outputs').querySelector(".output").textContent = '';
        Object.entries($inputs.defaults).forEach(([key, value]) => {
            getId(key)[(typeof value === 'boolean') ? 'checked' : 'value'] = value;
        });
    }

/**                CONTROLS HANDLING                **/

    /**
     * Toggles the 'condensed' class on a message content div, visually indicating whether the message is condensed or not.
     * @param {HTMLElement} contentDiv - The message content div to toggle.
     * @param {HTMLElement} button - The button element associated with the toggle.
     * @param {boolean} reset - Whether to force a specific state (true for condensed, false for not condensed).
     */
    function toggleCondense(contentDiv, button, reset = false) {
        if (!reset) contentDiv.classList.toggle('condensed');
        if (button) {
            button.innerHTML = contentDiv.classList.contains('condensed') ?
                constants.symbols.chevronsUpDown :
                constants.symbols.chevronsDownUp;
        }
    }

    /**
     * Toggles the 'disabled' class on a message content div, visually indicating whether the message is enabled or disabled.
     * @param {HTMLElement} contentDiv - The message content div to toggle.
     * @param {HTMLElement} button - The button element associated with the toggle.
     * @param {boolean} reset - Whether to force a specific state (true for disabled, false for enabled).
     */
    function toggleEnable(contentDiv, button, reset = false) {
        snapshotState();
        if (!reset) contentDiv.classList.toggle('disabled');
        if (button) {
            button.innerHTML = contentDiv.classList.contains('disabled') ?
                constants.symbols.eyeOff :
                constants.symbols.eye;
        }
        updateTokenCost();
    }

    /**
     * Toggles the 'collapsed' class on a message content div, hiding or showing the message content.
     * @param {HTMLElement} contentDiv - The message content div to toggle.
     * @param {HTMLElement} button - The button element associated with the toggle.
     * @param {boolean} reset - Whether to force a specific state (true for collapsed, false for uncollapsed).
     */
    function toggleCollapse(contentDiv, button, reset = false) {
        if (!reset)
            contentDiv.classList.toggle('collapsed');
        if (button) {
            button.innerHTML = contentDiv.classList.contains('collapsed') ?
                constants.symbols.chevronDown :
                constants.symbols.chevronUp;
        }
    }

    /**
     * Selects a cell in the chat interface, visually highlighting it and deselecting any previously selected cell.
     * @param {HTMLElement} cell - The cell element to select.
     */
    async function selectCell(cell) {
        if (!queryAll('.message-content').length || !cell || selectedCell == cell)
            return;
        if (cell.classList.contains('message-block') || cell.classList.contains('message-row'))
            return selectCell(cell.querySelector('.message-content'));
        await exitEditMode();
        if (selectedCell) {
            selectedCell.classList.remove('selected');
            selectedCell.removeAttribute('contenteditable');
        }
        selectedCell = cell;
        queryAll('.selected').forEach(el => el.classList.remove('selected'));
        selectedCell.classList.add('selected');
        updateTextTokenCost(); // Update text token cost when a new cell is selected
    }

    /**
     * Cycles the role of a message content div, changing its role to the next role in the sequence (system, user, assistant, comment).
     * @param {HTMLElement} cell - The message content div to cycle.
     * @param {boolean} reverse - If true, cycles the role in reverse order.
     */
    function cycleRole(cell, reverse = false) {
        const roles = ['system', 'user', 'assistant', 'comment'];
        const currentIndex = roles.indexOf(cell.getAttribute('role'));
        const nextIndex = (currentIndex + roles.length + (reverse ? 1 : -1)) % roles.length;
        cell.setAttribute('role', roles[nextIndex]);
        const roleButton = cell.previousElementSibling.querySelector('.role-button');
        roleButton.textContent = roles[nextIndex];
        roleButton.dataset.role = roles[nextIndex];
    }

    /**
     * Moves a node in the DOM, either up or down relative to its siblings.
     * @param {HTMLElement} node - The node to move.
     * @param {string} direction - The direction to move the node ('up' or 'down').
     */
    function moveNode(node, direction) {
        snapshotState();
        if (node.classList.contains('message-content') || node.classList.contains('message-control') || node.classList.contains('message-block')) {
            return moveNode(tree.parent(node), direction);
        }
        if (node.classList.contains('message-content') || node.classList.contains('message-control')) {
            return moveNode(tree.parent(node), direction);
        }
        const parent = node.parentNode;
        const sibling = (direction === 'up' ? tree.prev : tree.next)(node);
        if (sibling) {
            if (direction === 'up') {
                parent.insertBefore(node, sibling);
            } else {
                parent.insertBefore(sibling, node);
            }
        }
    }

    /**
     * Moves a node to the extreme top or bottom of its parent.
     * @param {HTMLElement} node - The node to move.
     * @param {string} position - The position to move the node to ('top' or 'bottom').
     */
    function moveNodeToExtreme(node, position) {
        snapshotState();
        if (node.classList.contains('message-content') || node.classList.contains('message-control') || node.classList.contains('message-block')) {
            return moveNodeToExtreme(tree.parent(node), position);
        }
        const parent = node.parentNode;
        if (position === 'top') {
            parent.insertBefore(node, parent.firstChild);
        } else {
            parent.appendChild(node);
        }
    }

    /**
     * Joins the content of two nodes, either appending the content of the selected cell to the previous cell, or vice versa.
     * @param {HTMLElement} cell - The selected cell.
     * @param {boolean} up - If true, appends the content of the selected cell to the previous cell; otherwise, appends the content of the next cell to the selected cell.
     */
    async function joinNodes(cell, up) {
        snapshotState();
        const messageBlock = cell.closest('.message-block');
        const targetBlock = up ? messageBlock.previousElementSibling : messageBlock.nextElementSibling;

        if (!targetBlock) {
            if (!up && getId('outputs')?.querySelector(".output")?.innerHTML?.trim()) {
                const spacing = cell.innerHTML.match(/\s*$/)[0];
                cell.innerHTML += spacing + getId('outputs')?.querySelector(".output")?.innerHTML;
                await updateTokenCount(cell, true);
            }
            return;
        }

        const targetCell = targetBlock.querySelector('.message-content');
        const spacing = up ? targetCell.textContent.match(/\s*$/)[0] : cell.textContent.match(/\s*$/)[0];

        if (up) {
            targetCell.innerHTML += spacing + cell.innerHTML;
            messageBlock.remove();
            await selectCell(targetCell);
        } else {
            cell.innerHTML += spacing + targetCell.innerHTML;
            targetBlock.remove();
        }

        await updateTokenCount(up ? targetCell : cell, true);
        updateTokenCost();
    }

    /**
     * Deletes a cell from the chat interface.
     * @param {HTMLElement} cell - The cell to delete.
     */
    async function deleteCell(cell) {
        if (!cell)
            return console.log("no cell selected for deletion");
        snapshotState();

        const messageBlock = cell.closest('.message-block');
        let block = messageBlock;
        if (messageBlock.parentNode.classList.contains('message-row')) {
            block = messageBlock.parentNode;
        }

        if (block.previousElementSibling.querySelector('.message-content')) {
            await selectCell(Array.from(block.previousElementSibling.querySelectorAll('.message-content')).slice(-1)[0]);
        } else if (block.nextElementSibling.querySelector('.message-content')) {
            await selectCell(Array.from(block.nextElementSibling.querySelectorAll('.message-content'))[0]);
        }

        messageBlock.remove();
        if (block !== messageBlock && block.querySelectorAll('.message-content').length === 0) {
            block.remove();
        }
        updateTokenCost();
    }

    /**
     * Enters edit mode for a cell, allowing the user to modify its content.
     * @param {HTMLElement} cell - The cell to enter edit mode for.
     */
    async function enterEditMode(cell) {
        snapshotState();
        if (cell.classList.contains('message-block'))
            return enterEditMode(cell.querySelector('.message-content'));
        await selectCell(cell);
        cell.innerText = cell.getAttribute('content') || buildText(cell);
        editMode = true;
        cell.contentEditable = true;
        cell.classList.add("editing");
        cell.classList.remove("collapsed");  // trying to edit collapsed blocks messes up whitespace when they're rendered while being collapsed again
        cell.focus();
    }

    /**
     * Exits edit mode for a cell, saving any changes made by the user.
     * @param {HTMLElement} cell - The cell to exit edit mode for.
     */
    async function exitEditMode(cell = null) {
        editMode = false;
        let cur = cell ? [cell] : document.getElementsByClassName("editing");
        for (let i = 0; i < cur.length; i++) {
            const elem = cur[i];
            elem.contentEditable = false;
            elem.classList.remove("editing");
            elem.setAttribute('content', elem.innerText);
            elem.innerHTML = renderMarked(elem.innerText);
            renderMath(elem);
            hljs.highlightAll();
            await updateTokenCount(elem, true);
        }
        snapshotState();
    }

    document.addEventListener('keydown', async function(e) {
        didLastSave = false;
        let block;
        if (!selectedCell) {
            await selectCell(query('.selected') || query('.message-content'));
            return;
        }

        let textElements = ["INPUT", "DIV", "TEXTAREA"];
        if (e.key === 'Tab' && !editMode && !textElements.includes(e.target.nodeName)) {
            e.preventDefault();
            toggleClass('#left-column', 'hidden');
            toggleClass('#middle-column', 'full-width');
            updateTokenCost();
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
            if (!editMode && query(".editing") === null) {
                e.preventDefault();
                let thisState = serializeState();
                let lastState;
                while (stateHistory.length > 0 && (lastState == null || lastState == thisState)) {
                    lastState = stateHistory.pop();
                }
                if(lastState) {
                    await deserializeState(lastState);
                }
            }
        }
        if (!editMode && query(".editing") === null && !(textElements.includes(e.target.nodeName))) {
            let up = (e.key == 'ArrowUp');
            let roleLetters = {
                "s": "system",
                "d": "user",
                "u": "user",
                "a": "assistant",
                "c": "comment",
                "f": "output"
            };
            // shift is pressed
            if (e.shiftKey) {
                switch (e.key) {
                    // shift + vertical arrow: move row up or down
                    case 'ArrowUp':
                    case 'ArrowDown':
                        e.preventDefault();
                        if (e.altKey) {
                            // shift + alt + arrow: join message
                            joinNodes(selectedCell, up);
                        } else {
                            // shift + arrow: move message
                            moveNode(selectedCell, up ? 'up' : 'down');
                        }
                        break;

                    // shift + horizontal arrow: move message within or across rows
                    case 'ArrowLeft':
                    case 'ArrowRight':
                        block = selectedCell.closest('.message-block');
                        let direction = e.key == 'ArrowLeft' ? 'left' : 'right';
                        let row = block.closest('.message-row');
                        e.preventDefault();
                        if (direction == 'left') {
                            if (block.previousElementSibling) {
                                block.parentNode.insertBefore(block, block.previousElementSibling);
                            } else if (row.previousElementSibling &&  !block.nextElementSibling) {
                                row.previousElementSibling.appendChild(block);
                            } else if (block.nextElementSibling) {
                                row.parentNode.insertBefore(constants.html.messageRow(), row);
                                row.previousElementSibling.appendChild(block);
                            }
                            if (row.children.length == 0) {
                                row.remove();
                            }
                        } else {
                            if (block.nextElementSibling) {
                                block.parentNode.insertBefore(block.nextElementSibling, block);
                            } else if (row.nextElementSibling && !block.previousElementSibling) {
                                row.nextElementSibling.prepend(block);
                            } else if (block.previousElementSibling) {
                                let newRow = constants.html.messageRow();
                                row.parentNode.insertBefore(newRow, row);
                                row.parentNode.insertBefore(row, newRow);
                                row.nextElementSibling.appendChild(block);
                            }
                            if (row.children.length == 0) {
                                row.remove();
                            }
                        }
                        break;

                    // shift + letter: set role directly
                    case 'S': case 'D': case 'U': case 'A': case 'C':
                        selectedCell.setAttribute('role', roleLetters[e.key.toLowerCase()]);
                        break;

                    // shift + backslash (= pipe): generate text
                    case '|':
                        await generate('text');
                        break;

                    // shift + space: condense/expand message
                    case ' ':
                        toggleCondense(selectedCell, selectedCell.previousElementSibling.querySelector('.condense-button'));
                        break;

                    // shift + num: load quicksave
                    case '!': case '@': case '#': case '$': case '%': case '^': case '&': case '*': case '(': case ')':
                        e.preventDefault();
                        const selectedSlot = {
                            '!':1, '@':2, '#':3, '$':4, '%':5, '^':6, '&':7, '*':8, '(':9, ')':0
                        }[e.key];
                        await loadStateFromLocalStorage(selectedSlot);
                        break;
                }
            // shift is not pressed, alt is pressed
            } else if (e.altKey) {
                switch (e.key) {
                    // alt + up/down: collapse/reveal message
                    // (there's no real difference between up and down here; either way, you're toggling the collapse state)
                    case 'ArrowUp':
                        e.preventDefault();
                        toggleCollapse(selectedCell, reset=true);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        toggleCollapse(selectedCell, reset=false);
                        break;
                }
            // ctrl or meta (win/cmd/super) is pressed
            } else if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    // ctrl + arrow: move cell to top/bottom
                    case 'ArrowUp': case 'ArrowDown':
                        e.preventDefault();
                        moveNodeToExtreme(selectedCell, e.key == 'ArrowUp' ? 'top' : 'bottom');
                        break;

                    // ctrl + num: delete quicksave
                    case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9': case '0':
                        e.preventDefault();
                        await deleteQuickSave(e.key);
                }
            // no modifiers are pressed
            } else {
                switch (e.key) {
                    // vertical arrow: select cell above/below (move cursor)
                    case 'ArrowUp':
                        e.preventDefault();
                        block = selectedCell.closest('.message-block');
                        if (block.previousElementSibling) {
                            await selectCell(block.previousElementSibling);
                        } else if (block.parentElement.previousElementSibling) {
                            await selectCell(block.parentElement.previousElementSibling.lastElementChild);
                        } else {
                            await selectCell(tree.safePrev(block));
                        }
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        block = selectedCell.closest('.message-block');
                        if (block.nextElementSibling) {
                            await selectCell(block.nextElementSibling);
                        } else if (block.parentElement.nextElementSibling) {
                            await selectCell(block.parentElement.nextElementSibling.firstElementChild);
                        } else {
                            await selectCell(tree.safeNext(block));
                        }
                        break;

                    // horizontal arrow: cycle role
                    case 'ArrowLeft': case 'ArrowRight':
                        e.preventDefault();
                        cycleRole(selectedCell, e.key == 'ArrowLeft');
                        break;

                    // backspace: delete cell
                    case 'Backspace':
                        e.preventDefault();
                        await deleteCell(selectedCell);
                        break;

                    // space: toggle enable
                    case ' ':
                        e.preventDefault();
                        toggleEnable(selectedCell, selectedCell.previousElementSibling.querySelector('.enable-button'));
                        break;

                    // enter: edit cell
                    case 'Enter':
                        e.preventDefault();
                        enterEditMode(selectedCell);
                        break;

                    // letter: add message of given role
                    // it works pretty mnemonically: a = assistant, u = user, s = system, c = comment
                    // d also stands in for user, to fill out the home row, and f is just next to d
                    case 's': case 'd': case 'u': case 'a': case 'c': case 'f':
                        await addMessage(
                            roleLetters[e.key],
                            constants.text.roleDefaults[roleLetters[e.key]],
                            {author: '', label: ''}
                        );
                        updateTokenCost();
                        break;

                    // backslash: generate chat
                    case '\\':
                        await generate('chat');
                        break;

                    // num: save quicksave
                    case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9': case '0':
                        e.preventDefault();
                        await saveStateToLocalStorage(e.key);
                }
            }
        } else {
            if (editMode && e.key == "Enter" && !e.shiftKey) {
                event.preventDefault();
                document.execCommand("insertLineBreak");
            }
            if (e.key === 'Escape') {
                editMode = false;
                await exitEditMode(selectedCell);
            }
        }
    });

/**                GENERATION                **/

    /**
     * Retrieves the API key and base URL for a given provider.
     * @param {string} provider - The name of the provider.
     * @returns {{key: string|null, url: string|undefined}} - An object containing the API key and base URL.
     */
    function getApiKeyAndUrl(provider) {
        const key = getId($inputs.providerKeyId(provider))?.value;
        if (!key) {
            return { key: null, url: $models?.providerBaseURLs[provider] };
        }
        let url;
        if (key === $inputs.providerKeyId("Custom")) {
            url = getId("customUrl")?.value;
        } else {
            url = $models.providerBaseURLs[provider];
        }
        return { key, url };
    }

    /**
     * Substitutes variables in a text string with their corresponding values.
     * @param {string} text - The text string to substitute variables in.
     * @returns {Promise<string>} - The text string with variables substituted.
     */
    async function substituteVariables(text) {
        const activeVars = getActiveVariables();
        activeVars.forEach(([key, value]) => {
            const pattern = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
            text = text.replace(pattern, value);
        });

        // Replace URL variables
        const urlPattern = /\{\{(https?:\/\/[^\}]+)\}\}/g;
        let match;
        while ((match = urlPattern.exec(text)) !== null) {
            const [urlVar, url] = match;
            let urlContents;
            try {
                urlContents = await getContents(url);
                urlContents = "\n```\n" + urlContents + "\n```\n";
            } catch (e) {
                urlContents = urlVar;
                console.log(`Could not get contents of ${url}: `, e);
            }
            text = text.replace(urlVar, urlContents);
        }
        return text;
    }

    /**
     * Forms a message object from a message content div.
     * @param {HTMLElement} contentDiv - The message content div to form the message object from.
     * @returns {Promise<{role: string, content: string, name?: string}|null>} - A message object containing the role, content, and optional name of the message.
     */
    async function formMessageObject(contentDiv) {
        if (contentDiv?.classList.contains("message-block")) {  // we were given the block, so pick out the content div
            return formMessageObject(contentDiv.querySelector(".message-content"));
        }
        const validRoles = ["system", "developer", "assistant", "user", "tool"];
        const role = contentDiv.getAttribute('role');
        if (contentDiv.classList.contains('disabled') || !validRoles.includes(role)) {
            return null;
        }
        let content = contentDiv.getAttribute('content') || buildText(contentDiv);
        content = await substituteVariables(content);
        let msgContent = content;

        let objectRx = /\{\{(ima?ge?|audio|file)[^a-zA-Z0-9](https?:\/\/[^\}]+)\}\}/g;
        let objectList = Array.from(content.matchAll(objectRx));
        if (objectList) {
            msgContent = [];
            for (let [match, objType, objData] of objectList) {
                console.log(match, objType, objData);
                let i = content.indexOf(match);
                let textData = content.slice(0, i);
                content = content.slice(i + match.length);
                if (textData)
                    msgContent.push({type: 'text', text: textData});
                if (!['img', 'image'].includes(objType))
                    continue;  // not supporting file and audio just yet
                msgContent.push({type: 'image_url', image_url: {url: objData}});
            }
            if (content) {
                msgContent.push({type: 'text', text: content});
                if (msgContent.length == 1)
                    msgContent = content;
            }
        }

        const msgObj = { role, content: msgContent };
        const name = contentDiv.getAttribute("name") || "";
        if (name.trim() != "" && ["system", "developer", "user"].includes(role)) {
            msgObj.name = name.trim();
        }
        const label = contentDiv.getAttribute("label");
        if (label && role == "tool") {
            msgObj.tool_call_id = label;
        }
        return msgObj;
    }

    /**
     * Gets the destination element for generated text.
     * @returns {HTMLElement} - The destination element.
     */
    async function getDestination(data={}) {
        let destination = getId('outputs')?.querySelector(".output");
        if (getId('generateAtSelected')?.checked) {
            destination = query('.selected').querySelector(".message-content") || query('.selected') || destination;
            if (destination.innerHTML.trim() !== "") {
                destination.innerHTML = "";
            }
        }
        if (getId('generateInNewBlock')?.checked && data?.modelKey) {
            const current = queryAll(".generating.message-content");
            let after = null;
            if (current.length > 0) {
                after = current[current.length - 1];
            }
            const msgBlock = await addMessage(
                "assistant",
                "",
                {author: data?.modelKey},
                doSnapshot = false,
                after = after,
            );
            destination = MsgBlock.get.contentDiv(msgBlock);
        }
        return destination;
    }

    /**
     * Generates text using a specified model type (chat or text).
     * @param {string} modelType - The type of model to use ('chat' or 'text').
     * @param {string} [model=null] - The specific model to use (optional).
     */
    async function generate(modelType, model = null) {
        const isChat = modelType === 'chat';
        const isFim = modelType === 'fim';
        if (isFim) {
            modelType = 'text';
        }
        let realModelType = modelType;
        let modelKey = model;
        if (!modelKey) {
            modelKey = getId('model' + (isChat ? 'Chat' : 'Text')).value;
            if (modelType == 'textwchat') {
                modelKey = getId('modelChat').value;
                modelType = 'text';
                realModelType = 'chat';
            }
        }

        let destination = await getDestination({modelKey});
        if (destination.classList.contains("generating")) {
            console.log(constants.text.generationInProgress);
            return;
        }
        destination.classList.add("generating");
        disableButtons();

        let customModel = null;

        const info = $models[realModelType][modelKey];
        const { key, url } = getApiKeyAndUrl(info.provider);
        let corsProxy = getId('corsProxy')?.value;
        if (corsProxy && !corsProxy.endsWith('?')) {
            corsProxy += '?';
        }
        const corsProviders = ["mistral_text", "sambanova", "anthropic"];
        const proxiedUrl = (corsProviders.includes(info.provider.toLowerCase()) ? corsProxy : '') + url;
        let output = '';
        if (destination.innerHTML.trim() !== "") {
            destination.setAttribute('content', '');
            destination.innerHTML = "";
        }

        if (getId('useCustomModel')?.checked && getId('customModel')?.value) {
            customModel = getId('customModel')?.value;
        } else {
            customModel = null;
        }
        if (!key && info.provider != 'none') {
            destination.setAttribute('content', constants.text.enterAPIKey(info.provider));
            destination.innerHTML = renderMarked(constants.text.enterAPIKey(info.provider));
            stopCompletion(destination);
            return;
        }
        try {
            let endpoint;
            if (isChat) {
                endpoint = '/chat/completions';
            } else {
                endpoint = '/completions';
                if (info.provider == 'Mistral_Text' && isFim) {
                    endpoint = '/fim/completions';
                }
            }

            const maxTokensRaw = getId('maxTokens' + (isChat ? 'Chat' : 'Text')).value;
            let maxTokens = parseInt(maxTokensRaw);
            if (maxTokensRaw.endsWith('%')) {
                const maxTokensPercent = parseInt(maxTokensRaw.slice(0, -1));
                const maxTokensMax = info.max.out;
                maxTokens = Math.round(maxTokensMax * maxTokensPercent / 100);
            } else if (maxTokensRaw == "auto" || maxTokensRaw == "" || maxTokensRaw == "max") {
                maxTokens = info.max.out;
            } else {
                maxTokens = parseInt(maxTokensRaw);
            }
            let idParams = {
                // temperature: parseFloat(getId('temperature')?.value),
                // top_p: parseFloat(getId('top_p')?.value),
                // top_k: parseInt(getId('top_k')?.value),
                // frequency_penalty: parseFloat(getId('frequency_penalty')?.value),
                // presence_penalty: parseFloat(getId('presence_penalty')?.value),
                // repetition_penalty: parseFloat(getId('repetition_penalty')?.value),
                // seed: parseInt(getId('seed')?.value),
            };
            ["temperature", "top_p", "top_k", "frequency_penalty", "presence_penalty", "repetition_penalty", "seed"].forEach(param => {
                let value = getId(param)?.value;
                if (value && value.trim() !== "") {
                    try {
                        if (["top_k", "seed"].includes(param)) {
                            idParams[param] = parseInt(value);
                        } else {
                            idParams[param] = parseFloat(value);
                        }
                    } catch (e) {
                        console.log(`Error parsing ${param}: ${e}`);
                    }
                }
            });
            const payload = {
                ...(info?.defaults || {}),
                ...{
                    model: customModel || modelKey,
                    max_tokens: maxTokens,
                    stream: getId('streaming')?.checked,
                    ...idParams,
                },
                ...JSON.parse(getId('otherParams')?.value || '{}')
            };
            if (["o4-mini", "o3", "o3-mini", "o1", "o1-mini"].includes(payload.model)) {
                // max_tokens isn't supported, change to max_completion_tokens
                payload.max_completion_tokens = maxTokens;
                payload.max_tokens = undefined;
                payload.temperature = undefined;
                payload.top_p = undefined;
                payload.top_k = undefined;
                payload.frequency_penalty = undefined;
                payload.presence_penalty = undefined;
                payload.repetition_penalty = undefined;
                payload.reasoning_effort = "high";
            }

            if (isChat) {
                const messageElements = queryAll('#messages div.message-content:not(.disabled)');
                const messageObjects = [];

                for (const el of messageElements) {
                    if (el.classList.contains("generating")) {
                        break; // blocks in generation, and anything after them, shouldn't be added
                    }
                    const msgObj = await formMessageObject(el);
                    if (info.extra && info.extra.includes("developer")) {
                        if (msgObj.role == "system")
                            msgObj.role = "developer";
                    }
                    if (msgObj && msgObj.content) {
                        messageObjects.push(msgObj);
                    }
                }
                const lastMsg = messageObjects[messageObjects.length - 1];
                if (lastMsg.content == constants.text.roleDefaults[lastMsg.role]) {
                    destination.setAttribute(content, constants.text.errors.removeDefaultMessages);
                    destination.innerHTML = constants.text.errors.removeDefaultMessages;
                    stopCompletion(destination);
                    return;
                }
                if (lastMsg.role == "assistant" && info.provider.toLowerCase().includes("deepseek")) {
                    lastMsg.prefix = true;  // deepseek wants you to indicate whether a final assistant message should be treated as a prefix
                }
                payload.messages = messageObjects;
            } else {
                const selectedMessage = query('.selected');
                const msgObj = await formMessageObject(selectedMessage);
                payload.prompt = msgObj ? msgObj.content : '';
                if (!payload.prompt) {
                    destination.setAttribute('content', constants.text.errors.noPrompt);
                    destination.innerHTML = renderMarked(constants.text.errors.noPrompt);
                    stopCompletion(destination);
                    return;
                }
                console.log(payload);
                if (isFim) {
                    const enabledBlocks = queryAll(".message-block:not(:has(.disabled))");
                    let selectionIndex = Object.entries(enabledBlocks).findIndex(([i, block]) => block.querySelector(".selected"));
                    if (selectionIndex == -1) {
                        destination.setAttribute('content', constants.text.errors.noSelection);
                        destination.innerHTML = renderMarked(constants.text.errors.noSelection);
                        stopCompletion(destination);
                        return;
                    }
                    if (selectionIndex == enabledBlocks.length - 1) {
                        destination.setAttribute('content', constants.text.errors.fimNoSuffix);
                        destination.innerHTML = renderMarked(constants.text.errors.fimNoSuffix);
                        stopCompletion(destination);
                        return;
                    }
                    const suffixBlock = enabledBlocks[selectionIndex + 1];
                    console.log(suffixBlock);
                    const suffixObj = await formMessageObject(suffixBlock.querySelector(".message-content"));
                    payload.suffix = suffixObj ? suffixObj.content : "";
                    if (payload.suffix == "") {
                        destination.setAttribute('content', constants.text.errors.fimNoSuffix);
                        destination.innerHTML = renderMarked(constants.text.errors.fimNoSuffix);
                        stopCompletion(destination);
                        return;
                    }
                }
            }
            // const outputDivs = queryAll('.output:not(.locked)');
            // outputDivs.forEach(outputDiv => {
            //     outputDiv.innerText = '';
            // });

            if (info.provider == "none") {
                if (modelKey == "echo") {
                    destination.setAttribute('content', JSON.stringify(payload));
                    destination.innerHTML = renderMarked(JSON.stringify(payload));
                    return;
                } else if (modelKey == "none") {
                    return;
                }
            }
            destination.controller = new AbortController();
            const signal = destination.controller.signal;

            if (getId('streaming')?.checked) {
                const response = await fetch(proxiedUrl + endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify(payload),
                    signal: signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let reasoning = false;
                let reasoningBlock = null;
                while (true) {
                    const { done, value } = await reader.read();
                    if (done)
                        break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    let next = '';
                    for (const line of lines) {
                        if (line.startsWith('data:') && line.trim() !== 'data: [DONE]') {
                            try {
                                next = '';
                                const data = JSON.parse(line.slice(5));

                                if (data?.choices && data.choices[0]) {

                                    if (data.choices[0].delta !== undefined && Object.keys(data.choices[0].delta).length == 0) {
                                        data.choices[0].delta = {"content": ""};
                                    }
                                    if (data.choices[0]?.delta?.content != undefined) {
                                        next = data.choices[0].delta.content;
                                        reasoning = false;
                                    }
                                    else if (data.choices[0]?.delta?.reasoning_content) {
                                        next = data.choices[0].delta.reasoning_content;
                                        if (!reasoning) {
                                            reasoningBlock = await addMessage(
                                                "comment",
                                                "",
                                                {label: "Chain of Thought", author: modelKey},
                                                doSnapshot=false
                                            );
                                            console.log(reasoningBlock);
                                        }
                                        reasoning = true;
                                    }
                                    else if (data.choices[0]?.text) {
                                        next = data.choices[0].text;
                                    }
                                } else if (data?.text) {
                                    next = data.text;
                                }
                                if (!reasoning) {
                                    output += next || '';
                                } else {
                                    //process.stdout.write(next || '');
                                    if (reasoningBlock) {
                                        // console.log(next);
                                        MsgBlock.set.text(reasoningBlock, MsgBlock.get.text(reasoningBlock) + next || '');
                                        // console.log(MsgBlock.get.text(reasoningBlock));
                                        MsgBlock.set.content(reasoningBlock, MsgBlock.get.content(reasoningBlock) + next || '');
                                        // console.log(MsgBlock.get.content(reasoningBlock));
                                    }
                                }
                                if (data?.usage) {
                                    const completion_tokens = data.usage.completion_tokens;
                                    if (completion_tokens && completion_tokens > 0) {
                                        await updateTokenCount(destination, false, completion_tokens);
                                    }
                                }

                                if (!destination.classList.contains("selected")) {
                                    destination.scrollTop = destination.scrollTopMax;
                                }

                                // unprincipled hack to make models output parseable latex
                                [
                                    [/\n\$\$\n(.*?)\n\$\$\n/g, "\n$$$$$1$$$$\n"],
                                    [/\n\$ /g, "\n$$"],
                                    [/ \$\n/g, "$$\n"],
                                    [/\n\s*\\\[\s/g, "\n$$$$"],
                                    [/\s\\\]\s*\n/g, "$$$$\n"],
                                    [/\s*\\\(\s/g, " $$"],
                                    [/\s\\\)\s*/g, "$$ "],
                                    [/\\\(\s*/g, " $$"],
                                    [/\s*\\\)/g, "$$ "],
                                ].forEach(([fst, snd]) => {output = output.replaceAll(fst, snd)});
                                // output = output.replaceAll(/\n\$\$\n(.*?)\n\$\$\n/g, "\n$$$$$1$$$$\n");
                                // output = output.replaceAll(/\n\$ /g, "\n$$");
                                // output = output.replaceAll(/ \$\n/g, "$$\n");
                                destination.innerHTML = renderMarked(output);
                                renderMath(destination);
                            } catch (error) {
                                // If there's an error parsing JSON, attempt to salvage its content field, appending the raw line upon failure
                                if (line.trim() !== '') {
                                    console.log("Incomplete event data: " + line);
                                    let content = '\n```\n' + line.slice(5) + '\n```\n';
                                    const salvageIdx = line.search(/"content":/);
                                    if (salvageIdx !== -1) {
                                        content = line.slice(salvageIdx + '"content":'.length);
                                        content = content.slice(content.search('"'));
                                        const endIdx = content.search(/[^\\]"/);
                                        if (endIdx !== -1) {
                                            content = content.slice(1, endIdx + 1);
                                            console.log("Salvaged content field as: " + content);
                                        } else {
                                            console.log("Incompletely salvaged content field as: " + content);
                                        }
                                    } else {
                                        console.log("Could not salvage content field; appending raw line.");
                                    }
                                    // output += content;
                                    destination.innerHTML = renderMarked(output);
                                    renderMath(destination);
                                }
                            }
                        }
                    }
                }
            } else {
                const response = await fetch(proxiedUrl + endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify(payload),
                    signal: signal
                });
                const data = await response.json();
                if (info.provider != "Custom") {
                    output = isChat ?
                        data.choices[0].message.content :
                        data.choices[0].text;
                } else
                    output = data;
                destination.setAttribute('content', output);
                destination.innerHTML = renderMarked(output);
                renderMath(destination);
                hljs.highlightAll();
            }

        } catch (error) {
            if (error.name === 'AbortError') {
                output += '\n\n' + constants.text.generationStopped;
            } else {
                console.log(error);
                output = constants.text.errors.generic(error.message);
            }
        } finally {
            stopCompletion(destination);
            destination.controller = null;
        }
        destination.setAttribute("content", output);
        destination.setAttribute("author", modelKey);
        destination.setAttribute("label", "");
        destination.innerHTML = renderMarked(output);
        renderMath(destination);
        hljs.highlightAll();
        destination.classList.remove("generating");
        snapshotState();
    }

    async function embed(inputs, provider, params) {
        const { key, url } = getApiKeyAndUrl(provider);
        const payload = {
            input: inputs,
            ...params,
        };
        const response = await fetch(url + '/embeddings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`,
            },
            body: JSON.stringify(payload),
        });

        if (!response.ok) {
            throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const resObj = await response.json();
        const data = resObj.data;
        const embeddings = data
            .map(x => [x?.index || 0, x.embedding])
            .toSorted((a, b) => (a[0] > b[0]))
            .map(x => x[1]);
        if (typeof inputs == 'string')
            return embeddings[0];
        return embeddings;
    }

    function dot(v1, v2) {
        const L = v1.length;
        if (L !== v2.length) {
            throw new Error(`Cannot take dot product of vectors with differing lengths ${L} and ${v2.length}`);
        }
        let sum = 0, i = 0;
        while (i < L) {
            sum += v1[i] * v2[i];
            i++;
        }
        return sum;
    }

/**                EXA UTILITIES                **/

    async function findSimilarSites() {
        const exaKey = getId('exaKey')?.value;
        const input = query('.selected').getAttribute('content') || query('.selected').textContent;
        const urlMatch = input?.match(/https?:\/\/[^\s]+[a-zA-Z0-9\/]/);
        const numSites = parseInt(getId('numSitesFind')?.value);
        let corsProxy = getId('corsProxy')?.value;
        let destination = await getDestination();
        // make sure it ends with a '?'
        if (corsProxy && !corsProxy.endsWith('?')) {
            corsProxy += '?';
        }
        if (!exaKey) {
            destination.innerText = constants.text.enterAPIKey('Exa');
            destination.setAttribute('content', '');
            return;
        }

        if (!urlMatch) {
            destination.innerText = constants.text.errors.noURLFound;
            destination.setAttribute('content', '');
            return;
        }

        const url = urlMatch[0];
        try {
            const response = await fetch(`${corsProxy}https://api.exa.ai/findSimilar`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'x-api-key': exaKey
                },
                body: JSON.stringify({
                    url: url,
                    numResults: numSites,
                    excludeDomains: [new URL(url).hostname],
                    contents: {
                        text: true
                    }
                })
            });
            const data = await response.json();

            let output = '';
            data.results.forEach(result => {
                output += `URL: ${result.url}\n\nText: ${result.text.substring(0, 500)}...\n\n`;
            });

            destination.textContent = output;
            destination.setAttribute('content', output);
        } catch (error) {
            destination.textContent = constants.text.errors.generic(error.message);
        }
    }

    async function exaSearch() {
        const exaKey = getId('exaKey')?.value;
        const input = query('.selected').getAttribute('content') || query('.selected').textContent;
        const numResultsSearch = parseInt(getId('numSitesSearch')?.value);
        const numSentencesSearch = parseInt(getId('numSentencesSearch')?.value);
        const numHighlightsSearch = parseInt(getId('numHighlightsSearch')?.value);
        let corsProxy = getId('corsProxy')?.value;
        let destination = await getDestination();
        // make sure it ends with a '?'
        if (corsProxy && !corsProxy.endsWith('?')) {
            corsProxy += '?';
        }
        if (!exaKey) {
            destination.innerText = constants.text.enterAPIKey('Exa');
            destination.setAttribute('content', '');
            return;
        }

        try {
            const response = await fetch(`${corsProxy}https://api.exa.ai/search`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'x-api-key': exaKey
                },
                body: JSON.stringify({
                    query: input,
                    numResults: numResultsSearch,
                    useAutoprompt: false,
                    type: "neural",
                    contents: {
                        text: false,
                        summary: true,
                        highlights: {
                            numSentences: numSentencesSearch,
                            highlightsPerUrl: numHighlightsSearch
                        }
                    }
                })
            });
            const data = await response.json();
            let output = '';
            data.results.forEach(function(result) {
                const highlights = (result?.highlights ? "- " + result.highlights.join("\n - ") : "");
                output += `${result.title} (${result.url})\n\nSummary: ${result.summary}\n\nHighlights: ${highlights}\n\n`;
            });

            destination.textContent = output;
            destination.setAttribute('content', output);
        } catch (error) {
            destination.textContent = constants.text.errors.generic(error.message);
            destination.setAttribute('content', '');
        }
    }

/******************** TOKEN MANAGEMENT ********************/

    /**
    * Counts the number of tokens in the given content.
    * If a valid Jina key is provided and tokenization is allowed, the content is sent to the Jina API for tokenization.
    * Otherwise, a simple approximation is used to count the tokens.
    * @param {string} content - The content to be tokenized.
    * @returns {Promise<number|null>} - The total number of tokens, or null if an error occurs.
    */
    async function countTokens(content) {
        if (content.length == 0) {
            return 0;
        }
        let useJina = true;
        const jinaKey = getId('jinaKey')?.value;
        if (!jinaKey) {
            useJina = false;
        } else {
            useJina = getId("jinaAllowTokenize")?.checked;
        }
        document.body.classList.toggle('tokens-enabled', true);
        if(!useJina) {
            return Math.round(content.length / 4);
        }
        const maxChunkSize = 60000; // slightly less than 64k to be safe
        let totalTokens = 0;

        // split content into chunks
        let chunks = [];
        for (let i = 0; i < content.length; i += maxChunkSize) {
            chunks.push(content.slice(i, i + maxChunkSize));
        }

        for (const chunk of chunks) {
            // remove any problematic characters
            const sanitizedChunk = chunk.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');

            try {
                const response = await fetch('https://segment.jina.ai/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jinaKey}`
                    },
                    body: JSON.stringify({
                        content: sanitizedChunk,
                        tokenizer: "o200k_base"
                    })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(constants.text.errors.http(response.status, errorText));
                    throw new Error(constants.text.errors.http(response.status, errorText));
                }
                const data = await response.json();
                totalTokens += data.num_tokens;
            } catch (error) {
                console.error(constants.text.errors.tokenization(error));
                return null;
            }
        }
        return totalTokens;
    }

    function toggleTokenVisibility() {
        const jinaKey = getId('jinaKey')?.value;
        const hasValidKey = /^jina_[a-zA-Z0-9_]+$/.test(jinaKey);
        document.body.classList.toggle('tokens-enabled', hasValidKey);
        document.body.classList.toggle('tokens-disabled', !hasValidKey);
    }

    async function updateTokenCount(contentDiv, refresh = false, forceTo=null) {
        // if contentDiv argument is a message block, set contentDiv to the content div
        if (contentDiv.classList.contains("message-block")) {
            contentDiv = contentDiv.querySelector(".message-content");
        }
        let tokens, txt;
        if (!contentDiv.tokenCount || refresh || forceTo) {
            if (forceTo !== null) {
                tokens = parseInt(forceTo);
            } else {
                try {
                    txt = await substituteVariables(contentDiv.getAttribute('content') || buildText(contentDiv));
                } catch(error) {
                    console.log("Error substituting variables: ", error);
                    txt = contentDiv.getAttribute('content') || buildText(contentDiv);
                }
                tokens = await countTokens(txt);
            }
        } else {
            tokens = parseInt(contentDiv.tokenCount);
        }
        if (typeof tokens == typeof 1 && tokens > 0) {
            contentDiv.tokenCount = tokens;
            contentDiv.setAttribute("tokenCount", tokens);
            const tokenInfo = contentDiv.previousElementSibling.querySelector('.token-info');
            if (tokenInfo) {
                tokenInfo.textContent = tokens;
            }
        }
        updateTokenCost();
    }

    function updateChatTokenCost() {
        // sum up all valid token counts
        let total = 0;
        queryAll('.message-content:not(.disabled, [role="comment"])').forEach(contentDiv => {
            if (contentDiv.tokenCount)
                total += parseInt(contentDiv.tokenCount);
        });
        // set the total token count in the UI

        getId('totalTokens').innerHTML = constants.html.tokensValid(total);
        // calculate completion cost for given provider
        const key = getId('modelChat')?.value;
        const info = $models.chat[key];
        if (info) {
            const cCost = info.cost;
            const maxTRaw = getId('maxTokensChat')?.value;
            let maxT = parseInt(maxTRaw);
            if (maxTRaw.endsWith('%')) {
                const maxTPercent = parseInt(maxTRaw.slice(0, -1));
                const maxTMax = info.max.out;
                maxT = Math.round(maxTMax * maxTPercent / 100);
            } else if (maxTRaw == "auto" || maxTRaw == "" || maxTRaw == "max") {
                maxT = info.max.out;
            } else {
                maxT = parseInt(maxTRaw);
            }
            const maxIn = info.max.in;
            const maxOut = info.max.out >= 0 ? Math.min(maxT, info.max.out) : maxT;
            const tokMult = info?.tokMult ?? 1;
            getId('totalTokens').innerHTML += ` / ${maxIn}`;
            if (total > maxIn) {
                // context exceeded, make token count red
                getId('totalTokens').innerHTML = constants.html.tokensExceeded(total, maxIn);
            }
            const inCost = parseFloat(((total * cCost.in) / 1000000));
            const outCost = parseFloat(((maxOut * cCost.out) / 1000000));
            const sumCost = parseFloat(((total * cCost.in + maxOut * cCost.out) / 1000000));
            // compute arithmetic mean of all assistant token lengths, geometric mean of all token lengths
            let totProd = 1, totSum = 0, totCount = 0, astProd = 1, astSum = 0, astCount = 0;
            queryAll('.message-content:not(.disabled, [role="comment"])').forEach(contentDiv => {
                let thisCount = contentDiv.getAttribute('tokenCount');
                let thisRole = contentDiv.getAttribute('role');
                if (thisCount && thisRole != 'comment') {
                    let t = parseInt(thisCount);
                    if (t >= 2) {
                        totProd *= t; totCount += 1; totSum += t;
                        if (thisRole == 'assistant' || thisRole == 'system') {
                            astProd *= t; astCount += 1; astSum += t;
                        }
                    }
                }
            });
            let astGeo = 1, astArt = 0, totGeo = 1, totArt = 0;
            if (astCount != 0) {
                astGeo = Math.pow(astProd, 1 / astCount);
                astArt = astSum / astCount;
            }
            if (totCount != 0) {
                totGeo = Math.pow(totProd, 1 / totCount);
                totArt = totSum / totCount;
            }
            // set the total cost in the UI
            const outTokEstimate = Math.min(parseInt(1 + tokMult * Math.max(astArt, totGeo)), (maxOut > 0 ? maxOut : maxIn));
            const estCost = parseFloat(((outTokEstimate * cCost.out + total * cCost.in) / 1000000));
            const textMaxCost = parseInt(getId('maxTokensText')?.value);
            getId('completionCost').innerHTML = constants.html.chatCost(inCost, estCost, maxOut, cCost, sumCost);
        }
    }

    function updateTextTokenCost() {
        const key = getId('modelText')?.value;
        const info = $models.text[key];
        if (info) {
            const tCost = info.cost;
            const cell = query('.selected');
            const tokens = cell ? parseInt(cell.getAttribute('tokenCount')) || 0 : 0;
            const inCost = parseFloat(((tokens * tCost.in) / 1000000));
            const maxTRaw = getId('maxTokensText')?.value;
            let maxT = parseInt(maxTRaw);
            if (maxTRaw.endsWith('%')) {
                const maxTPercent = parseInt(maxTRaw.slice(0, -1));
                const maxTMax = info.max.out;
                maxT = Math.round(maxTMax * maxTPercent / 100);
            } else if (maxTRaw == "auto" || maxTRaw == "" || maxTRaw == "max") {
                maxT = info.max.out;
            } else {
                maxT = parseInt(maxTRaw);
            }
            const outCost = parseFloat(((maxT * tCost.out) / 1000000));
            const sumCost = parseFloat(((tokens * tCost.in + maxT * tCost.out) / 1000000));
            getId('textCompletionCost').innerHTML = constants.html.textCost(inCost, sumCost);
        }
    }
    function updateModelDescriptions() {
        const chatModelKey = getId('modelChat')?.value;
        const textModelKey = getId('modelText')?.value;
        const c = $models.chat[chatModelKey];
        const t = $models.text[textModelKey];
        if (c) {
            getId('modelChatDescription').innerHTML = `${c.provider.split("_")[0]} ${chatModelKey}<br>${c?.long ? c.long+'<br>':''}Cost/MTok: $${c.cost.in} input, $${c.cost.out} output<br>Max Tokens: ${c.max.in} input, ${c.max.out} output`;
        }
        if (t) {
            getId('modelTextDescription').innerHTML = `${t.provider.split("_")[0]} ${textModelKey}<br>${t?.long ? t.long+'<br>':''}Cost/MTok: $${t.cost.in} input, $${t.cost.out} output<br>Max Tokens: ${t.max.in} input, ${t.max.out} output`;
        }
    }
    function updateTokenCost() {
        updateChatTokenCost();
        updateTextTokenCost();
        updateModelDescriptions();
        $inputs.checkAvailability();
    }

/**            VARIABLE HANDLING           **/

    function addVariable() {
        const variableBlock = document.createElement('div');
        const variable = {enabled: true, local: true, key: "", value: ""};
        variableBlock.className = `variable-block ${variable.local ? 'local' : 'global'} ${variable.enabled ? '' : 'inactive'}`;
        variableBlock.style.flexDirection = 'column';
        variableBlock.innerHTML = constants.html.variableBlock(variable);
        getId('variables-list').appendChild(variableBlock);
        snapshotState();
    }

    function toggleVariable(button) {
        const variableBlock = button.closest('.variable-block');
        variableBlock.classList.toggle('inactive');
        button.textContent = variableBlock.classList.contains('inactive') ? constants.text.variables.inactive : constants.text.variables.active;
        saveGlobalVariables();
        snapshotState();
    }

    function toggleVariableScope(button) {
        const variableBlock = button.closest('.variable-block');
        if (variableBlock.classList.contains('global')) {
            variableBlock.classList.remove('global');
            variableBlock.classList.add('local');
            button.textContent = constants.text.variables.local;
        } else {
            variableBlock.classList.remove('local');
            variableBlock.classList.add('global');
            button.textContent = constants.text.variables.global;
        }
        saveGlobalVariables();
        snapshotState();
    }

    function deleteVariable(button) {
        const variableBlock = button.closest('.variable-block');
        variableBlock.remove();
        saveGlobalVariables();
        snapshotState();
    }

    function saveGlobalVariables() {
        const globalVariables = Array.from(queryAll('.variable-block.global')).map(block => ({
            key: block.querySelector('.variable-input').value,
            value: block.querySelector('.variable-value').value,
            enabled: !block.classList.contains('inactive'),
            local: false
        }));
        setLocal('globalVariables', JSON.stringify(globalVariables));
        snapshotState(); // Update the snapshot after saving global variables
    }

    function loadGlobalVariables() {
        const globalVariables = JSON.parse(getLocal('globalVariables') || '[]');
        globalVariables.forEach(variable => {
            const variableBlock = document.createElement('div');
            variableBlock.className = `variable-block global ${variable.enabled ? '' : 'inactive'}`;
            variableBlock.style.flexDirection = 'column';
            variableBlock.innerHTML = constants.html.variableBlock(variable);
            getId('variables-list').appendChild(variableBlock);
        });
    }

    function getActiveVariables() {
        return Array.from(getId('variables-list')?.children || [])
            .filter(block => !block.classList.contains('inactive'))
            .map(block => {
                const inputs = Array.from(block.querySelectorAll('input'));
                return [inputs[0].value, inputs[1].value];
            });
    }

/**            FETCH HANDLING           **/

    async function getHtml(url) {
        // First, check for problematic URLs
        const urlLower = url.toLowerCase();

        // Block PDFs and other large binary files (should probably replace this with a read + submit as base64 file op)
        if (urlLower.endsWith('.pdf') ||
            urlLower.includes('/pdf/') ||
            urlLower.match(/\.(zip|exe|doc|docx|ppt|pptx)$/)) {
            throw new Error(constants.text.errors.noBinary);
        }

        // Check file size before downloading (if possible)
        try {
            const headResponse = await fetch(url, { method: 'HEAD' });
            const contentLength = headResponse.headers.get('content-length');
            if (contentLength && parseInt(contentLength) > 1000000) { // 1MB limit
                throw new Error(constants.text.errors.fileTooLarge(contentLength));
            }
        } catch (e) {
            console.log("Couldn't check file size:", e);
        }
        try {
            let response = await fetch(url);
            if (response.ok)
                return await response.text();

            // If request fails for non-CORS reason, throw that reason
            if (response.status !== 0)
                throw new Error(constants.text.errors.fetchFail(response.statusText));
        } catch (error) {
            // Possibly the request failed due to CORS. Check if there's a valid corsProxy setting
            const corsProxy = getId("corsProxy")?.value;
            if (!corsProxy)
                throw new Error(constants.text.errors.corsError(url));

            // Attempt 2
            const proxyUrl = corsProxy.endsWith('?') ? corsProxy : `${corsProxy}?`;
            try {
                const proxiedResponse = await fetch(proxyUrl + encodeURIComponent(url));
                if (proxiedResponse.ok)
                    return await proxiedResponse.text();
            } catch (proxiedError) {
                // If the proxied request fails, throw an error
                throw new Error(constants.text.errors.corsDoubleError(url, proxiedResponse.statusText));
            }
        }
    }

    fetch = async (site, params, useCorsProxy = null) => {
        try {
            return await fetch_builtin(site, params);
        } catch (e) {
            if (e.name !== 'TypeError' || !(useCorsProxy?.trim())) throw e;
        }
        // If we reach here, it means a CORS error might be present and a valid CORS proxy is set
        const corsProxy = useCorsProxy?.trim() || "";
        const proxyUrl = corsProxy.endsWith('?') ? corsProxy : `${corsProxy}?`;
        try {
            return await fetch_builtin(proxyUrl + site, params);
        } catch (e) {
            throw new Error(constants.text.errors.corsFetchFail(site, proxyUrl, e.message));
        }
    };

    async function fetchWithJina(url) {
        const jinaKey = getId("jinaKey")?.value;
        const corsProxy = getId("corsProxy")?.value;
        if (!jinaKey) {
            throw new Error(constants.text.errors.jinaApiKey);
        }
        try {
            const jinaOptions = {
                method: 'GET',
                headers: {
                    "Authorization": `Bearer ${jinaKey}`
                },
            };
            const jinaResponse = await fetch(
                `https://r.jina.ai/${url}`,
                jinaOptions,
                getId("corsProxy")?.value
            );
            if (jinaResponse.ok) {
                return await jinaResponse.text();
            } else {
                throw new Error(constants.text.errors.jinaServer(jinaResponse.statusText));
            }
        } catch (error) {
            throw new Error(constants.text.errors.jinaClient(error.message));
        }
    }

    async function fetchWithExa(url) {
        const exaKey = getId("exaKey")?.value;
        if (!exaKey) {
            throw new Error(constants.text.errors.exaApiKey);
        }
        try {
            const exaHeaders = {
                "accept": "application/json",
                "content-type": "application/json",
                "x-api-key": exaKey
            };
            const exaBody = JSON.stringify({
                ids: [url],
                text: {
                    maxCharacters: constants.internal.maxHtmlLength,
                    includeHtmlTags: false,
                },
                livecrawl: "always"
            });
            const exaOptions = {
                method: 'POST',
                headers: exaHeaders,
                body: exaBody
            };
            const exaResponse = await fetch(
                'https://api.exa.ai/contents',
                exaOptions,
                getId("corsProxy")?.value
            );

            if (exaResponse.ok) {
                const json = await exaResponse.json();
                return json.results[0]?.text || '';
            }
            throw new Error(constants.text.errors.exaServer(exaResponse.statusText));
        } catch (error) {
            throw new Error(constants.text.errors.exaClient(error.message));
        }
    }

    async function getContents(url) {
        if (cache.has(url) && !getId("scrapeIgnoreCache")?.checked) {
            return cache.get(url);
        }
        const jinaOK = getId("scrapeAllowJina")?.checked && getId("jinaKey")?.value;
        const exaOK = getId("scrapeAllowExa")?.checked && getId("exaKey")?.value;
        const unforced = !getId("scrapeForceHTML")?.checked;
        let content;
        try {
            if(unforced && jinaOK)
                content = await fetchWithJina(url);
            else if (unforced && exaOK)
                content = await fetchWithExa(url);
            else
                content = await getHtml(url);
        } catch (error) {
            throw new Error(constants.text.errors.getContents(error.message));
        }
        const trimLength = constants.internal.maxHtmlLength;
        // trim content to max allowed length
        if (content.length > trimLength) {
            const originalLength = content.length;
            content = content.slice(0, trimLength);
            console.log(constants.text.errors.getContentsTrim(originalLength, trimLength));
        }
        cache.set(url, content);
        return content;
    }

//**            FORMATTING HANDLING            **/

    function buildText(element, substituted = false) {
        // memoize text building
        let memoKey;
        try {
            memoKey = element.getAttribute('content');
        } catch {
            memoKey = element?.textContent;
        }
        if (memoKey && textBuildCache.has(memoKey)) {
            return textBuildCache.get(memoKey);
        }

        let result = '';
        if (!element) return result;

        if (element.nodeType === Node.TEXT_NODE) {
            result = substituted ? '' : element.textContent;
        } else if (element.classList?.contains("message-block")) {
            result = buildText(element.querySelector(".message-content"));
        } else {
            const tag = element.tagName?.toLowerCase();
            if (tag && ['style', 'script', 'noscript', 'template'].includes(tag)) {
                result = '';
            } else {
                let whitespace = '';
                if (tag === 'br')
                    whitespace = '\n';
                else if (tag === 'p')
                    whitespace = '\n\n';
                else if (tag === 'div')
                    whitespace = '\n';

                result = whitespace + (element.getAttribute('content') || '');
                let substituteNext = element.hasAttribute('content');

                if (!element.classList?.contains('opaque')) {
                    result += Array.from(element.childNodes)
                        .map(child => buildText(child, substituteNext))
                        .join('');
                }
            }
        }

        if (memoKey) {
            textBuildCache.set(memoKey, result);
        }
        return result;
    }

/**            ONLOADS AND EVENTS            **/

    function toggleMarkdown(force = null) {
        const disabled = force ?? getId('disableMarkdown')?.checked;
        document.body.classList.toggle('markdown-disabled', disabled);
        // Re-render all messages if enabling markdown
        if (!disabled) {
            queryAll('.message-content').forEach(content => {
                const text = content.getAttribute('content') || buildText(content);
                content.innerHTML = marked.parse(text);
                renderMath(content);
            });
            hljs.highlightAll();
        }
    }

    function toggleSidebar(force = null) {
        const hidden = force ?? getId('hideSidebar')?.checked;
        if (hidden) {
            getId('left-column')?.classList.add('hidden');
            getId('middle-column')?.classList.add('full-width');
        } else {
            getId('left-column')?.classList.remove('hidden');
            getId('middle-column')?.classList.remove('full-width');
        }
        updateTokenCost();
    }

    function handleKeyboardShortcuts(e) {
        const selectedCell = query('.selected');
        if (!selectedCell) return;

        const shortcutKey = [
            e.ctrlKey && 'Ctrl',
            e.altKey && 'Alt',
            e.shiftKey && 'Shift',
            e.key
        ].filter(Boolean).join('+');

        const shortcut = MsgBlock.shortcuts[shortcutKey];
        if (shortcut) {
            e.preventDefault();
            shortcut(selectedCell);
        }
    }

    async function quickHash() {
        const scripts = Array.from(document.querySelectorAll("script"));
        const code = scripts.map(x => x.text).join("");
        const hash = Array.from(code)
            .map(c => c.charCodeAt())
            .reduce((a, b) => ((a << 5) + a) + b, 0); // Simple rolling hash
        const hexColor = Math.abs(hash).toString(16).padStart(6, '0').slice(0, 6);
        const output = document.getElementById('hashOutput');
        output.innerHTML = `<span style="color: #${hexColor};">${hexColor.toUpperCase()}</span>`;
        lastVersionHash = localStorage.getItem("versionHash");
        if (!lastVersionHash || hexColor != lastVersionHash) {
            document.getElementById('hashOutput').innerHTML += ` <span style="font-weight:600;color:red;"> (!)</span>`;
            localStorage.setItem("versionHash", hexColor);
        }
    }

/** Start doing things **/

    quickHash();

    marked.use({
        breaks: true,
        gfm: true,
        pedantic: false,
        silent: true
    });

    document.addEventListener('DOMContentLoaded', () => {
        // Set up UI elements immediately
        document.body.classList = [getLocal("themeChoice") || "theme-default"];
        queryAll('.section-header').forEach(header => {
            header.addEventListener('click', () => {
                header.parentElement.classList.toggle('collapsed');
            });
        });
        queryAll('.collapsible-section:not(.start-open)').forEach(section => {
            section.classList.add('collapsed');
        });
        // Start loading data immediately, don't wait for window load
        Promise.all([
            $inputs.loadAllApiKeys(),
            $inputs.loadAllOptions()
        ]).then(() => {
            // These synchronous operations can run after keys/inputs are loaded
            loadSavedStates();
            loadGlobalVariables();
            stateHistory = JSON.parse(getLocal('stateHistory')) || stateHistory || [];
        });
        // Add event listener for Jina.AI API key input
        getId('jinaKey')?.addEventListener('input', toggleTokenVisibility);

        // Initial check for token visibility
        toggleTokenVisibility();
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const snapshot = getLocal('snapshot') || 'null';
        const lastState = JSON.parse(snapshot);
        if (lastState?.data?.messages && lastState.data.messages.length > 0)
            await deserializeState(lastState);
        else if (!query('.messages'))
            await deserializeState(immutableConversations["Ex: Basic assistant"].state);
        snapshotState();

        toggleMarkdown(getLocal('disableMarkdown') === 'true');
        toggleSidebar(getLocal('hideSidebar') === 'true');
    });

    window.addEventListener('click', async function(event) {
        if (editMode && !event.target.classList.contains('editing'))
            await exitEditMode();
        inputNodes = ["DIV", "TEXTAREA", "INPUT"];
        if (!didLastSave) {
            didLastSave = !inputNodes.includes(event.target.nodeName);
            if (didLastSave)
                await saveStateToLocalStorage();
        }
    });

    document.addEventListener('keydown', handleKeyboardShortcuts);

    queryAll('.secret').forEach(secret => {
        secret.addEventListener('change', $inputs.saveAllApiKeys);
    });

    ["chat", "text"].forEach(type => {
        const typeId = type == "chat" ? "modelChat" : "modelText";
        const modelSelect = getId(typeId);
        modelSelect.innerText = '';
        // add all models for given type to appropriate dropdown
        Object.entries($models[type]).forEach(([key, model]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = model.short;
            modelSelect.appendChild(option);
        });

        // actually select the option corresponding to modelChat or modelText
        modelSelect.value = getLocal(typeId) || Object.keys($models[type])[0];
    });

</script>
</body>

</html>
